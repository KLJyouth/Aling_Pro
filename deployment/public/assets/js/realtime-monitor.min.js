class RealTimeMonitor { constructor() { this.isMonitoring = false; this.monitorInterval = null; this.errorCount = 0; this.lastErrors = []; this.statusHistory = []; } startMonitoring() { if (this.isMonitoring) { console.log('âš ï¸ ç›‘æ§å·²åœ¨è¿è¡Œä¸­'); return; } console.log('ğŸš€ å¼€å§‹å®æ—¶ç›‘æ§AlingAièŠå¤©ç³»ç»Ÿ...'); this.isMonitoring = true; this.setupErrorCapture(); this.monitorInterval = setInterval(() => { this.checkSystemStatus(); }, 2000); this.setupDOMObserver(); console.log('âœ… ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨'); } stopMonitoring() { if (!this.isMonitoring) return; this.isMonitoring = false; if (this.monitorInterval) { clearInterval(this.monitorInterval); } console.log('â¹ï¸ ç›‘æ§å·²åœæ­¢'); } setupErrorCapture() { const originalError = window.console.error; const originalWarn = window.console.warn; window.console.error = (...args) => { this.errorCount++; const errorMsg = args.join(' '); this.lastErrors.push({ type: 'error', message: errorMsg, timestamp: new Date().toISOString() }); if (this.lastErrors.length > 10) { this.lastErrors.shift(); } console.log(`%cğŸš¨ [ERROR #${this.errorCount}] ${errorMsg}`, 'color: red; font-weight: bold'); originalError.apply(console, args); }; window.console.warn = (...args) => { const warnMsg = args.join(' '); console.log(`%câš ï¸ [WARN] ${warnMsg}`, 'color: orange; font-weight: bold'); originalWarn.apply(console, args); }; window.addEventListener('error', (event) => { this.errorCount++; const errorInfo = { type: 'uncaught', message: event.message, filename: event.filename, lineno: event.lineno, colno: event.colno, timestamp: new Date().toISOString() }; this.lastErrors.push(errorInfo); console.log(`%cğŸ’¥ [UNCAUGHT ERROR] ${event.message} at ${event.filename}:${event.lineno}`, 'color: red; font-weight: bold; background: yellow'); }); } checkSystemStatus() { const status = { timestamp: new Date().toISOString(), chatContainer: !!document.getElementById('chatContainer'), messageInput: !!document.getElementById('messageInput'), sendButton: !!document.getElementById('sendButton'), messageCount: document.querySelectorAll('.message').length, hasGlobalChatCore: typeof window.ChatCore !== 'undefined', hasGlobalChatUI: typeof window.ChatUI !== 'undefined', hasGlobalChatAPI: typeof window.ChatAPI !== 'undefined', hasMessageProcessor: typeof window.MessageProcessor !== 'undefined', hasMessageRenderer: typeof window.MessageRenderer !== 'undefined', errorCount: this.errorCount, recentErrors: this.lastErrors.slice(-3) }; if (typeof window.MessageProcessor !== 'undefined') { status.processorMethods = { processUserMessage: typeof MessageProcessor.processUserMessage === 'function', processAssistantMessage: typeof MessageProcessor.processAssistantMessage === 'function', escapeHtml: typeof MessageProcessor.escapeHtml === 'function' }; } this.statusHistory.push(status); if (this.statusHistory.length > 20) { this.statusHistory.shift(); } this.reportStatusChanges(status); window.currentSystemStatus = status; } reportStatusChanges(currentStatus) { const previousStatus = this.statusHistory[this.statusHistory.length - 2]; if (!previousStatus) return; if (currentStatus.messageCount !== previousStatus.messageCount) { console.log(`%cğŸ“ æ¶ˆæ¯æ•°é‡å˜åŒ–: ${previousStatus.messageCount} â†’ ${currentStatus.messageCount}`, 'color: blue; font-weight: bold'); } if (currentStatus.errorCount > previousStatus.errorCount) { console.log(`%cğŸš¨ æ–°é”™è¯¯å‘ç”Ÿ! æ€»è®¡: ${currentStatus.errorCount}`, 'color: red; font-weight: bold'); if (currentStatus.recentErrors.length > 0) { const latestError = currentStatus.recentErrors[currentStatus.recentErrors.length - 1]; console.log(`%cæœ€æ–°é”™è¯¯: ${latestError.message}`, 'color: red'); } } const criticalComponents = ['chatContainer', 'hasGlobalChatCore', 'hasMessageProcessor']; for (const component of criticalComponents) { if (previousStatus[component] && !currentStatus[component]) { console.log(`%cğŸ”¥ å…³é”®ç»„ä»¶ä¸¢å¤±: ${component}`, 'color: red; font-weight: bold; background: yellow'); } else if (!previousStatus[component] && currentStatus[component]) { console.log(`%câœ… å…³é”®ç»„ä»¶æ¢å¤: ${component}`, 'color: green; font-weight: bold'); } } } setupDOMObserver() { const chatContainer = document.getElementById('chatContainer'); if (!chatContainer) { console.log('âš ï¸ chatContainerä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®DOMè§‚å¯Ÿå™¨'); return; } const observer = new MutationObserver((mutations) => { mutations.forEach((mutation) => { if (mutation.type === 'childList') { mutation.addedNodes.forEach((node) => { if (node.nodeType === Node.ELEMENT_NODE && node.classList?.contains('message')) { console.log(`%câ• æ–°æ¶ˆæ¯æ·»åŠ åˆ°DOM`, 'color: green'); this.validateNewMessage(node); } }); } }); }); observer.observe(chatContainer, { childList: true, subtree: true }); console.log('ğŸ‘ï¸ DOMè§‚å¯Ÿå™¨å·²è®¾ç½®'); } validateNewMessage(messageElement) { const checks = [ { name: 'æ¶ˆæ¯å†…å®¹', test: () => messageElement.textContent && messageElement.textContent.trim().length > 0 }, { name: 'æ¶ˆæ¯ç±»å‹ç±»', test: () => messageElement.classList.contains('user-message') || messageElement.classList.contains('assistant-message') }, { name: 'æ¶ˆæ¯ç»“æ„', test: () => messageElement.querySelector('.message-content') !== null } ]; let passed = 0; checks.forEach(check => { if (check.test()) { passed++; console.log(`%c âœ… ${check.name}`, 'color: green'); } else { console.log(`%c âŒ ${check.name}`, 'color: red'); } }); console.log(`%cæ¶ˆæ¯éªŒè¯: ${passed}/${checks.length} é€šè¿‡`, passed === checks.length ? 'color: green' : 'color: orange'); } generateStatusReport() { const currentStatus = this.statusHistory[this.statusHistory.length - 1]; if (!currentStatus) { console.log('âŒ æ— çŠ¶æ€æ•°æ®å¯æŠ¥å‘Š'); return; } console.log('\n' + '='.repeat(50)); console.log('ğŸ“Š AlingAi å®æ—¶çŠ¶æ€æŠ¥å‘Š'); console.log('='.repeat(50)); console.log(`ğŸ•’ å½“å‰æ—¶é—´: ${new Date().toLocaleString()}`); console.log(`ğŸ’¬ æ¶ˆæ¯æ•°é‡: ${currentStatus.messageCount}`); console.log(`ğŸš¨ é”™è¯¯è®¡æ•°: ${currentStatus.errorCount}`); console.log(`ğŸ”§ å…³é”®ç»„ä»¶çŠ¶æ€:`); console.log(` - ChatContainer: ${currentStatus.chatContainer ? 'âœ…' : 'âŒ'}`); console.log(` - MessageInput: ${currentStatus.messageInput ? 'âœ…' : 'âŒ'}`); console.log(` - SendButton: ${currentStatus.sendButton ? 'âœ…' : 'âŒ'}`); console.log(` - ChatCore: ${currentStatus.hasGlobalChatCore ? 'âœ…' : 'âŒ'}`); console.log(` - ChatUI: ${currentStatus.hasGlobalChatUI ? 'âœ…' : 'âŒ'}`); console.log(` - MessageProcessor: ${currentStatus.hasMessageProcessor ? 'âœ…' : 'âŒ'}`); if (currentStatus.processorMethods) { console.log(`ğŸ› ï¸ MessageProcessoræ–¹æ³•:`); Object.entries(currentStatus.processorMethods).forEach(([method, exists]) => { console.log(` - ${method}: ${exists ? 'âœ…' : 'âŒ'}`); }); } if (currentStatus.recentErrors.length > 0) { console.log(`\nğŸš¨ æœ€è¿‘é”™è¯¯:`); currentStatus.recentErrors.forEach((error, index) => { console.log(` ${index + 1}. [${error.type}] ${error.message}`); }); } console.log('='.repeat(50)); } async testMessageSending() { console.log('ğŸ§ª å¼€å§‹æ¶ˆæ¯å‘é€æµ‹è¯•...'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); if (!messageInput || !sendButton) { console.log('âŒ ç¼ºå°‘å¿…è¦çš„UIå…ƒç´ '); return false; } const testMessage = `æµ‹è¯•æ¶ˆæ¯ - ${new Date().toLocaleTimeString()}`; messageInput.value = testMessage; console.log(`ğŸ“ è¾“å…¥æµ‹è¯•æ¶ˆæ¯: ${testMessage}`); const beforeCount = document.querySelectorAll('.message').length; sendButton.click(); console.log('ğŸš€ ç‚¹å‡»å‘é€æŒ‰é’®'); await new Promise(resolve => setTimeout(resolve, 2000)); const afterCount = document.querySelectorAll('.message').length; const success = afterCount > beforeCount; console.log(`ğŸ“Š æ¶ˆæ¯æ•°é‡: ${beforeCount} â†’ ${afterCount}`); console.log(`${success ? 'âœ…' : 'âŒ'} æ¶ˆæ¯å‘é€æµ‹è¯•${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`); return success; } } window.realtimeMonitor = new RealTimeMonitor(); if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => { setTimeout(() => { window.realtimeMonitor.startMonitoring(); console.log('ğŸ’¡ æç¤º: ä½¿ç”¨ realtimeMonitor.generateStatusReport() æŸ¥çœ‹çŠ¶æ€æŠ¥å‘Š'); console.log('ğŸ’¡ æç¤º: ä½¿ç”¨ realtimeMonitor.testMessageSending() æµ‹è¯•æ¶ˆæ¯å‘é€'); }, 1000); }); } else { setTimeout(() => { window.realtimeMonitor.startMonitoring(); console.log('ğŸ’¡ æç¤º: ä½¿ç”¨ realtimeMonitor.generateStatusReport() æŸ¥çœ‹çŠ¶æ€æŠ¥å‘Š'); console.log('ğŸ’¡ æç¤º: ä½¿ç”¨ realtimeMonitor.testMessageSending() æµ‹è¯•æ¶ˆæ¯å‘é€'); }, 1000); }