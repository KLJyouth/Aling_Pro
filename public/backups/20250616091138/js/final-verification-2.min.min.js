console.log('🎯 AlingAi聊天功能最终验证脚本启动...');class ChatFunctionVerifier{constructor(){this.results={total: 0,passed: 0,failed: 0,tests: []};this.startTime=Date.now();}log(message,status='info'){const timestamp=new Date().toLocaleTimeString();const icons={info: 'ℹ️',success: '✅',error: '❌',warning: '⚠️'};console.log(`${icons[status]}[${timestamp}] ${message}`);}addTest(name,passed,details=''){this.results.total++;if(passed)this.results.passed++;else this.results.failed++;this.results.tests.push({name,passed,details,timestamp: Date.now()});this.log(`${name}${details ? `-${details}` : ''}`,passed ? 'success' : 'error');}async sleep(ms){return new Promise(resolve=> setTimeout(resolve,ms));}async verifyServerHealth(){this.log('检查服务器健康状态...');try{const response=await fetch('/health');const data=await response.json();this.addTest('服务器健康检查',response.ok && data.status==='healthy',`状态: ${data.status},数据库: ${data.database}`);}catch(error){this.addTest('服务器健康检查',false,error.message);}}async verifyAPIConnection(){this.log('测试聊天API连接...');try{const response=await fetch(API_ENDPOINTS.CHAT_DEEPSEEK,{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify({text: '这是API连接验证消息',temperature: 0.7,max_tokens: 100})});const data=await response.json();this.addTest('聊天API连接',response.ok && data.success,`响应长度: ${data.assistantText?.length || 0}字符`);return data;}catch(error){this.addTest('聊天API连接',false,error.message);return null;}}verifyDOMElements(){this.log('检查页面DOM元素...');const requiredElements={'messageInput': '消息输入框','sendButton': '发送按钮','chatMessages': '消息容器','guestModeButton': '访客模式按钮','recordButton': '录音按钮','settingsBtn': '设置按钮','historyBtn': '历史按钮','loginModal': '登录模态框'};Object.entries(requiredElements).forEach(([id,name])=>{const element=document.getElementById(id);this.addTest(`DOM元素: ${name}`,element !==null,id);});}verifyJavaScriptModules(){this.log('检查JavaScript模块加载...');const globalChecks={'ChatCore类': typeof ChatCore !=='undefined','ChatUI类': typeof ChatUI !=='undefined','ChatAPI类': typeof ChatAPI !=='undefined','chatInstance实例': typeof window.chatInstance !=='undefined' && window.chatInstance !==null,'manualTestHelper': typeof window.manualTestHelper !=='undefined'};Object.entries(globalChecks).forEach(([name,exists])=>{this.addTest(`JS模块: ${name}`,exists);});}async verifyGuestMode(){this.log('测试访客模式功能...');const guestButton=document.getElementById('guestModeButton');if(guestButton){guestButton.click();await this.sleep(500);const guestMode=localStorage.getItem('guestMode');this.addTest('访客模式激活',guestMode==='true');}else{this.addTest('访客模式激活',false,'按钮不存在');}}async verifyMessageSending(){this.log('测试消息发送功能...');const messageInput=document.getElementById('messageInput');const sendButton=document.getElementById('sendButton');const chatMessages=document.getElementById('chatMessages');if(!messageInput || !sendButton || !chatMessages){this.addTest('消息发送准备',false,'缺少必要元素');return;}const initialMessageCount=chatMessages.children.length;const testMessage=`验证测试消息 ${Date.now()}`;messageInput.value=testMessage;messageInput.dispatchEvent(new Event('input'));const buttonEnabled=!sendButton.disabled;this.addTest('发送按钮状态',buttonEnabled);if(buttonEnabled){sendButton.click();await this.sleep(2000);const finalMessageCount=chatMessages.children.length;this.addTest('消息添加到界面',finalMessageCount > initialMessageCount,`消息数量: ${initialMessageCount}→ ${finalMessageCount}`);}}generateReport(){const duration=Date.now()-this.startTime;const successRate=Math.round((this.results.passed/this.results.total)*100);console.log('\n'+'='.repeat(60));console.log('📊 AlingAi聊天功能验证报告');console.log('='.repeat(60));console.log(`⏱️ 测试时长: ${Math.round(duration/1000)}秒`);console.log(`📈 总测试数: ${this.results.total}`);console.log(`✅ 通过数量: ${this.results.passed}`);console.log(`❌ 失败数量: ${this.results.failed}`);console.log(`🎯 成功率: ${successRate}%`);console.log('\n📋 详细结果:');this.results.tests.forEach(test=>{console.log(` ${test.passed ? '✅' : '❌'}${test.name}${test.details ? `-${test.details}` : ''}`);});if(successRate >=90){console.log('\n✅ 聊天功能运行良好，可以正常使用！');}else if(successRate >=70){console.log('\n⚠️ 大部分功能正常，建议修复失败的测试项');}else{console.log('\n❌ 存在较多问题，需要进行全面检修');}window.verificationReport={...this.results,duration,successRate,timestamp: new Date().toISOString()};return this.results;}async runAllVerifications(){this.log('开始执行完整的聊天功能验证...','info');await this.verifyServerHealth();await this.verifyAPIConnection();this.verifyDOMElements();this.verifyJavaScriptModules();await this.verifyGuestMode();await this.verifyMessageSending();return this.generateReport();}}window.chatVerifier=new ChatFunctionVerifier();setTimeout(async()=>{console.log('🎬 开始AlingAi聊天功能验证...');const results=await window.chatVerifier.runAllVerifications();console.log('🏁 验证完成！结果已保存到 window.verificationReport');},3000);window.runManualVerification=()=>{const verifier=new ChatFunctionVerifier();return verifier.runAllVerifications();};console.log('💡 手动运行验证: window.runManualVerification()');