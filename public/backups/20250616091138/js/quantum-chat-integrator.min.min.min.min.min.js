class QuantumChatIntegrator{constructor(){this.wsConnection=null;this.quantumBallSystem=null;this.chatSystem=null;this.isConnected=false;this.reconnectAttempts=0;this.maxReconnectAttempts=5;this.reconnectInterval=3000;this.quantumSphereRef=null;this.isAuthenticated=false;this.currentAnimation=null;this.animationQueue=[];this.isAnimating=false;this.eventListeners=new Map();this.init();}setQuantumSphereReference(quantumSphereObjects){this.quantumSphereRef=quantumSphereObjects;console.log('ğŸ¯ é‡å­çƒç³»ç»Ÿå¼•ç”¨å·²è®¾ç½®',Object.keys(quantumSphereObjects));}async init(){console.log('ğŸŒŠ åˆå§‹åŒ–é‡å­çƒ-èŠå¤©é›†æˆç³»ç»Ÿ...');await this.waitForQuantumBallSystem();await this.initWebSocketConnection();this.setupChatEventListeners();this.setupPageEventListeners();console.log('âœ… é‡å­çƒ-èŠå¤©é›†æˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');}async waitForQuantumBallSystem(){return new Promise((resolve)=>{const checkQuantumSystem=()=>{const hasQuantumParticleSystem=window.quantumParticleSystem || document.getElementById('backgroundContainer')|| window.QuantumParticleSystem;const hasQuantumAnimationSystem=window.quantumAnimation || window.QuantumAnimationSystem;if(hasQuantumParticleSystem && hasQuantumAnimationSystem){this.quantumBallSystem=window.quantumParticleSystem || window.QuantumParticleSystem || this.createQuantumBallProxy();console.log('ğŸ¯ é‡å­çƒç³»ç»Ÿå’ŒåŠ¨ç”»ç³»ç»Ÿå·²å°±ç»ª');resolve();}else{console.log('â³ ç­‰å¾…é‡å­ç³»ç»Ÿåˆå§‹åŒ–...',{quantumParticleSystem: !!hasQuantumParticleSystem,quantumAnimationSystem: !!hasQuantumAnimationSystem});setTimeout(checkQuantumSystem,500);}};checkQuantumSystem();});}createQuantumBallProxy(){return{updateState:(state)=>{console.log('ğŸ“Š é‡å­çƒçŠ¶æ€æ›´æ–°:',state);this.triggerVisualFeedback(state);},triggerAnimation:(type,data)=>{console.log('ğŸ¬ è§¦å‘é‡å­çƒåŠ¨ç”»:',type,data);this.triggerChatEvent(type,data);}};}triggerVisualFeedback(state){console.log('ğŸ¨ åº”ç”¨è§†è§‰åé¦ˆ:',state);const container=document.getElementById('backgroundContainer');if(container && state.mode){container.className=`quantum-${state.mode}`;if(state.colors && state.colors.length > 0){this.applyColorAnimation(container,state.colors);}if(state.effects && state.effects.length > 0){this.applyEffectAnimation(container,state.effects);}}const quantumLoader=document.getElementById('quantumLoader');if(quantumLoader && state.visible){quantumLoader.style.display='flex';setTimeout(()=>{quantumLoader.style.display='none';},state.duration || 2000);}}async initWebSocketConnection(){try{const wsUrl=`ws: console.log('ğŸ”Œ è¿æ¥WebSocket:',wsUrl);this.wsConnection=new WebSocket(wsUrl);this.wsConnection.onopen=()=>{console.log('âœ… WebSocketè¿æ¥å·²å»ºç«‹');this.isConnected=true;this.reconnectAttempts=0;this.sendWebSocketMessage({type: 'quantumBallSync',action: 'init',data:{page: window.location.pathname,timestamp: new Date().toISOString()}});this.emit('connected');};this.wsConnection.onmessage=(event)=>{try{const data=JSON.parse(event.data);this.handleWebSocketMessage(data);}catch(error){console.error('âŒ WebSocketæ¶ˆæ¯è§£æå¤±è´¥:',error);}};this.wsConnection.onclose=()=>{console.log('ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­');this.isConnected=false;this.emit('disconnected');this.attemptReconnection();};this.wsConnection.onerror=(error)=>{console.error('âŒ WebSocketè¿æ¥é”™è¯¯:',error);this.emit('error',error);};}catch(error){console.error('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥:',error);this.emit('error',error);}}async attemptReconnection(){if(this.reconnectAttempts >=this.maxReconnectAttempts){console.error('âŒ WebSocketé‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™');return;}this.reconnectAttempts++;console.log(`ğŸ”„ å°è¯•é‡è¿WebSocket(${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);setTimeout(()=>{this.initWebSocketConnection();},this.reconnectInterval);}handleWebSocketMessage(data){console.log('ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯:',data);switch(data.type){case 'quantumBallAnimation': this.handleQuantumBallAnimation(data);break;case 'chatResponse': this.handleChatResponse(data);break;case 'systemNotification': this.handleSystemNotification(data);break;default: console.log('ğŸ¤· æœªçŸ¥æ¶ˆæ¯ç±»å‹:',data.type);}}handleQuantumBallAnimation(data){console.log('ğŸ­ å¤„ç†é‡å­çƒåŠ¨ç”»:',data);if(data.animation){this.addAnimationToQueue(data.eventType,data.animation,data.data);}this.emit('quantumBallAnimation',data);}handleChatResponse(data){console.log('ğŸ’¬ å¤„ç†èŠå¤©å“åº”:',data);this.triggerChatEvent('aiResponseReceived',data);this.emit('chatResponse',data);}handleSystemNotification(data){console.log('ğŸ“¢ ç³»ç»Ÿé€šçŸ¥:',data);this.emit('systemNotification',data);}emit(event,data){if(this.eventListeners.has(event)){this.eventListeners.get(event).forEach(callback=>{try{callback(data);}catch(error){console.error(`âŒ äº‹ä»¶ç›‘å¬å™¨æ‰§è¡Œå¤±è´¥(${event}):`,error);}});}}on(event,callback){if(!this.eventListeners.has(event)){this.eventListeners.set(event,[]);}this.eventListeners.get(event).push(callback);}off(event,callback){if(this.eventListeners.has(event)){const listeners=this.eventListeners.get(event);const index=listeners.indexOf(callback);if(index >-1){listeners.splice(index,1);}}}addAnimationToQueue(eventType,animation,chatData){this.animationQueue.push({type: eventType,animation: animation,data: chatData,timestamp: Date.now()});this.processAnimationQueue();this.emit('quantumBallAnimation',{eventType,animation,chatData});}async processAnimationQueue(){if(this.isAnimating || this.animationQueue.length===0){return;}this.isAnimating=true;while(this.animationQueue.length > 0){const animationItem=this.animationQueue.shift();await this.executeAnimation(animationItem);}this.isAnimating=false;}async executeAnimation(animationItem){const{type,animation,data}=animationItem;console.log(`ğŸ­ æ‰§è¡ŒåŠ¨ç”»: ${type}`,animation);try{if(this.quantumBallSystem && this.quantumBallSystem.triggerAnimation){this.quantumBallSystem.triggerAnimation(type,animation);}else{await this.executeAnimationFallback(type,animation);}if(animation.duration){await new Promise(resolve=> setTimeout(resolve,animation.duration));}}catch(error){console.error('âŒ æ‰§è¡ŒåŠ¨ç”»å¤±è´¥:',error);}}async executeAnimationFallback(type,animation){const container=document.getElementById('backgroundContainer');if(!container)return;const animationClass=`quantum-animation-${type}`;container.classList.add(animationClass);if(animation.colors){this.applyColorAnimation(container,animation.colors);}if(animation.effects){this.applyEffectAnimation(container,animation.effects);}setTimeout(()=>{container.classList.remove(animationClass);},animation.duration || 2000);}applyColorAnimation(container,colors){console.log('ğŸ¨ åº”ç”¨é¢œè‰²åŠ¨ç”»:',colors);const gradient=`linear-gradient(45deg,${colors.join(',')})`;container.style.background=gradient;setTimeout(()=>{container.style.background='';},3000);}applyEffectAnimation(container,effects){console.log('âœ¨ åº”ç”¨æ•ˆæœåŠ¨ç”»:',effects);effects.forEach(effect=>{container.classList.add(`effect-${effect}`);});setTimeout(()=>{effects.forEach(effect=>{container.classList.remove(`effect-${effect}`);});},2000);}setupChatEventListeners(){console.log('ğŸ“¡ è®¾ç½®èŠå¤©äº‹ä»¶ç›‘å¬å™¨...');document.addEventListener('chatMessageSent',(event)=>{this.handleChatMessageSent(event.detail);});document.addEventListener('chatResponseReceived',(event)=>{this.handleChatResponseReceived(event.detail);});document.addEventListener('chatError',(event)=>{this.handleChatError(event.detail);});if(window.chatInstance){this.integrateChatInstance(window.chatInstance);}document.addEventListener('chatInstanceCreated',(event)=>{this.integrateChatInstance(event.detail);});}integrateChatInstance(chatInstance){console.log('ğŸ”— é›†æˆèŠå¤©å®ä¾‹...');this.chatSystem=chatInstance;if(chatInstance.core && chatInstance.core.on){chatInstance.core.on('messageSent',(data)=>{this.triggerChatEvent('userMessageSent',data);});chatInstance.core.on('responseReceived',(data)=>{this.triggerChatEvent('aiResponseReceived',data);});chatInstance.core.on('error',(data)=>{this.triggerChatEvent('chatError',data);});}if(chatInstance.api && chatInstance.api.sendMessage){const originalSendMessage=chatInstance.api.sendMessage.bind(chatInstance.api);chatInstance.api.sendMessage=async(message,options={})=>{this.triggerChatEvent('userMessageSent',{message,options});try{this.triggerChatEvent('aiThinking',{message});const result=await originalSendMessage(message,options);this.triggerChatEvent('aiResponseReceived',{message,response: result,options});return result;}catch(error){this.triggerChatEvent('chatError',{message,error,options});throw error;}};}}handleChatMessageSent(data){console.log('ğŸ’¬ ç”¨æˆ·æ¶ˆæ¯å‘é€:',data);this.triggerChatEvent('userMessageSent',data);}handleChatResponseReceived(data){console.log('ğŸ¤– AIå“åº”æ¥æ”¶:',data);this.triggerChatEvent('aiResponseReceived',data);}handleChatError(data){console.log('âŒ èŠå¤©é”™è¯¯:',data);this.triggerChatEvent('chatError',data);}triggerChatEvent(eventType,data){console.log(`ğŸš€ è§¦å‘èŠå¤©äº‹ä»¶: ${eventType}`,data);if(this.quantumSphereRef){this.applyAnimationToQuantumSphere(eventType,data);}if(this.isConnected && this.wsConnection){this.sendWebSocketMessage({type: 'chatEvent',eventType: eventType,data: data,timestamp: new Date().toISOString()});}else{console.log('ğŸ¨ ä½¿ç”¨æœ¬åœ°åŠ¨ç”»æ•ˆæœ(WebSocketæœªè¿æ¥)');this.applyLocalAnimationEffect(eventType,data);}document.dispatchEvent(new CustomEvent('quantumChatEvent',{detail:{eventType,data}}));switch(eventType){case 'userMessageSent': this.triggerUserMessageAnimation(data);break;case 'aiThinking': this.triggerAIThinkingAnimation();break;case 'aiResponseReceived': this.triggerAIResponseAnimation(data);break;case 'chatError': this.triggerErrorAnimation(data);break;}if(this.wsConnection && this.wsConnection.readyState===WebSocket.OPEN){this.wsConnection.send(JSON.stringify({type: 'chat_event',eventType: eventType,data: data,timestamp: Date.now()}));}return true;}applyLocalAnimationEffect(eventType,data){console.log(`ğŸ¨ åº”ç”¨æœ¬åœ°åŠ¨ç”»æ•ˆæœ: ${eventType}`,data);const container=document.getElementById('backgroundContainer');if(container){container.classList.add(`quantum-${eventType}`);setTimeout(()=>{container.classList.remove(`quantum-${eventType}`);},2000);}}applyAnimationToQuantumSphere(eventType,data){console.log(`ğŸŒŸ åº”ç”¨é‡å­çƒåŠ¨ç”»: ${eventType}`,data);if(!this.quantumSphereRef)return;switch(eventType){case 'userMessageSent': this.applyUserMessageAnimation(this.quantumSphereRef,data);break;case 'aiThinking': this.applyAIThinkingAnimation(this.quantumSphereRef,data);break;case 'aiResponseReceived': this.applyAIResponseAnimation(this.quantumSphereRef,data);break;case 'chatError': this.applyErrorAnimation(this.quantumSphereRef,data);break;}}applyUserMessageAnimation(quantumSphere,data){console.log('ğŸ‘¤ åº”ç”¨ç”¨æˆ·æ¶ˆæ¯åŠ¨ç”»');}applyAIThinkingAnimation(waveForm,connectionLines){console.log('ğŸ¤” åº”ç”¨AIæ€è€ƒåŠ¨ç”»');}applyAIResponseAnimation(quantumSphere,lightBeams){console.log('ğŸ¤– åº”ç”¨AIå“åº”åŠ¨ç”»');}applyErrorAnimation(quantumSphere,particleCloud){console.log('âŒ åº”ç”¨é”™è¯¯åŠ¨ç”»');}setupPageEventListeners(){console.log('ğŸ”§ è®¾ç½®é¡µé¢äº‹ä»¶ç›‘å¬å™¨...');document.addEventListener('visibilitychange',()=>{if(document.hidden){this.triggerQuantumBallMode('sleep');}else{this.triggerQuantumBallMode('active');}});window.addEventListener('resize',()=>{this.triggerQuantumBallMode('resize');});}triggerQuantumBallMode(mode){console.log(`ğŸšï¸ åˆ‡æ¢é‡å­çƒæ¨¡å¼: ${mode}`);this.sendWebSocketMessage({type: 'quantumBallMode',mode: mode,timestamp: new Date().toISOString()});this.emit('quantumBallModeChange',{mode});}sendWebSocketMessage(message){if(this.wsConnection && this.wsConnection.readyState===WebSocket.OPEN){this.wsConnection.send(JSON.stringify(message));}else{console.warn('âš ï¸ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯:',message);}}triggerUserMessageAnimation(data){console.log('ğŸ‘¤ è§¦å‘ç”¨æˆ·æ¶ˆæ¯åŠ¨ç”»',data);const animation={type: 'userMessage',colors: ['#4CAF50','#81C784'],effects: ['pulse','glow'],duration: 1500};this.addAnimationToQueue('userMessageSent',animation,data);}triggerAIThinkingAnimation(){console.log('ğŸ¤” è§¦å‘AIæ€è€ƒåŠ¨ç”»');const animation={type: 'aiThinking',colors: ['#FF9800','#FFB74D'],effects: ['wave','shimmer'],duration: 2000};this.addAnimationToQueue('aiThinking',animation,{});}triggerAIResponseAnimation(data){console.log('ğŸ¤– è§¦å‘AIå“åº”åŠ¨ç”»',data);const animation={type: 'aiResponse',colors: ['#2196F3','#64B5F6'],effects: ['burst','sparkle'],duration: 1800};this.addAnimationToQueue('aiResponseReceived',animation,data);}triggerErrorAnimation(data){console.log('âŒ è§¦å‘é”™è¯¯åŠ¨ç”»',data);const animation={type: 'error',colors: ['#F44336','#EF5350'],effects: ['shake','fade'],duration: 1000};this.addAnimationToQueue('chatError',animation,data);}triggerQuantumAnimation(type,data={}){console.log(`ğŸŒ€ è§¦å‘é‡å­åŠ¨ç”»: ${type}`,data);const defaultAnimations={click:{colors: ['#9C27B0','#BA68C8'],effects: ['ripple','zoom'],duration: 1000},hover:{colors: ['#673AB7','#9575CD'],effects: ['glow'],duration: 500},idle:{colors: ['#3F51B5','#7986CB'],effects: ['breathe'],duration: 3000}};const animation={...defaultAnimations[type],...data};this.addAnimationToQueue(type,animation,data);}async checkAuthentication(){try{const response=await fetch('/api/v1/auth/check',{method: 'GET',headers:{'Content-Type': 'application/json','X-Requested-With': 'XMLHttpRequest'}});if(response.ok){const result=await response.json();this.isAuthenticated=result.success && result.data?.authenticated;return this.isAuthenticated;}}catch(error){console.warn('è®¤è¯æ£€æŸ¥å¤±è´¥:',error);}this.isAuthenticated=false;return false;}testIntegration(){console.log('ğŸ§ª å¼€å§‹æµ‹è¯•é‡å­çƒ-èŠå¤©é›†æˆ...');const testAnimations=[ 'userMessageSent','aiThinking','aiResponseReceived','chatError' ];testAnimations.forEach((animation,index)=>{setTimeout(()=>{this.triggerChatEvent(animation,{test: true,message: `æµ‹è¯•åŠ¨ç”»: ${animation}`,timestamp: new Date().toISOString()});},index*3000);});}getSystemStatus(){return{isConnected: this.isConnected,isAuthenticated: this.isAuthenticated,reconnectAttempts: this.reconnectAttempts,hasQuantumBallSystem: !!this.quantumBallSystem,hasChatSystem: !!this.chatSystem,animationQueueLength: this.animationQueue.length,isAnimating: this.isAnimating,currentPage: window.location.pathname};}async initialize(){console.log('ğŸš€ QuantumChatIntegrator å…¬å…±åˆå§‹åŒ–å¼€å§‹...');try{if(this.isConnected){console.log('âœ… QuantumChatIntegrator å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');return Promise.resolve();}await this.checkAuthentication();await this.init();console.log('âœ… QuantumChatIntegrator å…¬å…±åˆå§‹åŒ–å®Œæˆ');return Promise.resolve();}catch(error){console.error('âŒ QuantumChatIntegrator åˆå§‹åŒ–å¤±è´¥:',error);throw error;}}saveToLocalStorage(key,data){try{localStorage.setItem(key,JSON.stringify(data));console.log(`ğŸ’¾ æ•°æ®å·²ä¿å­˜åˆ°localStorage: ${key}`);}catch(error){console.warn('localStorageä¿å­˜å¤±è´¥:',error);}}loadFromLocalStorage(key){try{const data=localStorage.getItem(key);return data ? JSON.parse(data): null;}catch(error){console.warn('localStorageè¯»å–å¤±è´¥:',error);return null;}}removeFromLocalStorage(key){try{localStorage.removeItem(key);console.log(`ğŸ—‘ï¸ å·²ä»localStorageåˆ é™¤: ${key}`);}catch(error){console.warn('localStorageåˆ é™¤å¤±è´¥:',error);}}}let quantumChatIntegrator=null;document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{try{quantumChatIntegrator=new QuantumChatIntegrator();window.quantumChatIntegrator=quantumChatIntegrator;console.log('ğŸŒŠ é‡å­çƒ-èŠå¤©é›†æˆå™¨å·²å…¨å±€åˆå§‹åŒ–');document.dispatchEvent(new CustomEvent('quantumChatIntegratorReady',{detail: quantumChatIntegrator}));}catch(error){console.error('âŒ é‡å­çƒ-èŠå¤©é›†æˆå™¨åˆå§‹åŒ–å¤±è´¥:',error);}},1000);});if(typeof window !=='undefined'){window.initializeQuantumChatIntegrator=function(){if(window.quantumChatIntegrator){console.log('ğŸŒŠ é‡å­çƒ-èŠå¤©é›†æˆå™¨æ‰‹åŠ¨åˆå§‹åŒ–...');return window.quantumChatIntegrator;}else{console.warn('âš ï¸ é‡å­çƒ-èŠå¤©é›†æˆå™¨å°šæœªå°±ç»ªï¼Œè¯·ç¨åé‡è¯•');return null;}};}if(typeof module !=='undefined' && module.exports){module.exports=QuantumChatIntegrator;}if(typeof window !=='undefined'){window.QuantumChatIntegrator=QuantumChatIntegrator;}console.log('ğŸ“¦ é‡å­çƒ-èŠå¤©é›†æˆæ¨¡å—å·²åŠ è½½');