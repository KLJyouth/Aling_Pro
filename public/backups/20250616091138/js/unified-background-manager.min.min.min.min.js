class UnifiedBackgroundManager{constructor(){this.currentMode='minimalist';this.quantumEnabled=false;this.performanceMode=this.detectPerformanceLevel();this.backgroundSystems=new Map();this.init();}init(){console.log('🎨 初始化统一背景管理器...');this.performanceMode=this.detectPerformanceLevel();console.log(`📊 设备性能等级: ${this.performanceMode}`);this.initializeBackgroundSystems();this.setupEventListeners();this.applyBackgroundMode(this.currentMode);console.log('✅ 统一背景管理器初始化完成');}detectPerformanceLevel(){const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl')|| canvas.getContext('experimental-webgl');if(!gl)return 'low';const debugInfo=gl.getExtension('WEBGL_debug_renderer_info');const renderer=debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL): '';const memory=navigator.deviceMemory || 4;const cores=navigator.hardwareConcurrency || 4;if(memory >=8 && cores >=8)return 'high';if(memory >=4 && cores >=4)return 'medium';return 'low';}initializeBackgroundSystems(){if(window.MinimalistBackground){this.backgroundSystems.set('minimalist',window.MinimalistBackground);console.log('✅ 极简主义背景系统已注册');}if(window.quantumParticleSystem){this.backgroundSystems.set('quantum',window.quantumParticleSystem);console.log('✅ 量子粒子系统已注册');}if(window.quantumAnimation){this.backgroundSystems.set('quantumAnimation',window.quantumAnimation);console.log('✅ 量子动画系统已注册');}}setupEventListeners(){if('connection' in navigator){navigator.connection.addEventListener('change',()=>{this.handleConnectionChange();});}document.addEventListener('visibilitychange',()=>{this.handleVisibilityChange();});if(window.quantumChatIntegrator){window.quantumChatIntegrator.on('chatEvent',(data)=>{this.handleQuantumEvent(data);});}this.addBackgroundToggle();}addBackgroundToggle(){const toggleButton=document.createElement('button');toggleButton.id='backgroundModeToggle';toggleButton.innerHTML=` <i class="fas fa-palette"></i> <span>背景模式</span> `;toggleButton.className='fixed top-4 left-4 z-50 bg-white/10 backdrop-blur-md border border-white/20 rounded-lg px-3 py-2 text-white hover:bg-white/20 transition-all duration-300 text-sm';toggleButton.style.cssText=` display: flex;align-items: center;gap: 8px;font-size: 12px;`;toggleButton.addEventListener('click',()=>{this.toggleBackgroundMode();});document.body.appendChild(toggleButton);document.addEventListener('keydown',(e)=>{if(e.ctrlKey && e.key==='b'){e.preventDefault();this.toggleBackgroundMode();}});}toggleBackgroundMode(){const modes=['minimalist','quantum','hybrid'];const currentIndex=modes.indexOf(this.currentMode);const nextMode=modes[(currentIndex+1)% modes.length];this.setBackgroundMode(nextMode);this.showModeNotification(nextMode);}setBackgroundMode(mode){console.log(`🎨 切换背景模式: ${this.currentMode}→ ${mode}`);this.disableCurrentMode();this.currentMode=mode;this.applyBackgroundMode(mode);localStorage.setItem('backgroundMode',mode);}applyBackgroundMode(mode){const body=document.body;body.classList.remove('bg-minimalist','bg-quantum','bg-hybrid');switch(mode){case 'minimalist': this.enableMinimalistMode();body.classList.add('bg-minimalist');break;case 'quantum': if(this.performanceMode !=='low'){this.enableQuantumMode();body.classList.add('bg-quantum');}else{this.enableMinimalistMode();body.classList.add('bg-minimalist');console.warn('⚠️ 低性能设备，降级到极简模式');}break;case 'hybrid': this.enableHybridMode();body.classList.add('bg-hybrid');break;}}enableMinimalistMode(){console.log('🎨 启用极简主义背景模式');const minimalistBg=this.backgroundSystems.get('minimalist');if(minimalistBg && minimalistBg.enable){minimalistBg.enable();}this.disableQuantumSystems();}enableQuantumMode(){console.log('🌌 启用量子背景模式');const minimalistBg=this.backgroundSystems.get('minimalist');if(minimalistBg && minimalistBg.disable){minimalistBg.disable();}this.enableQuantumSystems();}enableHybridMode(){console.log('🔄 启用混合背景模式');const minimalistBg=this.backgroundSystems.get('minimalist');if(minimalistBg && minimalistBg.enable){minimalistBg.enable();minimalistBg.setIntensity(0.5);}const quantumSystem=this.backgroundSystems.get('quantum');if(quantumSystem && quantumSystem.enable){quantumSystem.enable();if(quantumSystem.setOpacity)quantumSystem.setOpacity(0.3);}}disableCurrentMode(){this.backgroundSystems.forEach((system,name)=>{if(system && system.disable){system.disable();}});}enableQuantumSystems(){const quantumSystem=this.backgroundSystems.get('quantum');if(quantumSystem){if(quantumSystem.enable)quantumSystem.enable();this.quantumEnabled=true;}const quantumAnimation=this.backgroundSystems.get('quantumAnimation');if(quantumAnimation && quantumAnimation.enable){quantumAnimation.enable();}}disableQuantumSystems(){const quantumSystem=this.backgroundSystems.get('quantum');if(quantumSystem && quantumSystem.disable){quantumSystem.disable();}const quantumAnimation=this.backgroundSystems.get('quantumAnimation');if(quantumAnimation && quantumAnimation.hide){quantumAnimation.hide();}this.quantumEnabled=false;}handleQuantumEvent(data){if(this.currentMode==='quantum' || this.currentMode==='hybrid'){if(window.quantumChatIntegrator){window.quantumChatIntegrator.triggerChatEvent(data.eventType,data);}}}handleConnectionChange(){const connection=navigator.connection;if(connection && connection.effectiveType){const slowConnection=['slow-2g','2g'].includes(connection.effectiveType);if(slowConnection && this.currentMode==='quantum'){console.log('📶 检测到慢速网络，切换到极简模式');this.setBackgroundMode('minimalist');}}}handleVisibilityChange(){if(document.hidden){this.pauseAnimations();}else{this.resumeAnimations();}}pauseAnimations(){this.backgroundSystems.forEach((system)=>{if(system && system.pause){system.pause();}});}resumeAnimations(){this.backgroundSystems.forEach((system)=>{if(system && system.resume){system.resume();}});}showModeNotification(mode){const modeNames={minimalist: '极简主义',quantum: '量子动画',hybrid: '混合模式'};const notification=document.createElement('div');notification.className='fixed top-20 left-4 z-50 bg-blue-600/90 backdrop-blur-md border border-blue-400/30 rounded-lg px-4 py-2 text-white text-sm';notification.innerHTML=`🎨 已切换到 ${modeNames[mode]}背景模式`;document.body.appendChild(notification);setTimeout(()=>{notification.style.opacity='0';setTimeout(()=> notification.remove(),300);},2000);}getCurrentMode(){return this.currentMode;}getPerformanceMode(){return this.performanceMode;}isQuantumEnabled(){return this.quantumEnabled;}getSystemStatus(){return{currentMode: this.currentMode,performanceMode: this.performanceMode,quantumEnabled: this.quantumEnabled,availableSystems: Array.from(this.backgroundSystems.keys()),memoryUsage: performance.memory ? Math.round(performance.memory.usedJSHeapSize/1024/1024): 'Unknown'};}}document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{if(!window.unifiedBackgroundManager){window.unifiedBackgroundManager=new UnifiedBackgroundManager();const savedMode=localStorage.getItem('backgroundMode');if(savedMode && ['minimalist','quantum','hybrid'].includes(savedMode)){window.unifiedBackgroundManager.setBackgroundMode(savedMode);}}},1000);});console.log('📦 统一背景管理器模块已加载');