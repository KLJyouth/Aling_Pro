class EnhancedAdminTestingSystem{constructor(){this.testResults={};this.diagnosticsData={};this.isRunning=false;this.systemHealth='unknown';this.testCategories={backend: 'åç«¯æœåŠ¡æ£€æµ‹',admin: 'ç®¡ç†ç³»ç»Ÿæ£€æµ‹',security: 'å®‰å…¨ç³»ç»Ÿæ£€æµ‹',performance: 'æ€§èƒ½ç›‘æ§æ£€æµ‹',database: 'æ•°æ®åº“ç³»ç»Ÿæ£€æµ‹',integrations: 'ç³»ç»Ÿé›†æˆæ£€æµ‹',monitoring: 'ç›‘æ§ç³»ç»Ÿæ£€æµ‹',backup: 'å¤‡ä»½ç³»ç»Ÿæ£€æµ‹'};this.init();}async init(){this.setupAdminUI();this.registerAdminTests();this.setupEventListeners();await this.loadAdminModules();this.startSystemMonitoring();this.log('âœ… å¢å¼ºç®¡ç†æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ','success');}setupAdminUI(){const adminTestContainer=document.getElementById('adminTestSystem');if(adminTestContainer){adminTestContainer.innerHTML=` <div class="admin-test-dashboard"> <div class="test-control-panel"> <h3><i class="bi bi-gear-fill"></i> ç³»ç»Ÿç®¡ç†æµ‹è¯•æ§åˆ¶å°</h3> <div class="control-buttons"> <button id="runComprehensiveTests" class="btn btn-primary"> <i class="bi bi-play-fill"></i> è¿è¡Œç»¼åˆæµ‹è¯• </button> <button id="runDiagnostics" class="btn btn-info"> <i class="bi bi-search"></i> ç³»ç»Ÿè¯Šæ–­ </button> <button id="runSecurityScan" class="btn btn-warning"> <i class="bi bi-shield-check"></i> å®‰å…¨æ‰«æ </button> <button id="runHealthCheck" class="btn btn-success"> <i class="bi bi-heart-pulse"></i> å¥åº·æ£€æŸ¥ </button> </div> </div> <div class="test-status-overview"> <div class="status-card" id="systemHealthCard"> <h4>ç³»ç»Ÿå¥åº·çŠ¶æ€</h4> <div class="health-indicator" id="healthIndicator"> <span class="status-dot unknown"></span> <span id="healthStatus">æ£€æŸ¥ä¸­...</span> </div> </div> <div class="status-card"> <h4>æµ‹è¯•ç»Ÿè®¡</h4> <div class="test-stats"> <div class="stat-item"> <span class="label">æ€»æµ‹è¯•æ•°:</span> <span id="totalTestsAdmin">0</span> </div> <div class="stat-item"> <span class="label">é€šè¿‡:</span> <span id="passedTestsAdmin" class="text-success">0</span> </div> <div class="stat-item"> <span class="label">å¤±è´¥:</span> <span id="failedTestsAdmin" class="text-danger">0</span> </div> <div class="stat-item"> <span class="label">è­¦å‘Š:</span> <span id="warningTestsAdmin" class="text-warning">0</span> </div> </div> </div> <div class="status-card"> <h4>ç³»ç»Ÿç›‘æ§</h4> <div class="monitoring-data" id="monitoringData"> <div class="metric"> <span>CPU:</span> <span id="cpuUsage">--%</span> </div> <div class="metric"> <span>å†…å­˜:</span> <span id="memoryUsage">--%</span> </div> <div class="metric"> <span>ç£ç›˜:</span> <span id="diskUsage">--%</span> </div> </div> </div> </div> <div class="test-results-container"> <div class="results-header"> <h4>æµ‹è¯•ç»“æœè¯¦æƒ…</h4> <div class="result-filters"> <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button> <button class="filter-btn" data-filter="passed">é€šè¿‡</button> <button class="filter-btn" data-filter="failed">å¤±è´¥</button> <button class="filter-btn" data-filter="warning">è­¦å‘Š</button> </div> </div> <div id="adminTestResults" class="test-results"></div> </div> <div class="diagnostics-panel" id="diagnosticsPanel"> <h4>ç³»ç»Ÿè¯Šæ–­ä¿¡æ¯</h4> <div id="diagnosticsContent"></div> </div> </div> `;}}registerAdminTests(){this.addTest('backend','æ•°æ®åº“è¿æ¥æµ‹è¯•',this.testDatabaseConnection);this.addTest('backend','APIæœåŠ¡æµ‹è¯•',this.testApiServices);this.addTest('backend','ç¼“å­˜ç³»ç»Ÿæµ‹è¯•',this.testCacheSystem);this.addTest('backend','é‚®ä»¶æœåŠ¡æµ‹è¯•',this.testEmailService);this.addTest('admin','ç®¡ç†å‘˜æƒé™æµ‹è¯•',this.testAdminPermissions);this.addTest('admin','ç”¨æˆ·ç®¡ç†åŠŸèƒ½',this.testUserManagement);this.addTest('admin','ç³»ç»Ÿé…ç½®æµ‹è¯•',this.testSystemConfiguration);this.addTest('admin','æ—¥å¿—ç³»ç»Ÿæµ‹è¯•',this.testLoggingSystem);this.addTest('security','è®¤è¯ç³»ç»Ÿæµ‹è¯•',this.testAuthentication);this.addTest('security','æˆæƒæ£€æŸ¥æµ‹è¯•',this.testAuthorization);this.addTest('security','å®‰å…¨å¤´æ£€æµ‹',this.testSecurityHeaders);this.addTest('security','æ–‡ä»¶æƒé™æ£€æŸ¥',this.testFilePermissions);this.addTest('performance','å“åº”æ—¶é—´æµ‹è¯•',this.testResponseTime);this.addTest('performance','å†…å­˜ä½¿ç”¨æµ‹è¯•',this.testMemoryUsage);this.addTest('performance','æŸ¥è¯¢æ€§èƒ½æµ‹è¯•',this.testQueryPerformance);this.addTest('performance','å¹¶å‘å¤„ç†æµ‹è¯•',this.testConcurrentHandling);this.addTest('database','è¿æ¥æ± æµ‹è¯•',this.testConnectionPool);this.addTest('database','äº‹åŠ¡å¤„ç†æµ‹è¯•',this.testTransactionHandling);this.addTest('database','æ•°æ®å®Œæ•´æ€§æ£€æŸ¥',this.testDataIntegrity);this.addTest('database','å¤‡ä»½ç³»ç»Ÿæµ‹è¯•',this.testBackupSystem);this.addTest('integrations','WebSocketè¿æ¥æµ‹è¯•',this.testWebSocketConnection);this.addTest('integrations','ç¬¬ä¸‰æ–¹APIé›†æˆ',this.testThirdPartyAPIs);this.addTest('integrations','æ”¯ä»˜ç³»ç»Ÿé›†æˆ',this.testPaymentIntegration);this.addTest('integrations','AIæœåŠ¡é›†æˆ',this.testAIServiceIntegration);this.addTest('monitoring','ç³»ç»Ÿç›‘æ§æœåŠ¡',this.testMonitoringService);this.addTest('monitoring','è­¦æŠ¥ç³»ç»Ÿæµ‹è¯•',this.testAlertSystem);this.addTest('monitoring','æ€§èƒ½æŒ‡æ ‡æ”¶é›†',this.testMetricsCollection);this.addTest('backup','æ•°æ®åº“å¤‡ä»½æµ‹è¯•',this.testDatabaseBackup);this.addTest('backup','æ–‡ä»¶å¤‡ä»½æµ‹è¯•',this.testFileBackup);this.addTest('backup','å¤‡ä»½æ¢å¤æµ‹è¯•',this.testBackupRestore);}addTest(category,name,testFunction){if(!this.testQueue)this.testQueue=[];this.testQueue.push({category,name,function: testFunction.bind(this),id: `${category}_${name.replace(/\s+/g,'_')}`});}async loadAdminModules(){const adminModules=[ '/api/unified-admin/dashboard','/api/unified-admin/diagnostics','/api/unified-admin/monitoring/current' ];for(const endpoint of adminModules){try{const response=await this.apiCall('GET',endpoint);if(response.success){this.log(`âœ… åŠ è½½ç®¡ç†æ¨¡å—: ${endpoint}`,'success');}else{this.log(`âš ï¸ ç®¡ç†æ¨¡å—åŠ è½½å¤±è´¥: ${endpoint}`,'warning');}}catch(error){this.log(`âŒ ç®¡ç†æ¨¡å—åŠ è½½é”™è¯¯: ${endpoint}-${error.message}`,'error');}}}setupEventListeners(){this.bindEvent('runComprehensiveTests',()=> this.runComprehensiveTests());this.bindEvent('runDiagnostics',()=> this.runSystemDiagnostics());this.bindEvent('runSecurityScan',()=> this.runSecurityScan());this.bindEvent('runHealthCheck',()=> this.runHealthCheck());document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{document.querySelectorAll('.filter-btn').forEach(b=> b.classList.remove('active'));e.target.classList.add('active');this.filterResults(e.target.dataset.filter);});});}bindEvent(elementId,handler){const element=document.getElementById(elementId);if(element){element.addEventListener('click',handler);}}async runComprehensiveTests(){this.log('ğŸš€ å¼€å§‹è¿è¡Œç»¼åˆç®¡ç†ç³»ç»Ÿæµ‹è¯•...','info');this.isRunning=true;this.updateButton('runComprehensiveTests','æµ‹è¯•ä¸­...',true);try{const response=await this.apiCall('POST','/api/unified-admin/tests/comprehensive');if(response.success){this.testResults=response.data;this.displayTestResults(response.data);this.updateTestStatistics(response.data);this.log('âœ… ç»¼åˆæµ‹è¯•å®Œæˆ','success');}else{throw new Error(response.error || 'æµ‹è¯•å¤±è´¥');}}catch(error){this.log(`âŒ ç»¼åˆæµ‹è¯•å¤±è´¥: ${error.message}`,'error');}finally{this.isRunning=false;this.updateButton('runComprehensiveTests','è¿è¡Œç»¼åˆæµ‹è¯•',false);}}async runSystemDiagnostics(){this.log('ğŸ” å¼€å§‹ç³»ç»Ÿè¯Šæ–­...','info');this.updateButton('runDiagnostics','è¯Šæ–­ä¸­...',true);try{const response=await this.apiCall('GET','/api/unified-admin/diagnostics');if(response.success){this.diagnosticsData=response.data;this.displayDiagnostics(response.data);this.log('âœ… ç³»ç»Ÿè¯Šæ–­å®Œæˆ','success');}else{throw new Error(response.error || 'è¯Šæ–­å¤±è´¥');}}catch(error){this.log(`âŒ ç³»ç»Ÿè¯Šæ–­å¤±è´¥: ${error.message}`,'error');}finally{this.updateButton('runDiagnostics','ç³»ç»Ÿè¯Šæ–­',false);}}async runSecurityScan(){this.log('ğŸ›¡ï¸ å¼€å§‹å®‰å…¨æ‰«æ...','info');this.updateButton('runSecurityScan','æ‰«æä¸­...',true);try{const response=await this.apiCall('POST','/api/unified-admin/security/scan');if(response.success){this.displaySecurityResults(response.data);this.log('âœ… å®‰å…¨æ‰«æå®Œæˆ','success');}else{throw new Error(response.error || 'å®‰å…¨æ‰«æå¤±è´¥');}}catch(error){this.log(`âŒ å®‰å…¨æ‰«æå¤±è´¥: ${error.message}`,'error');}finally{this.updateButton('runSecurityScan','å®‰å…¨æ‰«æ',false);}}async runHealthCheck(){this.log('ğŸ’“ å¼€å§‹å¥åº·æ£€æŸ¥...','info');this.updateButton('runHealthCheck','æ£€æŸ¥ä¸­...',true);try{const response=await this.apiCall('GET','/api/unified-admin/health');if(response.success){this.updateSystemHealth(response.data);this.log('âœ… å¥åº·æ£€æŸ¥å®Œæˆ','success');}else{throw new Error(response.error || 'å¥åº·æ£€æŸ¥å¤±è´¥');}}catch(error){this.log(`âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`,'error');}finally{this.updateButton('runHealthCheck','å¥åº·æ£€æŸ¥',false);}}async startSystemMonitoring(){setInterval(async()=>{try{const response=await this.apiCall('GET','/api/unified-admin/monitoring/current');if(response.success){this.updateMonitoringData(response.data);}}catch(error){}},30000);this.runHealthCheck();}displayTestResults(results){const container=document.getElementById('adminTestResults');if(!container)return;let html='';if(results.tests){Object.entries(results.tests).forEach(([testName,result])=>{const statusClass=result.status==='passed' ? 'success' : result.status==='failed' ? 'danger' : 'warning';html+=` <div class="test-result-item ${result.status}" data-status="${result.status}"> <div class="test-header"> <div class="test-name"> <i class="bi bi-${this.getStatusIcon(result.status)}"></i> <strong>${result.name || testName}</strong> </div> <span class="badge bg-${statusClass}">${result.status}</span> </div> <div class="test-details"> <p>${result.message}</p> ${result.execution_time ? `<small>æ‰§è¡Œæ—¶é—´: ${result.execution_time}</small>` : ''}${result.details ? this.formatTestDetails(result.details): ''}</div> </div> `;});}container.innerHTML=html || '<p class="text-muted">æš‚æ— æµ‹è¯•ç»“æœ</p>';}formatTestDetails(details){if(typeof details==='object'){let html='<div class="test-detail-list">';Object.entries(details).forEach(([key,value])=>{html+=`<div class="detail-item"><strong>${key}:</strong> ${value}</div>`;});html+='</div>';return html;}return `<div class="test-detail">${details}</div>`;}updateTestStatistics(results){if(results.summary){this.updateElement('totalTestsAdmin',results.summary.total);this.updateElement('passedTestsAdmin',results.summary.passed);this.updateElement('failedTestsAdmin',results.summary.failed);this.updateElement('warningTestsAdmin',results.summary.warnings || 0);}}displayDiagnostics(data){const container=document.getElementById('diagnosticsContent');if(!container)return;let html='<div class="diagnostics-sections">';Object.entries(data).forEach(([section,info])=>{html+=` <div class="diagnostic-section"> <h5>${this.formatSectionName(section)}</h5> <div class="diagnostic-content"> ${this.formatDiagnosticData(info)}</div> </div> `;});html+='</div>';container.innerHTML=html;}formatDiagnosticData(data){if(typeof data==='object' && data !==null){let html='<div class="diagnostic-items">';Object.entries(data).forEach(([key,value])=>{html+=` <div class="diagnostic-item"> <span class="key">${this.formatKey(key)}:</span> <span class="value">${this.formatValue(value)}</span> </div> `;});html+='</div>';return html;}return `<div class="diagnostic-value">${data}</div>`;}updateSystemHealth(healthData){const indicator=document.getElementById('healthIndicator');const status=document.getElementById('healthStatus');if(indicator && status){const overallStatus=healthData.overall_status || 'unknown';this.systemHealth=overallStatus;const dot=indicator.querySelector('.status-dot');dot.className=`status-dot ${overallStatus}`;const statusText={'healthy': 'ç³»ç»Ÿæ­£å¸¸','warning': 'éœ€è¦æ³¨æ„','critical': 'ä¸¥é‡é—®é¢˜','error': 'ç³»ç»Ÿé”™è¯¯','unknown': 'çŠ¶æ€æœªçŸ¥'};status.textContent=statusText[overallStatus] || overallStatus;}}updateMonitoringData(data){if(data.cpu && data.cpu.load_1min !==undefined){this.updateElement('cpuUsage',`${Math.round(data.cpu.load_1min*100)}%`);}if(data.memory && data.memory.php_memory){const usage=data.memory.php_memory;const percent=Math.round((usage.current/usage.peak)*100);this.updateElement('memoryUsage',`${percent}%`);}if(data.disk && data.disk.usage_percent !==undefined){this.updateElement('diskUsage',`${data.disk.usage_percent}%`);}}filterResults(filter){const results=document.querySelectorAll('.test-result-item');results.forEach(item=>{if(filter==='all' || item.dataset.status===filter){item.style.display='block';}else{item.style.display='none';}});}getStatusIcon(status){const icons={'passed': 'check-circle-fill','failed': 'x-circle-fill','warning': 'exclamation-triangle-fill','running': 'arrow-clockwise'};return icons[status] || 'question-circle';}formatSectionName(section){return section.replace(/_/g,' ').replace(/\b\w/g,l=> l.toUpperCase());}formatKey(key){return key.replace(/_/g,' ').replace(/\b\w/g,l=> l.toUpperCase());}formatValue(value){if(typeof value==='boolean'){return value ? 'âœ… æ˜¯' : 'âŒ å¦';}if(typeof value==='object'){return JSON.stringify(value);}return value;}updateElement(id,value){const element=document.getElementById(id);if(element){element.textContent=value;}}updateButton(id,text,disabled){const button=document.getElementById(id);if(button){button.textContent=text;button.disabled=disabled;}}async apiCall(method,endpoint,data=null){const options={method,headers:{'Content-Type': 'application/json','X-Requested-With': 'XMLHttpRequest'}};if(data){options.body=JSON.stringify(data);}const response=await fetch(endpoint,options);return await response.json();}log(message,type='info'){const timestamp=new Date().toLocaleTimeString();console.log(`[${timestamp}] ${message}`);const logArea=document.getElementById('adminTestLog');if(logArea){const logEntry=document.createElement('div');logEntry.className=`log-entry log-${type}`;logEntry.innerHTML=`<span class="timestamp">${timestamp}</span> ${message}`;logArea.appendChild(logEntry);logArea.scrollTop=logArea.scrollHeight;}}async testDatabaseConnection(){return await this.apiCall('GET','/api/public/health');}async testApiServices(){const endpoints=['/api/public/status','/api/public/version'];const results=[];for(const endpoint of endpoints){try{const response=await this.apiCall('GET',endpoint);results.push({endpoint,status: 'success',response});}catch(error){results.push({endpoint,status: 'error',error: error.message});}}return{results};}async testAdminPermissions(){try{const response=await this.apiCall('GET','/api/unified-admin/dashboard');return{status: response.success ? 'passed' : 'failed',message: response.success ? 'ç®¡ç†å‘˜æƒé™éªŒè¯æˆåŠŸ' : 'ç®¡ç†å‘˜æƒé™éªŒè¯å¤±è´¥'};}catch(error){return{status: 'failed',message: 'ç®¡ç†å‘˜æƒé™æµ‹è¯•å¤±è´¥: '+error.message};}}}document.addEventListener('DOMContentLoaded',function(){if(document.getElementById('adminTestSystem')){window.enhancedAdminTestingSystem=new EnhancedAdminTestingSystem();}});window.EnhancedAdminTestingSystem=EnhancedAdminTestingSystem;