class ZeroTrustAuth{constructor(){this.config={deviceFingerprintEnabled: true,behaviorAnalysisEnabled: true,multiFactorEnabled: true,riskBasedAuth: true,sessionMonitoring: true,maxFailedAttempts: 5,lockoutDuration: 30*60*1000,sessionTimeout: 24*60*60*1000,riskThreshold: 0.7};this.authFactors=new Map();this.securityMetrics={loginAttempts: 0,failedAttempts: 0,lastLoginTime: null,deviceChanges: 0,locationChanges: 0,behaviorScore: 1.0,riskScore: 0.0};this.deviceFingerprint=null;this.sessionData=null;this.behaviorPatterns=[];this.init();}async init(){console.log('ğŸ” åˆå§‹åŒ–é›¶ä¿¡ä»»è®¤è¯ç³»ç»Ÿ...');try{await this.generateDeviceFingerprint();this.loadSecurityMetrics();this.setupSessionMonitoring();this.setupBehaviorAnalysis();this.setupEventListeners();console.log('âœ… é›¶ä¿¡ä»»è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');}catch(error){console.error('âŒ é›¶ä¿¡ä»»è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:',error);}}setupEventListeners(){document.addEventListener('mousemove',(e)=> this.trackBehavior('mousemove',e));document.addEventListener('keydown',(e)=> this.trackBehavior('keydown',e));document.addEventListener('click',(e)=> this.trackBehavior('click',e));document.addEventListener('visibilitychange',()=>{this.trackBehavior('visibility',{hidden: document.hidden});});window.addEventListener('online',()=> this.trackBehavior('network',{online: true}));window.addEventListener('offline',()=> this.trackBehavior('network',{online: false}));}async generateDeviceFingerprint(){try{const fingerprint={userAgent: navigator.userAgent,language: navigator.language,platform: navigator.platform,cookieEnabled: navigator.cookieEnabled,timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,screen:{width: screen.width,height: screen.height,colorDepth: screen.colorDepth,pixelDepth: screen.pixelDepth},canvas: await this.generateCanvasFingerprint(),webgl: await this.generateWebGLFingerprint(),audio: await this.generateAudioFingerprint(),fonts: await this.getAvailableFonts(),plugins: this.getPluginInfo(),hardware: await this.getHardwareInfo(),timestamp: Date.now()};this.deviceFingerprint=await this.hashFingerprint(fingerprint);this.storeDeviceFingerprint(this.deviceFingerprint);console.log('ğŸ” è®¾å¤‡æŒ‡çº¹ç”Ÿæˆå®Œæˆ:',this.deviceFingerprint.substring(0,16)+'...');return this.deviceFingerprint;}catch(error){console.error('è®¾å¤‡æŒ‡çº¹ç”Ÿæˆå¤±è´¥:',error);this.deviceFingerprint='fallback_'+Date.now();return this.deviceFingerprint;}}async generateCanvasFingerprint(){try{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');canvas.width=200;canvas.height=50;ctx.textBaseline='top';ctx.font='14px Arial';ctx.textBaseline='alphabetic';ctx.fillStyle='#f60';ctx.fillRect(125,1,62,20);ctx.fillStyle='#069';ctx.fillText('AlingAi Zero Trust ğŸ”',2,15);ctx.fillStyle='rgba(102,204,0,0.7)';ctx.fillText('Security Fingerprint',4,35);return canvas.toDataURL();}catch(error){console.warn('CanvasæŒ‡çº¹ç”Ÿæˆå¤±è´¥:',error);return 'canvas_error';}}async generateWebGLFingerprint(){try{const canvas=document.createElement('canvas');const gl=canvas.getContext('webgl')|| canvas.getContext('experimental-webgl');if(!gl)return 'webgl_not_supported';const renderer=gl.getParameter(gl.RENDERER);const vendor=gl.getParameter(gl.VENDOR);const version=gl.getParameter(gl.VERSION);const shadingLanguageVersion=gl.getParameter(gl.SHADING_LANGUAGE_VERSION);return btoa(JSON.stringify({renderer,vendor,version,shadingLanguageVersion}));}catch(error){console.warn('WebGLæŒ‡çº¹ç”Ÿæˆå¤±è´¥:',error);return 'webgl_error';}}async generateAudioFingerprint(){return new Promise((resolve)=>{try{const context=new(window.AudioContext || window.webkitAudioContext)();const oscillator=context.createOscillator();const analyser=context.createAnalyser();const gainNode=context.createGain();const scriptProcessor=context.createScriptProcessor(4096,1,1);oscillator.type='triangle';oscillator.frequency.setValueAtTime(10000,context.currentTime);gainNode.gain.setValueAtTime(0,context.currentTime);oscillator.connect(analyser);analyser.connect(scriptProcessor);scriptProcessor.connect(gainNode);gainNode.connect(context.destination);scriptProcessor.onaudioprocess=function(bins){const data=new Float32Array(analyser.frequencyBinCount);analyser.getFloatFrequencyData(data);const fingerprint=Array.from(data.slice(0,50)).map(x=> Math.round(x*1000)).join(',');oscillator.disconnect();scriptProcessor.disconnect();context.close();resolve(btoa(fingerprint));};oscillator.start();setTimeout(()=>{resolve('audio_timeout');},1000);}catch(error){console.warn('éŸ³é¢‘æŒ‡çº¹ç”Ÿæˆå¤±è´¥:',error);resolve('audio_error');}});}async getAvailableFonts(){const testFonts=[ 'Arial','Helvetica','Times New Roman','Courier New','Verdana','Georgia','Palatino','Garamond','Bookman','Comic Sans MS','Trebuchet MS','Arial Black','Impact','Microsoft Sans Serif','Tahoma','Monaco','Courier','Lucida Console' ];const availableFonts=[];for(const font of testFonts){if(await this.isFontAvailable(font)){availableFonts.push(font);}}return availableFonts.join(',');}async isFontAvailable(fontName){const testString='mmmmmmmmmmlli';const testSize='72px';const baseFonts=['monospace','sans-serif','serif'];const canvas=document.createElement('canvas');const context=canvas.getContext('2d');for(const baseFont of baseFonts){context.font=`${testSize}${baseFont}`;const baseWidth=context.measureText(testString).width;context.font=`${testSize}${fontName},${baseFont}`;const testWidth=context.measureText(testString).width;if(baseWidth !==testWidth){return true;}}return false;}getPluginInfo(){const plugins=[];for(let i=0;i < navigator.plugins.length;i++){const plugin=navigator.plugins[i];plugins.push({name: plugin.name,description: plugin.description,filename: plugin.filename});}return JSON.stringify(plugins);}async getHardwareInfo(){const info={hardwareConcurrency: navigator.hardwareConcurrency || 0,deviceMemory: navigator.deviceMemory || 0,maxTouchPoints: navigator.maxTouchPoints || 0};if('getBattery' in navigator){try{const battery=await navigator.getBattery();info.battery={charging: battery.charging,level: Math.round(battery.level*100),chargingTime: battery.chargingTime,dischargingTime: battery.dischargingTime};}catch(error){info.battery='unavailable';}}return info;}async hashFingerprint(fingerprint){const encoder=new TextEncoder();const data=encoder.encode(JSON.stringify(fingerprint));const hashBuffer=await crypto.subtle.digest('SHA-256',data);const hashArray=Array.from(new Uint8Array(hashBuffer));return hashArray.map(b=> b.toString(16).padStart(2,'0')).join('');}storeDeviceFingerprint(fingerprint){try{localStorage.setItem('deviceFingerprint',fingerprint);localStorage.setItem('fingerprintTimestamp',Date.now().toString());}catch(error){console.warn('è®¾å¤‡æŒ‡çº¹å­˜å‚¨å¤±è´¥:',error);}}setupBehaviorAnalysis(){this.behaviorMetrics={mouseMovements: [],keystrokes: [],clicks: [],scrollEvents: [],typingPattern:{averageSpeed: 0,rhythm: [],pauses: []},sessionDuration: 0,activityLevel: 0};this.behaviorTimer=setInterval(()=>{this.analyzeBehavior();},30000);}trackBehavior(type,data){const timestamp=Date.now();switch(type){case 'mousemove': this.behaviorMetrics.mouseMovements.push({x: data.clientX,y: data.clientY,timestamp});if(this.behaviorMetrics.mouseMovements.length > 100){this.behaviorMetrics.mouseMovements.shift();}break;case 'keydown': this.behaviorMetrics.keystrokes.push({key: data.key,keyCode: data.keyCode,timestamp});if(this.behaviorMetrics.keystrokes.length > 50){this.behaviorMetrics.keystrokes.shift();}this.updateTypingPattern();break;case 'click': this.behaviorMetrics.clicks.push({x: data.clientX,y: data.clientY,button: data.button,timestamp});if(this.behaviorMetrics.clicks.length > 20){this.behaviorMetrics.clicks.shift();}break;case 'scroll': this.behaviorMetrics.scrollEvents.push({scrollX: window.scrollX,scrollY: window.scrollY,timestamp});if(this.behaviorMetrics.scrollEvents.length > 30){this.behaviorMetrics.scrollEvents.shift();}break;}this.behaviorPatterns.push({type,timestamp});if(this.behaviorPatterns.length > 200){this.behaviorPatterns.shift();}}updateTypingPattern(){const keystrokes=this.behaviorMetrics.keystrokes;if(keystrokes.length < 2)return;const intervals=[];for(let i=1;i < keystrokes.length;i++){intervals.push(keystrokes[i].timestamp-keystrokes[i-1].timestamp);}if(intervals.length > 0){const avgSpeed=intervals.reduce((a,b)=> a+b,0)/intervals.length;this.behaviorMetrics.typingPattern.averageSpeed=avgSpeed;this.behaviorMetrics.typingPattern.rhythm=intervals.slice(-10);}}analyzeBehavior(){const now=Date.now();const timeWindow=60000;const recentActivities=this.behaviorPatterns.filter(pattern=> now-pattern.timestamp < timeWindow);this.behaviorMetrics.activityLevel=recentActivities.length;this.calculateBehaviorScore();this.updateRiskScore();}calculateBehaviorScore(){let score=1.0;if(this.behaviorMetrics.activityLevel===0){score-=0.3;}else if(this.behaviorMetrics.activityLevel > 100){score-=0.2;}if(this.behaviorMetrics.mouseMovements.length > 10){const movements=this.behaviorMetrics.mouseMovements;const distances=[];for(let i=1;i < movements.length;i++){const dx=movements[i].x-movements[i-1].x;const dy=movements[i].y-movements[i-1].y;distances.push(Math.sqrt(dx*dx+dy*dy));}const avgDistance=distances.reduce((a,b)=> a+b,0)/distances.length;if(avgDistance < 5 || avgDistance > 200){score-=0.1;}}if(this.behaviorMetrics.typingPattern.averageSpeed > 0){const speed=this.behaviorMetrics.typingPattern.averageSpeed;if(speed < 50 || speed > 300){score-=0.1;}}this.securityMetrics.behaviorScore=Math.max(0,Math.min(1,score));}updateRiskScore(){let riskScore=0;if(this.securityMetrics.deviceChanges > 0){riskScore+=this.securityMetrics.deviceChanges*0.2;}if(this.securityMetrics.locationChanges > 2){riskScore+=(this.securityMetrics.locationChanges-2)*0.1;}if(this.securityMetrics.failedAttempts > 0){riskScore+=this.securityMetrics.failedAttempts*0.15;}if(this.securityMetrics.behaviorScore < 0.7){riskScore+=(0.7-this.securityMetrics.behaviorScore)*0.5;}const hour=new Date().getHours();if(hour < 6 || hour > 23){riskScore+=0.1;}this.securityMetrics.riskScore=Math.min(1,riskScore);console.log('ğŸ” é£é™©è¯„åˆ†æ›´æ–°:',{riskScore: this.securityMetrics.riskScore,behaviorScore: this.securityMetrics.behaviorScore,deviceChanges: this.securityMetrics.deviceChanges,failedAttempts: this.securityMetrics.failedAttempts});}async requestMFA(loginData){const riskScore=this.securityMetrics.riskScore;const isHighRisk=riskScore > this.config.riskThreshold;console.log('ğŸ” MFAè¯·æ±‚-é£é™©çº§åˆ«:',isHighRisk ? 'é«˜' : 'ä½','é£é™©åˆ†æ•°:',riskScore);if(!isHighRisk && this.isTrustedDevice()){return{required: false,factors: []};}const factors=[];if(riskScore > 0.8){factors.push('sms','email','totp');}else if(riskScore > 0.5){factors.push('email','totp');}else{factors.push('email');}return{required: true,factors,riskScore,challengeId: this.generateChallengeId()};}generateChallengeId(){return 'chg_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}async verifyMFAFactor(challengeId,factor,value){console.log('éªŒè¯MFAå› ç´ :',{challengeId,factor,value: value.substring(0,3)+'...'});return new Promise((resolve)=>{setTimeout(()=>{const isValid=value.length >=4;resolve({success: isValid,factor,challengeId});},1000);});}isTrustedDevice(){const storedFingerprint=localStorage.getItem('trustedDeviceFingerprint');const fingerprintTimestamp=localStorage.getItem('trustedDeviceTimestamp');if(!storedFingerprint || !fingerprintTimestamp){return false;}const trustExpiry=30*24*60*60*1000;if(Date.now()-parseInt(fingerprintTimestamp)> trustExpiry){this.removeTrustedDevice();return false;}return storedFingerprint===this.deviceFingerprint;}markDeviceAsTrusted(){try{localStorage.setItem('trustedDeviceFingerprint',this.deviceFingerprint);localStorage.setItem('trustedDeviceTimestamp',Date.now().toString());console.log('âœ… è®¾å¤‡å·²æ ‡è®°ä¸ºä¿¡ä»»');}catch(error){console.error('æ ‡è®°ä¿¡ä»»è®¾å¤‡å¤±è´¥:',error);}}removeTrustedDevice(){try{localStorage.removeItem('trustedDeviceFingerprint');localStorage.removeItem('trustedDeviceTimestamp');console.log('ğŸ—‘ï¸ ä¿¡ä»»è®¾å¤‡å·²ç§»é™¤');}catch(error){console.error('ç§»é™¤ä¿¡ä»»è®¾å¤‡å¤±è´¥:',error);}}setupSessionMonitoring(){this.sessionData={startTime: Date.now(),lastActivity: Date.now(),isActive: true,warnings: []};this.sessionMonitor=setInterval(()=>{this.checkSessionSecurity();},60000);const updateActivity=()=>{this.sessionData.lastActivity=Date.now();};document.addEventListener('mousemove',updateActivity);document.addEventListener('keydown',updateActivity);document.addEventListener('click',updateActivity);}checkSessionSecurity(){const now=Date.now();const inactiveTime=now-this.sessionData.lastActivity;if(inactiveTime > this.config.sessionTimeout){this.handleSessionTimeout();return;}if(this.deviceFingerprint !==localStorage.getItem('deviceFingerprint')){this.handleDeviceChange();return;}if(this.securityMetrics.riskScore > this.config.riskThreshold){this.handleHighRiskBehavior();}}handleSessionTimeout(){console.warn('âš ï¸ ä¼šè¯è¶…æ—¶');this.sessionData.warnings.push({type: 'timeout',timestamp: Date.now(),message: 'ä¼šè¯å› é•¿æ—¶é—´ä¸æ´»åŠ¨è€Œè¶…æ—¶'});this.triggerReAuthentication('session_timeout');}handleDeviceChange(){console.warn('âš ï¸ æ£€æµ‹åˆ°è®¾å¤‡å˜åŒ–');this.securityMetrics.deviceChanges++;this.sessionData.warnings.push({type: 'device_change',timestamp: Date.now(),message: 'æ£€æµ‹åˆ°è®¾å¤‡æŒ‡çº¹å˜åŒ–'});this.triggerReAuthentication('device_change');}handleHighRiskBehavior(){console.warn('âš ï¸ æ£€æµ‹åˆ°é«˜é£é™©è¡Œä¸º');this.sessionData.warnings.push({type: 'high_risk',timestamp: Date.now(),message: 'æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸ºæ¨¡å¼',riskScore: this.securityMetrics.riskScore});if(this.securityMetrics.riskScore > 0.9){this.triggerReAuthentication('high_risk');}}triggerReAuthentication(reason){console.log('ğŸ”„ è§¦å‘é‡æ–°è®¤è¯:',reason);window.dispatchEvent(new CustomEvent('zeroTrustReAuth',{detail:{reason,riskScore: this.securityMetrics.riskScore,timestamp: Date.now()}}));}loadSecurityMetrics(){try{const stored=localStorage.getItem('securityMetrics');if(stored){this.securityMetrics={...this.securityMetrics,...JSON.parse(stored)};}}catch(error){console.warn('åŠ è½½å®‰å…¨æŒ‡æ ‡å¤±è´¥:',error);}}saveSecurityMetrics(){try{localStorage.setItem('securityMetrics',JSON.stringify(this.securityMetrics));}catch(error){console.warn('ä¿å­˜å®‰å…¨æŒ‡æ ‡å¤±è´¥:',error);}}async authenticate(credentials){console.log('ğŸ” å¼€å§‹é›¶ä¿¡ä»»è®¤è¯æµç¨‹...');try{this.securityMetrics.loginAttempts++;if(this.isAccountLocked()){throw new Error('è´¦æˆ·å·²è¢«é”å®šï¼Œè¯·ç¨åå†è¯•');}if(!this.deviceFingerprint){await this.generateDeviceFingerprint();}const mfaRequirement=await this.requestMFA(credentials);const authRequest={...credentials,deviceFingerprint: this.deviceFingerprint,securityMetrics: this.securityMetrics,behaviorMetrics: this.behaviorMetrics,mfaRequired: mfaRequirement.required,riskScore: this.securityMetrics.riskScore,timestamp: Date.now()};return{authRequest,mfaRequirement,securityContext:{riskScore: this.securityMetrics.riskScore,deviceTrusted: this.isTrustedDevice(),behaviorScore: this.securityMetrics.behaviorScore}};}catch(error){this.securityMetrics.failedAttempts++;this.saveSecurityMetrics();throw error;}}isAccountLocked(){const now=Date.now();const lastFailedAttempt=this.securityMetrics.lastFailedAttempt || 0;if(this.securityMetrics.failedAttempts >=this.config.maxFailedAttempts){if(now-lastFailedAttempt < this.config.lockoutDuration){return true;}else{this.securityMetrics.failedAttempts=0;this.saveSecurityMetrics();}}return false;}onAuthSuccess(authResult){console.log('âœ… è®¤è¯æˆåŠŸ');this.securityMetrics.failedAttempts=0;this.securityMetrics.lastLoginTime=Date.now();if(authResult.trustDevice){this.markDeviceAsTrusted();}this.saveSecurityMetrics();this.sessionData.isActive=true;}onAuthFailure(error){console.error('âŒ è®¤è¯å¤±è´¥:',error);this.securityMetrics.failedAttempts++;this.securityMetrics.lastFailedAttempt=Date.now();this.updateRiskScore();this.saveSecurityMetrics();}generateSecurityReport(){return{timestamp: Date.now(),deviceFingerprint: this.deviceFingerprint?.substring(0,16)+'...',securityMetrics:{...this.securityMetrics},sessionData:{...this.sessionData},config:{...this.config},warnings: this.sessionData.warnings || [],recommendations: this.generateSecurityRecommendations()};}generateSecurityRecommendations(){const recommendations=[];if(this.securityMetrics.riskScore > 0.7){recommendations.push('å½“å‰é£é™©çº§åˆ«è¾ƒé«˜ï¼Œå»ºè®®å¯ç”¨é¢å¤–çš„å®‰å…¨éªŒè¯');}if(this.securityMetrics.failedAttempts > 2){recommendations.push('æ£€æµ‹åˆ°å¤šæ¬¡ç™»å½•å¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥è´¦æˆ·å®‰å…¨');}if(!this.isTrustedDevice()){recommendations.push('å½“å‰è®¾å¤‡æœªè¢«ä¿¡ä»»ï¼Œå»ºè®®å®Œæˆè®¾å¤‡éªŒè¯');}if(this.securityMetrics.behaviorScore < 0.6){recommendations.push('æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸ºæ¨¡å¼ï¼Œå»ºè®®è¿›è¡Œå®‰å…¨æ£€æŸ¥');}return recommendations;}destroy(){console.log('ğŸ§¹ æ¸…ç†é›¶ä¿¡ä»»è®¤è¯ç³»ç»Ÿ...');if(this.behaviorTimer){clearInterval(this.behaviorTimer);}if(this.sessionMonitor){clearInterval(this.sessionMonitor);}document.removeEventListener('mousemove',this.trackBehavior);document.removeEventListener('keydown',this.trackBehavior);document.removeEventListener('click',this.trackBehavior);this.saveSecurityMetrics();}}window.ZeroTrustAuth=ZeroTrustAuth;console.log('ğŸ” é›¶ä¿¡ä»»è®¤è¯ç³»ç»Ÿæ¨¡å—å·²åŠ è½½');