// å®Œæ•´çš„èŠå¤©åŠŸèƒ½ç«¯åˆ°ç«¯æµ‹è¯• async function runEndToEndChatTest() { console.log('ğŸš€ å¼€å§‹ç«¯åˆ°ç«¯èŠå¤©åŠŸèƒ½æµ‹è¯•...'); const results = { passed: 0, failed: 0, tests: [] }; function addTest(name, passed, details = '') { results.tests.push({ name, passed, details }); if (passed) results.passed++; else results.failed++; console.log(`${passed ? 'âœ…' : 'âŒ'} ${name} ${details ? `- ${details}` : ''}`); } try { // 1. æµ‹è¯•æœåŠ¡å™¨å¥åº·çŠ¶æ€ console.log('\nğŸ“Š 1. æœåŠ¡å™¨å¥åº·æ£€æŸ¥...'); try { const healthResponse = await fetch('/health'); const healthData = await healthResponse.json(); addTest('æœåŠ¡å™¨å¥åº·æ£€æŸ¥', healthResponse.ok && healthData.status === 'healthy', `æ•°æ®åº“: ${healthData.database}`); } catch (error) { addTest('æœåŠ¡å™¨å¥åº·æ£€æŸ¥', false, error.message); } // 2. æµ‹è¯•èŠå¤©APIè¿æ¥ console.log('\nğŸ’¬ 2. èŠå¤©APIè¿æ¥æµ‹è¯•...'); try { const chatResponse = await fetch('/api/chat/deepseek-chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: 'è¿™æ˜¯ä¸€ä¸ªAPIè¿æ¥æµ‹è¯•æ¶ˆæ¯', temperature: 0.7 }) }); const chatData = await chatResponse.json(); addTest('èŠå¤©APIè¿æ¥', chatResponse.ok && chatData.success, `å“åº”é•¿åº¦: ${chatData.assistantText?.length || 0}`); } catch (error) { addTest('èŠå¤©APIè¿æ¥', false, error.message); } // 3. æµ‹è¯•é¡µé¢å…ƒç´ å­˜åœ¨æ€§ console.log('\nğŸ¨ 3. é¡µé¢å…ƒç´ æ£€æŸ¥...'); const requiredElements = [ 'messageInput', 'sendButton', 'chatMessages', 'guestModeButton', 'recordButton', 'settingsBtn' ]; for (const elementId of requiredElements) { const element = document.getElementById(elementId); addTest(`å…ƒç´  ${elementId}`, element !== null, element ? 'å­˜åœ¨' : 'ç¼ºå¤±'); } // 4. æµ‹è¯•èŠå¤©æ¨¡å—åŠ è½½ console.log('\nğŸ“¦ 4. èŠå¤©æ¨¡å—åŠ è½½æ£€æŸ¥...'); const hasCore = typeof ChatCore !== 'undefined'; const hasUI = typeof ChatUI !== 'undefined'; const hasAPI = typeof ChatAPI !== 'undefined'; const hasInstance = typeof window.chatInstance !== 'undefined' && window.chatInstance !== null; addTest('ChatCoreæ¨¡å—', hasCore); addTest('ChatUIæ¨¡å—', hasUI); addTest('ChatAPIæ¨¡å—', hasAPI); addTest('chatInstanceå®ä¾‹', hasInstance); // 5. æµ‹è¯•è®¿å®¢æ¨¡å¼æ¿€æ´» console.log('\nğŸ‘¤ 5. è®¿å®¢æ¨¡å¼æµ‹è¯•...'); const guestButton = document.getElementById('guestModeButton'); if (guestButton) { guestButton.click(); await new Promise(resolve => setTimeout(resolve, 500)); const guestMode = localStorage.getItem('guestMode'); addTest('è®¿å®¢æ¨¡å¼æ¿€æ´»', guestMode === 'true'); } else { addTest('è®¿å®¢æ¨¡å¼æ¿€æ´»', false, 'æŒ‰é’®ä¸å­˜åœ¨'); } // 6. æµ‹è¯•æ¶ˆæ¯å‘é€åŠŸèƒ½ console.log('\nğŸ“ 6. æ¶ˆæ¯å‘é€æµ‹è¯•...'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); if (messageInput && sendButton) { const testMessage = 'è¿™æ˜¯ä¸€æ¡ç«¯åˆ°ç«¯æµ‹è¯•æ¶ˆæ¯ ' + Date.now(); messageInput.value = testMessage; messageInput.dispatchEvent(new Event('input')); // æ£€æŸ¥å‘é€æŒ‰é’®æ˜¯å¦å¯ç”¨ addTest('å‘é€æŒ‰é’®å¯ç”¨', !sendButton.disabled); // è®°å½•å‘é€å‰çš„æ¶ˆæ¯æ•°é‡ const chatMessages = document.getElementById('chatMessages'); const messageCountBefore = chatMessages.children.length; // ç‚¹å‡»å‘é€ sendButton.click(); // ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æ¶ˆæ¯å¤„ç† await new Promise(resolve => setTimeout(resolve, 2000)); const messageCountAfter = chatMessages.children.length; addTest('æ¶ˆæ¯æ·»åŠ åˆ°ç•Œé¢', messageCountAfter > messageCountBefore, `æ¶ˆæ¯æ•°é‡: ${messageCountBefore} â†’ ${messageCountAfter}`); } else { addTest('æ¶ˆæ¯å‘é€æµ‹è¯•', false, 'è¾“å…¥æ¡†æˆ–æŒ‰é’®ç¼ºå¤±'); } // 7. æµ‹è¯•å›è½¦é”®å‘é€ console.log('\nâŒ¨ï¸ 7. å›è½¦é”®å‘é€æµ‹è¯•...'); if (messageInput) { messageInput.value = 'å›è½¦é”®æµ‹è¯•æ¶ˆæ¯'; const enterEvent = new KeyboardEvent('keydown', { key: 'Enter', keyCode: 13, which: 13 }); messageInput.dispatchEvent(enterEvent); addTest('å›è½¦é”®å‘é€', true, 'äº‹ä»¶å·²è§¦å‘'); } else { addTest('å›è½¦é”®å‘é€', false, 'è¾“å…¥æ¡†ä¸å­˜åœ¨'); } // 8. æµ‹è¯•UIå“åº”æ€§ console.log('\nğŸ¯ 8. UIå“åº”æ€§æµ‹è¯•...'); const settingsBtn = document.getElementById('settingsBtn'); const historyBtn = document.getElementById('historyBtn'); addTest('è®¾ç½®æŒ‰é’®å“åº”', settingsBtn && settingsBtn.onclick !== null); addTest('å†å²æŒ‰é’®å“åº”', historyBtn && historyBtn.onclick !== null); } catch (error) { console.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error); addTest('æµ‹è¯•æ‰§è¡Œ', false, error.message); } // æ˜¾ç¤ºæµ‹è¯•ç»“æœæ‘˜è¦ console.log('\n' + '='.repeat(50)); console.log('ğŸ“Š ç«¯åˆ°ç«¯æµ‹è¯•ç»“æœæ‘˜è¦'); console.log('='.repeat(50)); console.log(`âœ… é€šè¿‡: ${results.passed} é¡¹`); console.log(`âŒ å¤±è´¥: ${results.failed} é¡¹`); console.log(`ğŸ“Š æˆåŠŸç‡: ${Math.round((results.passed / (results.passed + results.failed)) * 100)}%`); // è¯¦ç»†ç»“æœ console.log('\nğŸ“‹ è¯¦ç»†æµ‹è¯•ç»“æœ:'); results.tests.forEach(test => { console.log(`${test.passed ? 'âœ…' : 'âŒ'} ${test.name} ${test.details ? `- ${test.details}` : ''}`); }); // å¦‚æœæœ‰å¤±è´¥çš„æµ‹è¯•ï¼Œæ˜¾ç¤ºå»ºè®® if (results.failed > 0) { console.log('\nğŸ”§ ä¿®å¤å»ºè®®:'); results.tests.filter(t => !t.passed).forEach(test => { if (test.name.includes('æœåŠ¡å™¨')) { console.log('â€¢ æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ'); } else if (test.name.includes('API')) { console.log('â€¢ æ£€æŸ¥APIè·¯ç”±é…ç½®å’Œç½‘ç»œè¿æ¥'); } else if (test.name.includes('å…ƒç´ ')) { console.log('â€¢ æ£€æŸ¥HTMLæ¨¡æ¿å’ŒDOMç»“æ„'); } else if (test.name.includes('æ¨¡å—')) { console.log('â€¢ æ£€æŸ¥JavaScriptæ¨¡å—å¯¼å…¥å’Œåˆå§‹åŒ–'); } }); } return results; } // è‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼ˆå»¶è¿Ÿ3ç§’ç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½ï¼‰ setTimeout(() => { console.log('ğŸ å‡†å¤‡è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•...'); runEndToEndChatTest().then(results => { console.log('ğŸ‰ ç«¯åˆ°ç«¯æµ‹è¯•å®Œæˆï¼'); window.testResults = results; // ä¿å­˜ç»“æœä¾›åç»­æŸ¥çœ‹ }); }, 3000); 