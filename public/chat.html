<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlingAi Pro 智能对话 - 企业级AI聊天系统</title>
    <meta name="description" content="AlingAi Pro智能对话系统 - 支持多模态交互、实时语音、图像识别、文档分析的企业级AI助手">
    
    <!-- 核心资源 -->
    <link href="/assets/css/https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/css/https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/css/https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/assets/js/https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/three@0.132.0/build/three.min.js"></script>
    
    <!-- AI & WebSocket 支持 -->
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/core.min.js"></script>
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/languages/javascript.min.js"></script>
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/languages/python.min.js"></script>
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/languages/php.min.js"></script>
    <link href="/assets/css/https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css" rel="stylesheet">
    
    <!-- 自定义样式 -->
    <link href="/assets/css/assets/css/chat.css" rel="stylesheet">
    <link href="/assets/css/assets/css/quantum-chat-animations.css" rel="stylesheet">

    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'quantum-purple': '#6366f1',
                        'quantum-blue': '#3b82f6',
                        'quantum-cyan': '#06b6d4',
                        'quantum-green': '#10b981',
                        'electric-blue': '#0ea5e9',
                        'neon-pink': '#ec4899',
                        'deep-space': '#0f172a',
                        'glass-white': 'rgba(255, 255, 255, 0.1)',
                        'glass-dark': 'rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 2s ease-in-out infinite alternate',
                        'typing': 'typing 1.5s steps(3, end) infinite',
                        'gradient': 'gradient 15s ease infinite',
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* 全局样式增强 */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --message-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
        }
        
        /* 玻璃形态效果 */
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
        }
        
        /* 聊天容器增强 */
        .chat-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        /* 消息气泡增强 */
        .message-bubble {
            backdrop-filter: blur(16px);
            box-shadow: var(--message-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .message-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 输入区域增强 */
        .input-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* 动画效果 */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            from { box-shadow: 0 0 20px rgba(102, 126, 234, 0.4); }
            to { box-shadow: 0 0 40px rgba(102, 126, 234, 0.8); }
        }

        @keyframes typing {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* AI状态指示器 */
        .ai-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* 工具栏按钮 */
        .toolbar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            padding: 0.75rem;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .toolbar-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        /* 侧边栏样式 */
        .sidebar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(24px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-history-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .chat-history-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        /* 代码块样式 */
        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .code-header {
            background: rgba(0, 0, 0, 0.6);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 文件上传区域 */
        .file-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .file-drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* 快捷操作按钮 */
        .quick-action {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .quick-action:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-container {
                margin: 0.5rem;
                border-radius: 1rem;
            }
        }

        /* 打字效果 */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 200ms; }
        .typing-dot:nth-child(3) { animation-delay: 400ms; }

        /* 特殊消息类型样式 */
        .system-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .warning-message {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }
    </style>
</head>

<body>
    <!-- 背景粒子系统 -->
    <div id="quantum-particles" class="fixed inset-0 pointer-events-none z-0"></div>

    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg fixed-top glass-effect">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center text-white" href="/">
                <i class="fas fa-atom me-2 text-quantum-blue"></i>
                <span class="fw-bold">AlingAi Pro</span>
                <span class="badge bg-primary ms-2 small">Beta</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <!-- AI状态指示器 -->
                <div class="ai-status d-none d-md-flex">
                    <div class="status-dot"></div>
                    <span class="small text-white">AI在线</span>
                        </div>
                
                <!-- 工具栏 -->
                <div class="btn-group" role="group">
                    <button type="button" class="toolbar-btn" id="toggleSidebar" title="历史记录">
                        <i class="fas fa-history"></i>
                        </button>
                    <button type="button" class="toolbar-btn" id="toggleSettings" title="设置">
                            <i class="fas fa-cog"></i>
                        </button>
                    <button type="button" class="toolbar-btn" id="toggleFullscreen" title="全屏">
                        <i class="fas fa-expand"></i>
                    </button>
            </div>
            
                <!-- 用户菜单 -->
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i>
                        <span class="d-none d-md-inline">用户</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end glass-effect">
                        <li><a class="dropdown-item text-white" href="/dashboard.html"><i class="fas fa-tachometer-alt me-2"></i>控制台</a></li>
                        <li><a class="dropdown-item text-white" href="/profile.html"><i class="fas fa-user me-2"></i>个人资料</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-white" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                    </ul>
                    </div>
                            </div>
                            </div>
    </nav>

    <!-- 主容器 -->
    <div class="container-fluid pt-5 mt-3">
        <div class="row h-100">
            <!-- 侧边栏 -->
            <div class="col-md-3 col-lg-2 sidebar p-0" id="chatSidebar">
                <div class="p-3">
                    <h6 class="text-white mb-3">
                        <i class="fas fa-comments me-2"></i>聊天历史
                    </h6>
                    
                    <!-- 新建聊天按钮 -->
                    <button class="btn btn-primary w-100 mb-3" onclick="newChat()">
                        <i class="fas fa-plus me-2"></i>新建对话
                    </button>
                    
                    <!-- 聊天历史列表 -->
                    <div id="chatHistory" class="chat-history">
                        <!-- 聊天历史项将动态插入这里 -->
                            </div>
                            </div>
                            </div>

            <!-- 主聊天区域 -->
            <div class="col-md-9 col-lg-10 px-0">
                <div class="chat-container mx-3 mb-3 rounded-4 h-100 d-flex flex-column">
                    <!-- 聊天消息区域 -->
                    <div class="flex-grow-1 overflow-auto p-4" id="chatMessages">
                        <!-- 欢迎消息 -->
                        <div class="welcome-section text-center py-5" id="welcomeSection">
                            <div class="mb-4">
                                <i class="fas fa-robot fa-4x text-quantum-blue mb-3 animate-float"></i>
                                <h3 class="text-white mb-2">欢迎使用 AlingAi Pro</h3>
                                <p class="text-white-50">您的智能AI助手，支持多模态交互和企业级应用</p>
                            </div>
                            
                            <!-- 快捷操作 -->
                            <div class="row g-3 mt-4">
                                <div class="col-md-6 col-lg-3">
                                    <div class="quick-action" onclick="insertQuickMessage('帮我分析一下这个项目的架构')">
                                        <i class="fas fa-project-diagram text-quantum-blue mb-2"></i>
                                        <div class="small text-white">项目分析</div>
                        </div>
                    </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="quick-action" onclick="insertQuickMessage('生成一个Python爬虫代码')">
                                        <i class="fas fa-code text-quantum-green mb-2"></i>
                                        <div class="small text-white">代码生成</div>
                </div>
                    </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="quick-action" onclick="insertQuickMessage('帮我写一份技术文档')">
                                        <i class="fas fa-file-alt text-quantum-cyan mb-2"></i>
                                        <div class="small text-white">文档编写</div>
                    </div>
                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="quick-action" onclick="insertQuickMessage('解释一下机器学习的基本概念')">
                                        <i class="fas fa-brain text-neon-pink mb-2"></i>
                                        <div class="small text-white">知识问答</div>
                    </div>
                            </div>
                    </div>
                </div>
            </div>
            
            <!-- 输入区域 -->
                    <div class="input-container p-4 rounded-bottom-4">
                        <!-- 文件上传区域 -->
                        <div class="file-drop-zone p-3 mb-3 text-center d-none" id="fileDropZone">
                            <i class="fas fa-cloud-upload-alt fa-2x text-white-50 mb-2"></i>
                            <p class="text-white-50 mb-0">拖拽文件到这里上传，或点击选择文件</p>
                            <input type="file" id="fileInput" class="d-none" multiple accept=".txt,.md,.pdf,.doc,.docx,.jpg,.png,.gif">
                        </div>

                        <!-- 输入框和工具栏 -->
                        <div class="d-flex align-items-end gap-3">
                            <!-- 左侧工具按钮 -->
                            <div class="d-flex flex-column gap-2">
                                <button type="button" class="toolbar-btn" id="attachFile" title="附件">
                        <i class="fas fa-paperclip"></i>
                    </button>
                                <button type="button" class="toolbar-btn" id="voiceInput" title="语音输入">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                
                            <!-- 主输入区域 -->
                            <div class="flex-grow-1">
                                <div class="position-relative">
                                    <textarea 
                                        class="form-control input-field resize-none" 
                                        id="messageInput" 
                                        rows="1" 
                                        placeholder="输入您的消息... (Shift+Enter换行，Enter发送)"
                                        style="min-height: 50px; max-height: 150px;"
                                    ></textarea>
                                    
                                    <!-- 输入增强工具 -->
                                    <div class="position-absolute bottom-0 end-0 p-2">
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm text-white-50" id="formatText" title="格式化">
                                                <i class="fas fa-font"></i>
                        </button>
                                            <button type="button" class="btn btn-sm text-white-50" id="insertEmoji" title="表情">
                                                <i class="fas fa-smile"></i>
                        </button>
                    </div>
                    </div>
                </div>
                                
                                <!-- 输入提示 -->
                                <div class="small text-white-50 mt-1" id="inputHint">
                                    AI正在学习中...
            </div>
        </div>
        
                            <!-- 发送按钮 -->
                            <button type="button" class="btn btn-primary btn-lg px-4" id="sendMessage">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- 快捷命令提示 -->
                        <div class="mt-2 d-flex flex-wrap gap-2" id="quickCommands">
                            <span class="badge bg-secondary small">/help - 帮助</span>
                            <span class="badge bg-secondary small">/clear - 清空对话</span>
                            <span class="badge bg-secondary small">/export - 导出对话</span>
                        </div>
                        </div>
                </div>
            </div>
                    </div>
                </div>
                
    <!-- 设置面板 -->
    <div class="offcanvas offcanvas-end glass-effect" tabindex="-1" id="settingsPanel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title text-white">聊天设置</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
                        </div>
        <div class="offcanvas-body">
            <!-- AI模型选择 -->
            <div class="mb-4">
                <label class="form-label text-white">AI模型</label>
                <select class="form-select input-field" id="aiModel">
                    <option value="gpt-4">GPT-4 (推荐)</option>
                    <option value="gpt-3.5">GPT-3.5 Turbo</option>
                    <option value="claude">Claude 3</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
                        </div>

            <!-- 创造性设置 -->
            <div class="mb-4">
                <label class="form-label text-white">创造性 (Temperature)</label>
                <input type="range" class="form-range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                <div class="d-flex justify-content-between small text-white-50">
                    <span>保守</span>
                    <span id="temperatureValue">0.7</span>
                    <span>创新</span>
                    </div>
                </div>
                
            <!-- 最大回复长度 -->
            <div class="mb-4">
                <label class="form-label text-white">最大回复长度</label>
                <select class="form-select input-field" id="maxTokens">
                    <option value="512">短回复 (512)</option>
                    <option value="1024" selected>中等回复 (1024)</option>
                    <option value="2048">长回复 (2048)</option>
                    <option value="4096">超长回复 (4096)</option>
                </select>
                        </div>

            <!-- 功能开关 -->
            <div class="mb-4">
                <h6 class="text-white mb-3">功能设置</h6>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="enableVoice" checked>
                    <label class="form-check-label text-white" for="enableVoice">语音输入</label>
                        </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="enableFileUpload" checked>
                    <label class="form-check-label text-white" for="enableFileUpload">文件上传</label>
                    </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="enableCodeHighlight" checked>
                    <label class="form-check-label text-white" for="enableCodeHighlight">代码高亮</label>
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="enableAutoSave" checked>
                    <label class="form-check-label text-white" for="enableAutoSave">自动保存</label>
                </div>
            </div>
            
            <!-- 快捷键说明 -->
            <div class="mb-4">
                <h6 class="text-white mb-3">快捷键</h6>
                <div class="small text-white-50">
                    <div class="d-flex justify-content-between mb-1">
                        <span>发送消息</span>
                        <kbd class="bg-secondary">Enter</kbd>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>换行</span>
                        <kbd class="bg-secondary">Shift+Enter</kbd>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>清空输入</span>
                        <kbd class="bg-secondary">Ctrl+L</kbd>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>语音输入</span>
                        <kbd class="bg-secondary">Ctrl+M</kbd>
                    </div>
                </div>
            </div>
            
            <!-- 重置按钮 -->
            <button class="btn btn-outline-light w-100" onclick="resetSettings()">
                <i class="fas fa-undo me-2"></i>重置设置
                    </button>
        </div>
    </div>
    
    <!-- Toast通知容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <!-- JavaScript核心 -->
    <script src="/assets/js/https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 自定义脚本 -->
    <script>
        // 聊天系统核心类
        class EnhancedChatSystem {
            constructor() {
                this.currentChatId = null;
                this.messages = [];
                this.websocket = null;
                this.isTyping = false;
                this.settings = {
                    model: 'gpt-4',
                    temperature: 0.7,
                    maxTokens: 1024,
                    enableVoice: true,
                    enableFileUpload: true,
                    enableCodeHighlight: true,
                    enableAutoSave: true
                };
                this.init();
            }

            init() {
                console.log('🚀 初始化增强聊天系统...');
                this.setupEventListeners();
                this.setupWebSocket();
                this.loadChatHistory();
                this.setupQuantumBackground();
                this.loadSettings();
                this.setupAutoResize();
                this.setupShortcuts();
                console.log('✅ 聊天系统初始化完成');
            }

            setupEventListeners() {
                // 发送消息
                document.getElementById('sendMessage').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // 文件上传
                document.getElementById('attachFile').addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
                
                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files);
                });

                // 语音输入
                document.getElementById('voiceInput').addEventListener('click', () => {
                    this.toggleVoiceInput();
                });

                // 侧边栏切换
                document.getElementById('toggleSidebar').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                // 设置面板
                document.getElementById('toggleSettings').addEventListener('click', () => {
                    const offcanvas = new bootstrap.Offcanvas(document.getElementById('settingsPanel'));
                    offcanvas.show();
                });

                // 全屏切换
                document.getElementById('toggleFullscreen').addEventListener('click', () => {
                    this.toggleFullscreen();
                });

                // 温度滑块
                document.getElementById('temperature').addEventListener('input', (e) => {
                    document.getElementById('temperatureValue').textContent = e.target.value;
                    this.settings.temperature = parseFloat(e.target.value);
                    this.saveSettings();
                });

                // 文件拖拽
                this.setupFileDragDrop();
            }

            setupWebSocket() {
                try {
                    this.websocket = new WebSocket('ws://localhost:8081/chat');
                    
                    this.websocket.onopen = () => {
                        console.log('🔗 WebSocket连接已建立');
                        this.updateConnectionStatus(true);
                    };
                    
                    this.websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };
                    
                    this.websocket.onclose = () => {
                        console.log('🔌 WebSocket连接已断开');
                        this.updateConnectionStatus(false);
                        // 自动重连
                        setTimeout(() => this.setupWebSocket(), 5000);
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('❌ WebSocket错误:', error);
                        this.updateConnectionStatus(false);
                    };
                } catch (error) {
                    console.error('❌ WebSocket初始化失败:', error);
                    this.updateConnectionStatus(false);
                }
            }

            async sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 清空输入框
            input.value = '';
                this.autoResize(input);

                // 隐藏欢迎界面
                const welcomeSection = document.getElementById('welcomeSection');
                if (welcomeSection) {
                    welcomeSection.style.display = 'none';
                }

                // 添加用户消息
                this.addMessage({
                    type: 'user',
                    content: message,
                    timestamp: new Date()
                });

                // 显示AI思考状态
                this.showTypingIndicator();

                try {
                    // 发送到AI服务
                    const response = await this.callAIService(message);
                    
                    // 隐藏思考状态
                    this.hideTypingIndicator();
                    
                    // 添加AI回复
                    this.addMessage({
                        type: 'ai',
                        content: response,
                        timestamp: new Date()
                    });

                    // 自动保存
                    if (this.settings.enableAutoSave) {
                        this.saveChatHistory();
                    }

                } catch (error) {
                    console.error('❌ 发送消息失败:', error);
                    this.hideTypingIndicator();
                    this.addMessage({
                        type: 'error',
                        content: '抱歉，消息发送失败。请检查网络连接后重试。',
                        timestamp: new Date()
                    });
                }
            }

            async callAIService(message) {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.getAuthToken()}`
                    },
                    body: JSON.stringify({
                        message: message,
                        chatId: this.currentChatId,
                        settings: this.settings,
                        history: this.messages.slice(-10) // 发送最近10条消息作为上下文
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.response;
            }

            addMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
                const messageElement = this.createMessageElement(message);
                
                chatMessages.appendChild(messageElement);
                this.messages.push(message);
                
                // 滚动到底部
                this.scrollToBottom();
                
                // 动画效果
                gsap.fromTo(messageElement, 
                    { opacity: 0, y: 20 }, 
                    { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" }
                );
            }

            createMessageElement(message) {
            const messageDiv = document.createElement('div');
                messageDiv.className = `message-bubble mb-3 p-3 rounded-4 ${this.getMessageClass(message.type)}`;
            
                const content = this.formatMessageContent(message.content, message.type);
                const timestamp = this.formatTimestamp(message.timestamp);
                
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start gap-3">
                        ${this.getMessageAvatar(message.type)}
                        <div class="flex-grow-1">
                            <div class="message-content">${content}</div>
                            <div class="message-meta mt-2 d-flex justify-content-between align-items-center">
                                <small class="text-white-50">${timestamp}</small>
                                <div class="message-actions">
                                    <button class="btn btn-sm text-white-50" onclick="copyMessage(this)" title="复制">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    ${message.type === 'ai' ? `
                                        <button class="btn btn-sm text-white-50" onclick="regenerateResponse(this)" title="重新生成">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                    ` : ''}
                    </div>
                    </div>
                    </div>
                    </div>
                `;
                
                return messageDiv;
            }

            getMessageClass(type) {
                switch (type) {
                    case 'user': return 'user-message ms-5';
                    case 'ai': return 'ai-message me-5';
                    case 'system': return 'system-message';
                    case 'error': return 'error-message';
                    case 'warning': return 'warning-message';
                    default: return 'ai-message me-5';
                }
            }

            getMessageAvatar(type) {
                switch (type) {
                    case 'user':
                        return '<div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-user text-white"></i></div>';
                    case 'ai':
                        return '<div class="avatar bg-gradient-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-robot text-white"></i></div>';
                    case 'system':
                        return '<div class="avatar bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-cog text-white"></i></div>';
                    default:
                        return '<div class="avatar bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;"><i class="fas fa-info text-white"></i></div>';
                }
            }

            formatMessageContent(content, type) {
                if (type === 'ai' && this.settings.enableCodeHighlight) {
                    // 处理代码块
                    content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
                        const lang = language || 'text';
                        return `
                            <div class="code-block mt-2 mb-2">
                                <div class="code-header">
                                    <span class="text-white-50">${lang}</span>
                                    <button class="btn btn-sm text-white-50" onclick="copyCode(this)" title="复制代码">
                                        <i class="fas fa-copy"></i>
                                    </button>
                </div>
                                <pre class="p-3 mb-0"><code class="language-${lang}">${this.escapeHtml(code.trim())}</code></pre>
                            </div>
                        `;
                    });
                    
                    // 处理行内代码
                    content = content.replace(/`([^`]+)`/g, '<code class="bg-dark text-warning p-1 rounded">$1</code>');
                }
                
                // 处理Markdown
                if (typeof marked !== 'undefined') {
                    content = marked.parse(content);
                }
                
                return content;
            }

            formatTimestamp(timestamp) {
                return new Date(timestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showTypingIndicator() {
                if (this.isTyping) return;
                
                this.isTyping = true;
                const typingElement = document.createElement('div');
                typingElement.id = 'typingIndicator';
                typingElement.className = 'message-bubble ai-message me-5 mb-3 p-3 rounded-4';
                typingElement.innerHTML = `
                    <div class="d-flex align-items-start gap-3">
                        ${this.getMessageAvatar('ai')}
                <div class="typing-indicator">
                            <span class="text-white-50 me-2">AI正在思考</span>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                </div>
            `;
            
                document.getElementById('chatMessages').appendChild(typingElement);
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
                this.isTyping = false;
            }

            scrollToBottom() {
                const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
            // ...existing code...
            setupQuantumBackground() {
                const container = document.getElementById('quantum-particles');
                const particleCount = 50;
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'quantum-particle';
                    particle.style.cssText = `
                        position: absolute;
                        width: ${Math.random() * 4 + 2}px;
                        height: ${Math.random() * 4 + 2}px;
                        background: rgba(102, 126, 234, ${Math.random() * 0.5 + 0.2});
                        border-radius: 50%;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        animation: float ${Math.random() * 6 + 4}s ease-in-out infinite;
                        animation-delay: ${Math.random() * 2}s;
                    `;
                    container.appendChild(particle);
                }
            }

            // 更多方法...
            loadSettings() {
                const saved = localStorage.getItem('chatSettings');
                if (saved) {
                    this.settings = { ...this.settings, ...JSON.parse(saved) };
                    this.applySettings();
                }
            }

            saveSettings() {
                localStorage.setItem('chatSettings', JSON.stringify(this.settings));
            }

            applySettings() {
                document.getElementById('aiModel').value = this.settings.model;
                document.getElementById('temperature').value = this.settings.temperature;
                document.getElementById('temperatureValue').textContent = this.settings.temperature;
                document.getElementById('maxTokens').value = this.settings.maxTokens;
                document.getElementById('enableVoice').checked = this.settings.enableVoice;
                document.getElementById('enableFileUpload').checked = this.settings.enableFileUpload;
                document.getElementById('enableCodeHighlight').checked = this.settings.enableCodeHighlight;
                document.getElementById('enableAutoSave').checked = this.settings.enableAutoSave;
            }

            setupAutoResize() {
                const textarea = document.getElementById('messageInput');
                textarea.addEventListener('input', () => this.autoResize(textarea));
            }

            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
            }

            setupShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey) {
                        switch (e.key.toLowerCase()) {
                            case 'l':
                                e.preventDefault();
                                document.getElementById('messageInput').value = '';
                                break;
                            case 'm':
                                e.preventDefault();
                                this.toggleVoiceInput();
                                break;
                        }
                    }
                });
            }

            toggleVoiceInput() {
                // 语音输入实现
                console.log('🎤 语音输入功能');
            }

            toggleSidebar() {
                const sidebar = document.getElementById('chatSidebar');
                sidebar.classList.toggle('active');
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            // 工具方法
            getAuthToken() {
                return localStorage.getItem('auth_token') || '';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            updateConnectionStatus(connected) {
                const statusDot = document.querySelector('.status-dot');
                const statusText = document.querySelector('.ai-status span');
                
                if (connected) {
                    statusDot.style.background = '#10b981';
                    statusText.textContent = 'AI在线';
                } else {
                    statusDot.style.background = '#ef4444';
                    statusText.textContent = 'AI离线';
                }
            }

            // 更多实用方法...
            newChat() {
                this.currentChatId = this.generateChatId();
                this.messages = [];
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('welcomeSection').style.display = 'block';
            }

            generateChatId() {
                return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            saveChatHistory() {
                const chats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                const currentChat = {
                    id: this.currentChatId,
                    messages: this.messages,
                    timestamp: new Date(),
                    title: this.generateChatTitle()
                };
                
                chats.unshift(currentChat);
                localStorage.setItem('chatHistory', JSON.stringify(chats.slice(0, 50))); // 保存最近50个对话
                this.renderChatHistory();
            }

            loadChatHistory() {
                const chats = JSON.parse(localStorage.getItem('chatHistory') || '[]');
                this.renderChatHistory(chats);
            }

            renderChatHistory(chats = []) {
                const container = document.getElementById('chatHistory');
                container.innerHTML = '';
                
                chats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'chat-history-item p-3 mb-2 rounded-3 cursor-pointer';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="text-white mb-1">${chat.title}</div>
                                <div class="small text-white-50">${this.formatTimestamp(chat.timestamp)}</div>
                            </div>
                            <button class="btn btn-sm text-white-50" onclick="deleteChat('${chat.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    item.addEventListener('click', () => this.loadChat(chat.id));
                    container.appendChild(item);
                });
            }

            generateChatTitle() {
                if (this.messages.length > 0) {
                    const firstMessage = this.messages.find(m => m.type === 'user');
                    if (firstMessage) {
                        return firstMessage.content.substring(0, 30) + (firstMessage.content.length > 30 ? '...' : '');
                    }
                }
                return '新对话';
            }
        }

        // 全局函数
        function insertQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            document.getElementById('messageInput').focus();
        }

        function copyMessage(button) {
            const messageContent = button.closest('.message-bubble').querySelector('.message-content').textContent;
            navigator.clipboard.writeText(messageContent);
            showToast('消息已复制到剪贴板', 'success');
        }

        function copyCode(button) {
            const codeContent = button.closest('.code-block').querySelector('code').textContent;
            navigator.clipboard.writeText(codeContent);
            showToast('代码已复制到剪贴板', 'success');
        }

        function regenerateResponse(button) {
            // 重新生成AI回复的逻辑
            showToast('正在重新生成回复...', 'info');
        }

        function resetSettings() {
            if (confirm('确定要重置所有设置吗？')) {
                localStorage.removeItem('chatSettings');
                window.location.reload();
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast_' + Date.now();
            
            const toastHTML = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('auth_token');
                window.location.href = '/login.html';
            }
        }

        // 初始化系统
        let chatSystem;
        document.addEventListener('DOMContentLoaded', () => {
            chatSystem = new EnhancedChatSystem();
        });
    </script>
</body>
</html>
