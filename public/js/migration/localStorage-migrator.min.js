class LocalStorageMigrator{constructor(){this.apiBase='/api/user-settings';this.migrationKey='localStorage_migrated';this.backupKey='localStorage_backup';}async needsMigration(){if(localStorage.getItem(this.migrationKey)){return false;}const migrateableData=this.getMigrateableData();return Object.keys(migrateableData).length > 0;}async migrate(){try{this.backupLocalStorage();const migrateableData=this.getMigrateableData();if(Object.keys(migrateableData).length===0){this.markMigrationComplete();return{success: true,message: 'æ²¡æœ‰éœ€è¦è¿ç§»çš„æ•°æ®'};}const response=await this.sendDataToServer(migrateableData);if(response.success){this.markMigrationComplete();if(await this.confirmDataCleanup()){this.cleanupMigratedData();}return{success: true,message: 'æ•°æ®è¿ç§»æˆåŠŸ',importedCount: response.data.imported_count};}else{throw new Error(response.error || 'è¿ç§»å¤±è´¥');}}catch(error){console.error('localStorageè¿ç§»å¤±è´¥:',error);return{success: false,error: error.message};}}getMigrateableData(){const migrateableKeys=[ 'token','guestMode','chatSettings','currentUser','currentSessionId','chatHistory','voiceInput','autoTTS','theme','darkMode','customThemes','accessibility-settings','fontSize','highContrast','detectionHistory','performanceBaseline','detectionSettings','language','timezone' ];const data={};migrateableKeys.forEach(key=>{const value=localStorage.getItem(key);if(value !==null){try{data[key]=JSON.parse(value);}catch{data[key]=value;}}});const prefixes=['state_','chat_','theme_','detection_'];for(let i=0;i < localStorage.length;i++){const key=localStorage.key(i);if(prefixes.some(prefix=> key.startsWith(prefix))){const value=localStorage.getItem(key);if(value !==null){try{data[key]=JSON.parse(value);}catch{data[key]=value;}}}}return data;}async sendDataToServer(data){const response=await fetch(`${this.apiBase}/import-localstorage`,{method: 'POST',headers:{'Content-Type': 'application/json','Authorization': `Bearer ${this.getAuthToken()}`},body: JSON.stringify({localStorage: data})});return await response.json();}backupLocalStorage(){const backup={};for(let i=0;i < localStorage.length;i++){const key=localStorage.key(i);backup[key]=localStorage.getItem(key);}localStorage.setItem(this.backupKey,JSON.stringify({timestamp: new Date().toISOString(),data: backup}));}restoreFromBackup(){const backupData=localStorage.getItem(this.backupKey);if(!backupData){throw new Error('æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ•°æ®');}try{const backup=JSON.parse(backupData);const preserveKeys=[this.backupKey,this.migrationKey];const keysToRemove=[];for(let i=0;i < localStorage.length;i++){const key=localStorage.key(i);if(!preserveKeys.includes(key)){keysToRemove.push(key);}}keysToRemove.forEach(key=> localStorage.removeItem(key));Object.entries(backup.data).forEach(([key,value])=>{if(!preserveKeys.includes(key)){localStorage.setItem(key,value);}});return true;}catch(error){console.error('æ¢å¤å¤‡ä»½å¤±è´¥:',error);return false;}}cleanupMigratedData(){const migrateableData=this.getMigrateableData();Object.keys(migrateableData).forEach(key=>{localStorage.removeItem(key);});}markMigrationComplete(){localStorage.setItem(this.migrationKey,JSON.stringify({timestamp: new Date().toISOString(),version: '1.0'}));}async confirmDataCleanup(){if(window.confirm('è¿ç§»æˆåŠŸï¼æ˜¯å¦æ¸…é™¤æµè§ˆå™¨ä¸­çš„æ—§æ•°æ®ï¼Ÿï¼ˆæ¨èæ¸…é™¤ä»¥é¿å…å†²çªï¼‰')){return true;}return false;}getAuthToken(){return localStorage.getItem('token')|| localStorage.getItem('auth_token')|| '';}showMigrationProgress(message){const progressElement=document.getElementById('migration-progress');if(progressElement){progressElement.textContent=message;}}getMigrationStatus(){const migrationData=localStorage.getItem(this.migrationKey);if(!migrationData){return{migrated: false};}try{const data=JSON.parse(migrationData);return{migrated: true,timestamp: data.timestamp,version: data.version};}catch{return{migrated: false};}}async forceMigration(){localStorage.removeItem(this.migrationKey);return await this.migrate();}}class AutoMigrationManager{constructor(){this.migrator=new LocalStorageMigrator();this.init();}async init(){if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=> this.checkAndMigrate());}else{await this.checkAndMigrate();}}async checkAndMigrate(){try{if(!this.isUserLoggedIn()){return;}if(await this.migrator.needsMigration()){this.showMigrationPrompt();}}catch(error){console.error('è¿ç§»æ£€æŸ¥å¤±è´¥:',error);}}isUserLoggedIn(){const token=localStorage.getItem('token')|| localStorage.getItem('auth_token');return !!token;}showMigrationPrompt(){const prompt=document.createElement('div');prompt.id='migration-prompt';prompt.className='migration-prompt';prompt.innerHTML=` <div class="migration-content"> <h3>ğŸ”„ æ•°æ®å‡çº§</h3> <p>æˆ‘ä»¬æ£€æµ‹åˆ°æ‚¨æœ‰æœ¬åœ°å­˜å‚¨çš„è®¾ç½®æ•°æ®ï¼Œä¸ºäº†æä¾›æ›´å¥½çš„ä½“éªŒï¼Œå»ºè®®å°†è¿™äº›æ•°æ®åŒæ­¥åˆ°äº‘ç«¯ã€‚</p> <div class="migration-actions"> <button id="migrate-now" class="btn btn-primary">ç«‹å³å‡çº§</button> <button id="migrate-later" class="btn btn-secondary">ç¨åæé†’</button> <button id="migrate-skip" class="btn btn-text">è·³è¿‡</button> </div> <div id="migration-progress" class="migration-progress" style="display: none;"></div> </div> `;const style=document.createElement('style');style.textContent=` .migration-prompt{position: fixed;top: 20px;right: 20px;background: white;border: 1px solid #ddd;border-radius: 8px;padding: 20px;box-shadow: 0 4px 12px rgba(0,0,0,0.15);z-index: 10000;max-width: 400px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;}.migration-content h3{margin: 0 0 10px 0;color: #333;}.migration-content p{margin: 0 0 15px 0;color: #666;line-height: 1.4;}.migration-actions{display: flex;gap: 10px;flex-wrap: wrap;}.migration-actions .btn{padding: 8px 16px;border: none;border-radius: 4px;cursor: pointer;font-size: 14px;}.btn-primary{background: #007bff;color: white;}.btn-secondary{background: #6c757d;color: white;}.btn-text{background: transparent;color: #6c757d;}.migration-progress{margin-top: 10px;padding: 10px;background: #f8f9fa;border-radius: 4px;font-size: 14px;}`;document.head.appendChild(style);document.body.appendChild(prompt);this.bindMigrationEvents(prompt);}bindMigrationEvents(prompt){const migrateNow=prompt.querySelector('#migrate-now');const migrateLater=prompt.querySelector('#migrate-later');const migrateSkip=prompt.querySelector('#migrate-skip');const progressDiv=prompt.querySelector('#migration-progress');migrateNow.addEventListener('click',async()=>{progressDiv.style.display='block';progressDiv.textContent='æ­£åœ¨è¿ç§»æ•°æ®...';const result=await this.migrator.migrate();if(result.success){progressDiv.textContent=`âœ… ${result.message}`;setTimeout(()=> prompt.remove(),3000);}else{progressDiv.textContent=`âŒ è¿ç§»å¤±è´¥: ${result.error}`;}});migrateLater.addEventListener('click',()=>{localStorage.setItem('migration_remind_after',Date.now()+24*60*60*1000);prompt.remove();});migrateSkip.addEventListener('click',()=>{localStorage.setItem('migration_skipped','true');prompt.remove();});}}window.LocalStorageMigrator=LocalStorageMigrator;window.AutoMigrationManager=AutoMigrationManager;new AutoMigrationManager();