class AlingAiApp{constructor(){this.config={apiBase: '/api/v1',wsUrl: this.getWebSocketUrl(),debug: true,version: '1.0.0'};this.modules=new Map();this.services=new Map();this.eventBus=new EventTarget();this.init();}async init(){try{this.checkBrowserSupport();await this.initCoreServices();await this.initUIComponents();await this.initRouter();await this.start();}catch(error){console.error('❌ 应用启动失败:',error);this.showErrorDialog('应用启动失败',error.message);}}checkBrowserSupport(){const features=[ 'fetch','Promise','WebSocket','localStorage','sessionStorage' ];const unsupported=features.filter(feature=> !(feature in window));if(unsupported.length > 0){throw new Error(`浏览器不支持以下特性: ${unsupported.join(',')}`);}}async initCoreServices(){const{HttpClient}=await import('./services/http-client.js');this.services.set('http',new HttpClient(this.config.apiBase));const{WebSocketManager}=await import('./services/websocket-manager.js');this.services.set('ws',new WebSocketManager(this.config.wsUrl));const{StateManager}=await import('./services/state-manager.js');this.services.set('state',new StateManager());const{AuthService}=await import('./services/auth-service.js');this.services.set('auth',new AuthService(this.services.get('http')));const{NotificationService}=await import('./services/notification-service.js');this.services.set('notifications',new NotificationService());const{ThemeManager}=await import('./services/theme-manager.js');this.services.set('theme',new ThemeManager());const{I18nService}=await import('./services/i18n-service.js');this.services.set('i18n',new I18nService());}async initUIComponents(){const{ComponentRegistry}=await import('./ui/component-registry.js');this.componentRegistry=new ComponentRegistry();await this.registerCoreComponents();await this.componentRegistry.initializeComponents();}async registerCoreComponents(){const components=[ 'header-component','sidebar-component','chat-component','user-menu-component','notification-component','modal-component','loading-component','error-component' ];for(const componentName of components){try{const module=await import(`./ui/components/${componentName}.js`);this.componentRegistry.register(componentName,module.default);}catch(error){console.warn(`组件 ${componentName}加载失败:`,error);}}}async initRouter(){const{Router}=await import('./router/router.js');this.router=new Router();this.router.config({mode: 'hash',base: '/',linkActiveClass: 'active'});await this.registerRoutes();this.router.start();}async registerRoutes(){const{routes}=await import('./router/routes.js');routes.forEach(route=>{this.router.register(route.path,route.handler,route.options);});}async start(){const authService=this.services.get('auth');await authService.checkAuthStatus();const wsManager=this.services.get('ws');await wsManager.connect();this.bindGlobalEvents();this.showMainInterface();this.eventBus.dispatchEvent(new CustomEvent('app:started'));}bindGlobalEvents(){window.addEventListener('resize',this.debounce(()=>{this.eventBus.dispatchEvent(new CustomEvent('app:resize'));},250));window.addEventListener('online',()=>{this.eventBus.dispatchEvent(new CustomEvent('app:online'));});window.addEventListener('offline',()=>{this.eventBus.dispatchEvent(new CustomEvent('app:offline'));});document.addEventListener('visibilitychange',()=>{const event=document.hidden ? 'app:hidden' : 'app:visible';this.eventBus.dispatchEvent(new CustomEvent(event));});window.addEventListener('error',(event)=>{console.error('未处理的错误:',event.error);this.services.get('notifications').error('发生了一个错误',event.error.message);});window.addEventListener('unhandledrejection',(event)=>{console.error('未处理的Promise拒绝:',event.reason);this.services.get('notifications').error('操作失败',event.reason.message || '未知错误');});}showMainInterface(){const loadingElement=document.querySelector('.app-loading');const mainElement=document.querySelector('.app-main');if(loadingElement){loadingElement.style.display='none';}if(mainElement){mainElement.style.display='block';}}getWebSocketUrl(){const protocol=window.location.protocol==='https:' ? 'wss:' : 'ws:';const host=window.location.host;return `${protocol}}debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}showErrorDialog(title,message){const modal=document.createElement('div');modal.className='error-modal';modal.innerHTML=` <div class="error-modal-content"> <h3>${title}</h3> <p>${message}</p> <button onclick="location.reload()">重新加载</button> </div> `;document.body.appendChild(modal);}getService(name){return this.services.get(name);}getModule(name){return this.modules.get(name);}registerModule(name,module){this.modules.set(name,module);}emit(eventName,data=null){this.eventBus.dispatchEvent(new CustomEvent(eventName,{detail: data}));}on(eventName,handler){this.eventBus.addEventListener(eventName,handler);}off(eventName,handler){this.eventBus.removeEventListener(eventName,handler);}}window.app=new AlingAiApp();export default AlingAiApp;