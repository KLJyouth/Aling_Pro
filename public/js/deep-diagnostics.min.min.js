class ChatSystemDiagnostics{constructor(){this.diagnosticResults=[];this.issues=[];this.recommendations=[];}log(category,message,level='info'){const timestamp=new Date().toLocaleTimeString();const entry={timestamp,category,message,level};this.diagnosticResults.push(entry);const color={'error': 'color: red;font-weight: bold','warn': 'color: orange;font-weight: bold','success': 'color: green;font-weight: bold','info': 'color: blue'}[level] || 'color: black';}addIssue(issue,recommendation){this.issues.push(issue);this.recommendations.push(recommendation);this.log('ISSUE',issue,'error');this.log('RECOMMENDATION',recommendation,'warn');}async checkDOMStructure(){this.log('DOM','æ£€æŸ¥DOMç»“æ„...','info');const requiredElements=[{id: 'chatContainer',desc: 'èŠå¤©å®¹å™¨'},{id: 'messageInput',desc: 'æ¶ˆæ¯è¾“å…¥æ¡†'},{id: 'sendButton',desc: 'å‘é€æŒ‰é’®'},{id: 'settingsBtn',desc: 'è®¾ç½®æŒ‰é’®'},{id: 'historyBtn',desc: 'å†å²æŒ‰é’®'},{id: 'languageBtn',desc: 'è¯­è¨€æŒ‰é’®'},{id: 'loginModal',desc: 'ç™»å½•æ¨¡æ€æ¡†'},{id: 'guestModeBtn',desc: 'è®¿å®¢æ¨¡å¼æŒ‰é’®'}];let missingElements=0;for(const element of requiredElements){const domElement=document.getElementById(element.id);if(!domElement){this.addIssue(`ç¼ºå¤±DOMå…ƒç´ : ${element.id}(${element.desc})`,`æ£€æŸ¥HTMLæ–‡ä»¶ä¸­æ˜¯å¦æ­£ç¡®å®šä¹‰äº†id="${element.id}"çš„å…ƒç´ `);missingElements++;}else{this.log('DOM',`âœ… ${element.desc}å­˜åœ¨`,'success');}}if(missingElements===0){this.log('DOM','âœ… DOMç»“æ„å®Œæ•´','success');}}async checkScriptLoading(){this.log('SCRIPTS','æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€...','info');const requiredClasses=[{name: 'MessageProcessor',desc: 'æ¶ˆæ¯å¤„ç†å™¨'},{name: 'MessageRenderer',desc: 'æ¶ˆæ¯æ¸²æŸ“å™¨'}];const requiredGlobals=[{name: 'ChatCore',desc: 'èŠå¤©æ ¸å¿ƒ'},{name: 'ChatUI',desc: 'èŠå¤©UI'},{name: 'ChatAPI',desc: 'èŠå¤©API'}];for(const cls of requiredClasses){if(typeof window[cls.name]==='undefined'){this.addIssue(`ç±» ${cls.name}æœªå®šä¹‰`,`æ£€æŸ¥ç›¸åº”çš„JSæ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½å¹¶å®šä¹‰äº† ${cls.name}ç±»`);}else{this.log('SCRIPTS',`âœ… ${cls.desc}å·²åŠ è½½`,'success');}}for(const global of requiredGlobals){if(typeof window[global.name]==='undefined'){this.addIssue(`å…¨å±€å¯¹è±¡ ${global.name}æœªæš´éœ²`,`æ£€æŸ¥æ¨¡å—è„šæœ¬æ˜¯å¦æ­£ç¡®å°† ${global.name}æš´éœ²åˆ° window å¯¹è±¡`);}else{this.log('SCRIPTS',`âœ… ${global.desc}å·²æš´éœ²`,'success');}}}async checkMessageProcessorMethods(){this.log('PROCESSOR','æ£€æŸ¥MessageProcessoræ–¹æ³•...','info');if(typeof MessageProcessor==='undefined'){this.addIssue('MessageProcessorç±»æœªå®šä¹‰','æ£€æŸ¥message-processor.jsæ–‡ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½');return;}const requiredMethods=[ 'processUserMessage','processAssistantMessage','escapeHtml','processMarkdown' ];for(const method of requiredMethods){if(typeof MessageProcessor[method] !=='function'){this.addIssue(`MessageProcessor.${method}æ–¹æ³•æœªå®šä¹‰`,`åœ¨MessageProcessorç±»ä¸­æ·»åŠ  ${method}é™æ€æ–¹æ³•`);}else{this.log('PROCESSOR',`âœ… ${method}æ–¹æ³•å­˜åœ¨`,'success');try{if(method==='processUserMessage'){const result=MessageProcessor[method]('æµ‹è¯•');if(!result)throw new Error('è¿”å›ç©ºå€¼');}else if(method==='processAssistantMessage'){const result=MessageProcessor[method]('**æµ‹è¯•**');if(!result)throw new Error('è¿”å›ç©ºå€¼');}this.log('PROCESSOR',`âœ… ${method}åŠŸèƒ½æ­£å¸¸`,'success');}catch(error){this.addIssue(`MessageProcessor.${method}åŠŸèƒ½å¼‚å¸¸: ${error.message}`,`æ£€æŸ¥ ${method}æ–¹æ³•çš„å®ç°é€»è¾‘`);}}}}async checkEventHandlers(){this.log('EVENTS','æ£€æŸ¥äº‹ä»¶å¤„ç†å™¨...','info');const buttonChecks=[{id: 'sendButton',desc: 'å‘é€æŒ‰é’®',expectedEvents: ['click']},{id: 'settingsBtn',desc: 'è®¾ç½®æŒ‰é’®',expectedEvents: ['click']},{id: 'historyBtn',desc: 'å†å²æŒ‰é’®',expectedEvents: ['click']},{id: 'languageBtn',desc: 'è¯­è¨€æŒ‰é’®',expectedEvents: ['click']},{id: 'guestModeBtn',desc: 'è®¿å®¢æ¨¡å¼æŒ‰é’®',expectedEvents: ['click']}];for(const check of buttonChecks){const element=document.getElementById(check.id);if(!element)continue;let hasEventHandler=false;if(element.onclick){hasEventHandler=true;this.log('EVENTS',`âœ… ${check.desc}æœ‰onclickå¤„ç†å™¨`,'success');}const listeners=getEventListeners ? getEventListeners(element): null;if(listeners && listeners.click && listeners.click.length > 0){hasEventHandler=true;this.log('EVENTS',`âœ… ${check.desc}æœ‰addEventListenerå¤„ç†å™¨`,'success');}if(!hasEventHandler){this.addIssue(`${check.desc}ç¼ºå°‘äº‹ä»¶å¤„ç†å™¨`,`ä¸º ${check.id}æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨`);}}const messageInput=document.getElementById('messageInput');if(messageInput){const hasKeydownHandler=messageInput.onkeydown ||(getEventListeners && getEventListeners(messageInput).keydown);if(!hasKeydownHandler){this.addIssue('æ¶ˆæ¯è¾“å…¥æ¡†ç¼ºå°‘é”®ç›˜äº‹ä»¶å¤„ç†å™¨','ä¸ºmessageInputæ·»åŠ keydownäº‹ä»¶å¤„ç†å™¨ä»¥æ”¯æŒå›è½¦å‘é€');}else{this.log('EVENTS','âœ… æ¶ˆæ¯è¾“å…¥æ¡†äº‹ä»¶å¤„ç†å™¨å­˜åœ¨','success');}}}async checkAPIEndpoints(){this.log('API','æ£€æŸ¥APIç«¯ç‚¹...','info');const endpoints=[{url: '/api/status',desc: 'çŠ¶æ€ç«¯ç‚¹'},{url: '/api/chat/deepseek-chat',desc: 'èŠå¤©ç«¯ç‚¹',method: 'POST'}];for(const endpoint of endpoints){try{const options=endpoint.method==='POST' ?{method: 'POST',headers:{'Content-Type': 'application/json'},body: JSON.stringify({message: 'æµ‹è¯•',mode: 'guest'})}:{};const response=await fetch(endpoint.url,options);if(response.ok){this.log('API',`âœ… ${endpoint.desc}å¯è®¿é—®`,'success');}else{this.addIssue(`${endpoint.desc}è¿”å›é”™è¯¯çŠ¶æ€: ${response.status}`,`æ£€æŸ¥æœåŠ¡å™¨ç«¯ ${endpoint.url}çš„å®ç°`);}}catch(error){this.addIssue(`${endpoint.desc}è¯·æ±‚å¤±è´¥: ${error.message}`,`æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œä»¥åŠç½‘ç»œè¿æ¥`);}}}async checkConsoleErrors(){this.log('CONSOLE','æ£€æŸ¥æ§åˆ¶å°é”™è¯¯...','info');const originalError=console.error;const errors=[];console.error=function(...args){errors.push(args.join(' '));originalError.apply(console,args);};await new Promise(resolve=> setTimeout(resolve,1000));console.error=originalError;if(errors.length > 0){for(const error of errors){this.addIssue(`æ§åˆ¶å°é”™è¯¯: ${error}`,'æ£€æŸ¥ç›¸å…³ä»£ç å¹¶ä¿®å¤é”™è¯¯');}}else{this.log('CONSOLE','âœ… æ— æ§åˆ¶å°é”™è¯¯','success');}}generateReport(){const report={timestamp: new Date().toISOString(),totalChecks: this.diagnosticResults.length,issuesFound: this.issues.length,healthScore: Math.max(0,100-(this.issues.length*10)),diagnostics: this.diagnosticResults,issues: this.issues,recommendations: this.recommendations};console.log('\n'+'='.repeat(60));console.log('='.repeat(60));console.log(`ğŸ•’ è¯Šæ–­æ—¶é—´: ${new Date().toLocaleString()}`);console.log('='.repeat(60));if(report.issuesFound > 0){this.issues.forEach((issue,index)=>{});this.recommendations.forEach((rec,index)=>{});}else{}console.log('\n'+'='.repeat(60));return report;}async runFullDiagnostics(){await this.checkDOMStructure();await this.checkScriptLoading();await this.checkMessageProcessorMethods();await this.checkEventHandlers();await this.checkAPIEndpoints();await this.checkConsoleErrors();const report=this.generateReport();window.diagnosticReport=report;return report;}}window.deepDiagnostics=new ChatSystemDiagnostics();console.log('ğŸ” æ·±åº¦è¯Šæ–­ç³»ç»Ÿå·²åŠ è½½(è‡ªåŠ¨æ‰§è¡Œå·²ç¦ç”¨)');console.log('ğŸ’¡ ä½¿ç”¨ window.deepDiagnostics.runFullDiagnostics()æ‰‹åŠ¨æ‰§è¡Œè¯Šæ–­');