<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlingAi Pro 6.0 - 安全管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .management-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--light-color);
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--dark-color);
            font-weight: 600;
            padding: 15px 25px;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-tabs .nav-link:hover {
            background: var(--light-color);
            color: var(--dark-color);
        }

        .tab-content {
            padding: 30px 0;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f1c40f);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }

        .table tbody td {
            padding: 15px;
            border-bottom: 1px solid var(--light-color);
        }

        .badge {
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: 600;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid var(--light-color);
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-active { background-color: var(--success-color); }
        .status-inactive { background-color: var(--danger-color); }
        .status-warning { background-color: var(--warning-color); }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-title {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="management-container">
        <!-- 头部 -->
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-shield-gear"></i> AlingAi Pro 6.0 安全管理系统</h1>
                    <p class="mb-0">安全策略、规则、配置管理平台</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载指示器 -->
        <div class="loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载数据...</p>
        </div>

        <!-- 主要内容 -->
        <div id="mainContent">
            <!-- 导航标签 -->
            <ul class="nav nav-tabs" id="managementTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="policies-tab" data-bs-toggle="tab" data-bs-target="#policies" type="button" role="tab">
                        <i class="bi bi-shield-check"></i> 安全策略
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">
                        <i class="bi bi-list-check"></i> 安全规则
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="whitelist-tab" data-bs-toggle="tab" data-bs-target="#whitelist" type="button" role="tab">
                        <i class="bi bi-check-circle"></i> 白名单
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="blacklist-tab" data-bs-toggle="tab" data-bs-target="#blacklist" type="button" role="tab">
                        <i class="bi bi-x-circle"></i> 黑名单
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button" role="tab">
                        <i class="bi bi-gear"></i> 系统配置
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                        <i class="bi bi-cloud-arrow-up"></i> 备份恢复
                    </button>
                </li>
            </ul>

            <!-- 标签内容 -->
            <div class="tab-content" id="managementTabContent">
                <!-- 安全策略 -->
                <div class="tab-pane fade show active" id="policies" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-shield-check"></i> 安全策略管理</h3>
                        <button class="btn btn-primary" onclick="showCreatePolicyModal()">
                            <i class="bi bi-plus-circle"></i> 创建策略
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-list"></i> 策略列表
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>策略名称</th>
                                            <th>类型</th>
                                            <th>状态</th>
                                            <th>优先级</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="policiesTableBody">
                                        <!-- 策略数据将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 安全规则 -->
                <div class="tab-pane fade" id="rules" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-list-check"></i> 安全规则管理</h3>
                        <button class="btn btn-primary" onclick="showCreateRuleModal()">
                            <i class="bi bi-plus-circle"></i> 创建规则
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-list"></i> 规则列表
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>规则名称</th>
                                            <th>类型</th>
                                            <th>严重性</th>
                                            <th>状态</th>
                                            <th>动作</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rulesTableBody">
                                        <!-- 规则数据将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 白名单 -->
                <div class="tab-pane fade" id="whitelist" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-check-circle"></i> 白名单管理</h3>
                        <button class="btn btn-success" onclick="showAddWhitelistModal()">
                            <i class="bi bi-plus-circle"></i> 添加到白名单
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-list"></i> 白名单列表
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>类型</th>
                                            <th>值</th>
                                            <th>描述</th>
                                            <th>创建时间</th>
                                            <th>过期时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="whitelistTableBody">
                                        <!-- 白名单数据将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 黑名单 -->
                <div class="tab-pane fade" id="blacklist" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-x-circle"></i> 黑名单管理</h3>
                        <button class="btn btn-danger" onclick="showAddBlacklistModal()">
                            <i class="bi bi-plus-circle"></i> 添加到黑名单
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-list"></i> 黑名单列表
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>类型</th>
                                            <th>值</th>
                                            <th>原因</th>
                                            <th>威胁级别</th>
                                            <th>创建时间</th>
                                            <th>过期时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="blacklistTableBody">
                                        <!-- 黑名单数据将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统配置 -->
                <div class="tab-pane fade" id="config" role="tabpanel">
                    <h3><i class="bi bi-gear"></i> 系统配置</h3>
                    
                    <form id="configForm">
                        <!-- 一般配置 -->
                        <div class="config-section">
                            <div class="config-title">一般配置</div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">安全级别</label>
                                        <select class="form-select" name="security_level">
                                            <option value="low">低</option>
                                            <option value="medium">中</option>
                                            <option value="high" selected>高</option>
                                            <option value="critical">极高</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">自动更新</label>
                                        <div class="d-flex align-items-center">
                                            <label class="switch">
                                                <input type="checkbox" name="auto_update" checked>
                                                <span class="slider"></span>
                                            </label>
                                            <span class="ms-2">启用</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 认证配置 -->
                        <div class="config-section">
                            <div class="config-title">认证配置</div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">双因素认证</label>
                                        <div class="d-flex align-items-center">
                                            <label class="switch">
                                                <input type="checkbox" name="two_factor_enabled" checked>
                                                <span class="slider"></span>
                                            </label>
                                            <span class="ms-2">启用</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">会话超时（秒）</label>
                                        <input type="number" class="form-control" name="session_timeout" value="1800">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 网络配置 -->
                        <div class="config-section">
                            <div class="config-title">网络配置</div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">防火墙</label>
                                        <div class="d-flex align-items-center">
                                            <label class="switch">
                                                <input type="checkbox" name="firewall_enabled" checked>
                                                <span class="slider"></span>
                                            </label>
                                            <span class="ms-2">启用</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">DDoS防护</label>
                                        <div class="d-flex align-items-center">
                                            <label class="switch">
                                                <input type="checkbox" name="ddos_protection" checked>
                                                <span class="slider"></span>
                                            </label>
                                            <span class="ms-2">启用</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> 保存配置
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 备份恢复 -->
                <div class="tab-pane fade" id="backup" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-cloud-arrow-up"></i> 备份恢复</h3>
                        <button class="btn btn-primary" onclick="createBackup()">
                            <i class="bi bi-plus-circle"></i> 创建备份
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-list"></i> 备份列表
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>类型</th>
                                            <th>描述</th>
                                            <th>大小</th>
                                            <th>状态</th>
                                            <th>创建时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backupTableBody">
                                        <!-- 备份数据将通过JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <!-- 创建策略模态框 -->
    <div class="modal fade" id="createPolicyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建安全策略</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPolicyForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">策略名称</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">策略类型</label>
                                    <select class="form-select" name="type" required>
                                        <option value="default">默认</option>
                                        <option value="high_security">高安全</option>
                                        <option value="development">开发环境</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" name="description" rows="3" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">优先级</label>
                                    <select class="form-select" name="priority">
                                        <option value="1">1 - 最低</option>
                                        <option value="2">2</option>
                                        <option value="3" selected>3 - 默认</option>
                                        <option value="4">4</option>
                                        <option value="5">5 - 最高</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">状态</label>
                                    <select class="form-select" name="status">
                                        <option value="active" selected>激活</option>
                                        <option value="inactive">非激活</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createPolicy()">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加到白名单模态框 -->
    <div class="modal fade" id="addWhitelistModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加到白名单</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addWhitelistForm">
                        <div class="mb-3">
                            <label class="form-label">类型</label>
                            <select class="form-select" name="type" required>
                                <option value="ip">IP地址</option>
                                <option value="ip_range">IP范围</option>
                                <option value="domain">域名</option>
                                <option value="user_agent">用户代理</option>
                                <option value="path">路径</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">值</label>
                            <input type="text" class="form-control" name="value" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">过期时间</label>
                            <input type="datetime-local" class="form-control" name="expires_at">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" onclick="addToWhitelist()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentTab = 'policies';

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeManagement();
        });

        // 初始化管理系统
        function initializeManagement() {
            loadPolicies();
            loadRules();
            loadWhitelist();
            loadBlacklist();
            loadBackups();
            loadConfig();
        }

        // 加载安全策略
        async function loadPolicies() {
            try {
                const response = await fetch('/api/security/management/policies');
                const data = await response.json();
                
                if (data.success) {
                    renderPolicies(data.data);
                } else {
                    showError('加载策略失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载策略失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 渲染策略列表
        function renderPolicies(policies) {
            const tbody = document.getElementById('policiesTableBody');
            tbody.innerHTML = '';
            
            policies.forEach(policy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${policy.id}</td>
                    <td>${policy.name}</td>
                    <td><span class="badge bg-info">${policy.type}</span></td>
                    <td>
                        <span class="status-indicator status-${policy.status}"></span>
                        ${policy.status}
                    </td>
                    <td>${policy.priority}</td>
                    <td>${formatTime(policy.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editPolicy(${policy.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePolicy(${policy.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载安全规则
        async function loadRules() {
            try {
                const response = await fetch('/api/security/management/rules');
                const data = await response.json();
                
                if (data.success) {
                    renderRules(data.data);
                } else {
                    showError('加载规则失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载规则失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 渲染规则列表
        function renderRules(rules) {
            const tbody = document.getElementById('rulesTableBody');
            tbody.innerHTML = '';
            
            rules.forEach(rule => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rule.id}</td>
                    <td>${rule.name}</td>
                    <td><span class="badge bg-info">${rule.type}</span></td>
                    <td><span class="badge bg-${getSeverityColor(rule.severity)}">${rule.severity}</span></td>
                    <td>
                        <span class="status-indicator status-${rule.status}"></span>
                        ${rule.status}
                    </td>
                    <td><span class="badge bg-warning">${rule.action}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editRule(${rule.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载白名单
        async function loadWhitelist() {
            try {
                const response = await fetch('/api/security/management/whitelist');
                const data = await response.json();
                
                if (data.success) {
                    renderWhitelist(data.data);
                } else {
                    showError('加载白名单失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载白名单失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 渲染白名单列表
        function renderWhitelist(whitelist) {
            const tbody = document.getElementById('whitelistTableBody');
            tbody.innerHTML = '';
            
            whitelist.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td><span class="badge bg-success">${item.type}</span></td>
                    <td>${item.value}</td>
                    <td>${item.description}</td>
                    <td>${formatTime(item.created_at)}</td>
                    <td>${item.expires_at ? formatTime(item.expires_at) : '永不过期'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeFromWhitelist(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载黑名单
        async function loadBlacklist() {
            try {
                const response = await fetch('/api/security/management/blacklist');
                const data = await response.json();
                
                if (data.success) {
                    renderBlacklist(data.data);
                } else {
                    showError('加载黑名单失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载黑名单失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 渲染黑名单列表
        function renderBlacklist(blacklist) {
            const tbody = document.getElementById('blacklistTableBody');
            tbody.innerHTML = '';
            
            blacklist.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td><span class="badge bg-danger">${item.type}</span></td>
                    <td>${item.value}</td>
                    <td>${item.reason}</td>
                    <td><span class="badge bg-${getThreatLevelColor(item.threat_level)}">${item.threat_level}</span></td>
                    <td>${formatTime(item.created_at)}</td>
                    <td>${item.expires_at ? formatTime(item.expires_at) : '永不过期'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="removeFromBlacklist(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载备份列表
        async function loadBackups() {
            try {
                const response = await fetch('/api/security/management/backups');
                const data = await response.json();
                
                if (data.success) {
                    renderBackups(data.data);
                } else {
                    showError('加载备份失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载备份失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 渲染备份列表
        function renderBackups(backups) {
            const tbody = document.getElementById('backupTableBody');
            tbody.innerHTML = '';
            
            backups.forEach(backup => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${backup.id}</td>
                    <td><span class="badge bg-info">${backup.type}</span></td>
                    <td>${backup.description}</td>
                    <td>${formatFileSize(backup.size)}</td>
                    <td><span class="badge bg-success">${backup.status}</span></td>
                    <td>${formatTime(backup.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="downloadBackup(${backup.id})">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="restoreBackup(${backup.id})">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBackup(${backup.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/api/security/management/config');
                const data = await response.json();
                
                if (data.success) {
                    populateConfigForm(data.data);
                } else {
                    showError('加载配置失败: ' + data.message);
                }
            } catch (error) {
                console.error('加载配置失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 填充配置表单
        function populateConfigForm(config) {
            // 填充一般配置
            document.querySelector('select[name="security_level"]').value = config.general?.security_level || 'high';
            document.querySelector('input[name="auto_update"]').checked = config.general?.auto_update || false;
            
            // 填充认证配置
            document.querySelector('input[name="two_factor_enabled"]').checked = config.authentication?.two_factor_enabled || false;
            document.querySelector('input[name="session_timeout"]').value = config.authentication?.session_timeout || 1800;
            
            // 填充网络配置
            document.querySelector('input[name="firewall_enabled"]').checked = config.network?.firewall_enabled || false;
            document.querySelector('input[name="ddos_protection"]').checked = config.network?.ddos_protection || false;
        }

        // 显示创建策略模态框
        function showCreatePolicyModal() {
            const modal = new bootstrap.Modal(document.getElementById('createPolicyModal'));
            modal.show();
        }

        // 显示添加到白名单模态框
        function showAddWhitelistModal() {
            const modal = new bootstrap.Modal(document.getElementById('addWhitelistModal'));
            modal.show();
        }

        // 创建策略
        async function createPolicy() {
            try {
                const form = document.getElementById('createPolicyForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                const response = await fetch('/api/security/management/policies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('策略创建成功');
                    bootstrap.Modal.getInstance(document.getElementById('createPolicyModal')).hide();
                    loadPolicies();
                } else {
                    showError('创建策略失败: ' + result.message);
                }
            } catch (error) {
                console.error('创建策略失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 添加到白名单
        async function addToWhitelist() {
            try {
                const form = document.getElementById('addWhitelistForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                const response = await fetch('/api/security/management/whitelist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('白名单项添加成功');
                    bootstrap.Modal.getInstance(document.getElementById('addWhitelistModal')).hide();
                    loadWhitelist();
                } else {
                    showError('添加到白名单失败: ' + result.message);
                }
            } catch (error) {
                console.error('添加到白名单失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 创建备份
        async function createBackup() {
            try {
                const response = await fetch('/api/security/management/backup', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('备份创建成功');
                    loadBackups();
                } else {
                    showError('创建备份失败: ' + result.message);
                }
            } catch (error) {
                console.error('创建备份失败:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 保存配置
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // 处理复选框
                data.auto_update = document.querySelector('input[name="auto_update"]').checked;
                data.two_factor_enabled = document.querySelector('input[name="two_factor_enabled"]').checked;
                data.firewall_enabled = document.querySelector('input[name="firewall_enabled"]').checked;
                data.ddos_protection = document.querySelector('input[name="ddos_protection"]').checked;
                
                const response = await fetch('/api/security/management/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('配置保存成功');
                } else {
                    showError('保存配置失败: ' + result.message);
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                showError('网络错误，请检查连接');
            }
        });

        // 刷新数据
        function refreshData() {
            initializeManagement();
        }

        // 辅助函数
        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('zh-CN');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getSeverityColor(severity) {
            const colors = {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'success'
            };
            return colors[severity] || 'secondary';
        }

        function getThreatLevelColor(level) {
            const colors = {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'success'
            };
            return colors[level] || 'secondary';
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'danger');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.management-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // 其他操作函数
        function editPolicy(id) {
            // 实现编辑策略功能
            console.log('编辑策略:', id);
        }

        function deletePolicy(id) {
            if (confirm('确定要删除这个策略吗？')) {
                // 实现删除策略功能
                console.log('删除策略:', id);
            }
        }

        function editRule(id) {
            // 实现编辑规则功能
            console.log('编辑规则:', id);
        }

        function deleteRule(id) {
            if (confirm('确定要删除这个规则吗？')) {
                // 实现删除规则功能
                console.log('删除规则:', id);
            }
        }

        function removeFromWhitelist(id) {
            if (confirm('确定要从白名单中移除这个项目吗？')) {
                // 实现从白名单移除功能
                console.log('从白名单移除:', id);
            }
        }

        function removeFromBlacklist(id) {
            if (confirm('确定要从黑名单中移除这个项目吗？')) {
                // 实现从黑名单移除功能
                console.log('从黑名单移除:', id);
            }
        }

        function downloadBackup(id) {
            // 实现下载备份功能
            console.log('下载备份:', id);
        }

        function restoreBackup(id) {
            if (confirm('确定要恢复这个备份吗？这将覆盖当前配置。')) {
                // 实现恢复备份功能
                console.log('恢复备份:', id);
            }
        }

        function deleteBackup(id) {
            if (confirm('确定要删除这个备份吗？')) {
                // 实现删除备份功能
                console.log('删除备份:', id);
            }
        }
    </script>
</body>
</html> 