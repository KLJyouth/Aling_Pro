<?php include_once __DIR__ . '/../layouts/header.php'; ?>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mt-4">Â§á‰ªΩÁÆ°ÁêÜ</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item"><a href="<?= BASE_URL ?>/dashboard">È¶ñÈ°µ</a></li>
                <li class="breadcrumb-item"><a href="<?= BASE_URL ?>/security">ÂÆâÂÖ®ÁÆ°ÁêÜ</a></li>
                <li class="breadcrumb-item active">Â§á‰ªΩÁÆ°ÁêÜ</li>
            </ol>
            
            <!-- Â§á‰ªΩÊìç‰Ωú -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-database mr-1"></i>
                            ÂàõÂª∫Â§á‰ªΩ
                        </div>
                        <div class="card-body">
                            <form id="backupForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="backupType">Â§á‰ªΩÁ±ªÂûã</label>
                                            <select class="form-control" id="backupType" name="type">
                                                <option value="full">ÂÆåÊï¥Â§á‰ªΩ</option>
                                                <option value="database">Êï∞ÊçÆÂ∫ìÂ§á‰ª?/option>
                                                <option value="files">Êñá‰ª∂Â§á‰ªΩ</option>
                                                <option value="config">ÈÖçÁΩÆÂ§á‰ªΩ</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="backupDescription">Â§á‰ªΩÊèèËø∞</label>
                                            <input type="text" class="form-control" id="backupDescription" name="description" placeholder="ËØ∑ËæìÂÖ•Â§á‰ªΩÊèèËø?>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="createBackupBtn">
                                    <i class="fas fa-save mr-1"></i> ÂàõÂª∫Â§á‰ªΩ
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Â§á‰ªΩÂàóË°® -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table mr-1"></i>
                    Â§á‰ªΩÂàóË°®
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="backupsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ÂêçÁß∞</th>
                                    <th>Á±ªÂûã</th>
                                    <th>Â§ßÂ∞è</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Áä∂ÊÄ?/th>
                                    <th>ÊèèËø∞</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($backups as $backup): ?>
                                <tr>
                                    <td><?= $backup['id'] ?></td>
                                    <td><?= $backup['name'] ?></td>
                                    <td>
                                        <?php 
                                        switch ($backup['type']) {
                                            case 'full':
                                                echo '<span class="badge badge-primary">ÂÆåÊï¥Â§á‰ªΩ</span>';
                                                break;
                                            case 'database':
                                                echo '<span class="badge badge-info">Êï∞ÊçÆÂ∫ìÂ§á‰ª?/span>';
                                                break;
                                            case 'files':
                                                echo '<span class="badge badge-success">Êñá‰ª∂Â§á‰ªΩ</span>';
                                                break;
                                            case 'config':
                                                echo '<span class="badge badge-warning">ÈÖçÁΩÆÂ§á‰ªΩ</span>';
                                                break;
                                        }
                                        ?>
                                    </td>
                                    <td><?= $backup['size'] ?></td>
                                    <td><?= $backup['date'] ?></td>
                                    <td>
                                        <?php 
                                        switch ($backup['status']) {
                                            case 'completed':
                                                echo '<span class="badge badge-success">ÂÆåÊàê</span>';
                                                break;
                                            case 'in_progress':
                                                echo '<span class="badge badge-warning">ËøõË°å‰∏?/span>';
                                                break;
                                            case 'failed':
                                                echo '<span class="badge badge-danger">Â§±Ë¥•</span>';
                                                break;
                                        }
                                        ?>
                                    </td>
                                    <td><?= $backup['description'] ?></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-success restore-backup" data-id="<?= $backup['id'] ?>">
                                                <i class="fas fa-undo-alt"></i> ÊÅ¢Â§ç
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info">
                                                <i class="fas fa-download"></i> ‰∏ãËΩΩ
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> Âà†Èô§
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Â§á‰ªΩÈÖçÁΩÆ -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-cog mr-1"></i>
                    Â§á‰ªΩÈÖçÁΩÆ
                </div>
                <div class="card-body">
                    <form id="backupConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="backupPath">Â§á‰ªΩË∑ØÂæÑ</label>
                                    <input type="text" class="form-control" id="backupPath" name="backup_path" value="<?= $backupConfig['backup_path'] ?>">
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="autoBackup" name="auto_backup" <?= $backupConfig['auto_backup'] ? 'checked' : '' ?>>
                                        <label class="custom-control-label" for="autoBackup">ÂêØÁî®Ëá™Âä®Â§á‰ªΩ</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="backupFrequency">Â§á‰ªΩÈ¢ëÁéá</label>
                                    <select class="form-control" id="backupFrequency" name="backup_frequency">
                                        <option value="hourly" <?= $backupConfig['backup_frequency'] == 'hourly' ? 'selected' : '' ?>>ÊØèÂ∞èÊó?/option>
                                        <option value="daily" <?= $backupConfig['backup_frequency'] == 'daily' ? 'selected' : '' ?>>ÊØèÂ§©</option>
                                        <option value="weekly" <?= $backupConfig['backup_frequency'] == 'weekly' ? 'selected' : '' ?>>ÊØèÂë®</option>
                                        <option value="monthly" <?= $backupConfig['backup_frequency'] == 'monthly' ? 'selected' : '' ?>>ÊØèÊúà</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="backupTime">Â§á‰ªΩÊó∂Èó¥</label>
                                    <input type="time" class="form-control" id="backupTime" name="backup_time" value="<?= $backupConfig['backup_time'] ?>">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="keepBackups">‰øùÁïôÂ§á‰ªΩÊï∞Èáè</label>
                                    <input type="number" class="form-control" id="keepBackups" name="keep_backups" value="<?= $backupConfig['keep_backups'] ?>">
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="compressBackups" name="compress_backups" <?= $backupConfig['compress_backups'] ? 'checked' : '' ?>>
                                        <label class="custom-control-label" for="compressBackups">ÂéãÁº©Â§á‰ªΩÊñá‰ª∂</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Â§á‰ªΩÂÜÖÂÆπ</label>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="backupDatabase" name="backup_types[database]" <?= $backupConfig['backup_types']['database'] ? 'checked' : '' ?>>
                                        <label class="custom-control-label" for="backupDatabase">Êï∞ÊçÆÂ∫?/label>
                                    </div>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="backupFiles" name="backup_types[files]" <?= $backupConfig['backup_types']['files'] ? 'checked' : '' ?>>
                                        <label class="custom-control-label" for="backupFiles">Êñá‰ª∂</label>
                                    </div>
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="backupConfig" name="backup_types[config]" <?= $backupConfig['backup_types']['config'] ? 'checked' : '' ?>>
                                        <label class="custom-control-label" for="backupConfig">ÈÖçÁΩÆ</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> ‰øùÂ≠òÈÖçÁΩÆ
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÊÅ¢Â§çÂ§á‰ªΩÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="restoreBackupModal" tabindex="-1" role="dialog" aria-labelledby="restoreBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="restoreBackupModalLabel">ÊÅ¢Â§çÂ§á‰ªΩÁ°ÆËÆ§</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>ÊÇ®Á°ÆÂÆöË¶ÅÊÅ¢Â§çÊ≠§Â§á‰ªΩÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÁöÑÊï∞ÊçÆ„Ä?/p>
                <p class="text-danger">Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔº?/p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-danger" id="confirmRestoreBtn">Á°ÆËÆ§ÊÅ¢Â§ç</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // ÂàùÂßãÂåñÊï∞ÊçÆË°®Ê†?
        $('#backupsTable').DataTable({
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Chinese.json"
            }
        }];
        
        // ÂàõÂª∫Â§á‰ªΩ
        $('#backupForm').on('submit', function(e) {
            e.preventDefault(];
            
            var formData = {
                type: $('#backupType').val(),
                description: $('#backupDescription').val()
            };
            
            $('#createBackupBtn').html('<i class="fas fa-spinner fa-spin mr-1"></i> ÂàõÂª∫‰∏?..').attr('disabled', true];
            
            // ÂèëÈÄÅAJAXËØ∑Ê±Ç
            $.ajax({
                url: '<?= BASE_URL ?>/security/create-backup',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                        alert('Â§á‰ªΩÂàõÂª∫ÊàêÂäü'];
                        // Âà∑Êñ∞È°µÈù¢
                        window.location.reload(];
                    } else {
                        alert('Â§á‰ªΩÂàõÂª∫Â§±Ë¥•: ' + response.message];
                        $('#createBackupBtn').html('<i class="fas fa-save mr-1"></i> ÂàõÂª∫Â§á‰ªΩ').attr('disabled', false];
                    }
                },
                error: function() {
                    alert('ÂèëÁîüÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'];
                    $('#createBackupBtn').html('<i class="fas fa-save mr-1"></i> ÂàõÂª∫Â§á‰ªΩ').attr('disabled', false];
                }
            }];
        }];
        
        // ÊÅ¢Â§çÂ§á‰ªΩ
        var backupIdToRestore;
        
        $('.restore-backup').on('click', function() {
            backupIdToRestore = $(this).data('id'];
            $('#restoreBackupModal').modal('show'];
        }];
        
        $('#confirmRestoreBtn').on('click', function() {
            // ÂèëÈÄÅAJAXËØ∑Ê±Ç
            $.ajax({
                url: '<?= BASE_URL ?>/security/restore-backup',
                type: 'POST',
                data: {
                    backup_id: backupIdToRestore
                },
                dataType: 'json',
                success: function(response) {
                    $('#restoreBackupModal').modal('hide'];
                    
                    if (response.success) {
                        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                        alert('Â§á‰ªΩÊÅ¢Â§çÊàêÂäü'];
                        // Âà∑Êñ∞È°µÈù¢
                        window.location.reload(];
                    } else {
                        alert('Â§á‰ªΩÊÅ¢Â§çÂ§±Ë¥•: ' + response.message];
                    }
                },
                error: function() {
                    $('#restoreBackupModal').modal('hide'];
                    alert('ÂèëÁîüÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï'];
                }
            }];
        }];
        
        // ‰øùÂ≠òÂ§á‰ªΩÈÖçÁΩÆ
        $('#backupConfigForm').on('submit', function(e) {
            e.preventDefault(];
            
            // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•ÂèëÈÄÅAJAXËØ∑Ê±Ç‰øùÂ≠òÈÖçÁΩÆ
            alert('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü'];
        }];
    }];
</script>

<?php include_once __DIR__ . '/../layouts/footer.php'; ?> 

