// æœ€ç»ˆç”¨æˆ·äº¤äº’æµ‹è¯• - æ¨¡æ‹ŸçœŸå®ä½¿ç”¨åœºæ™¯ class FinalUserInteractionTest { constructor() { this.testSequence = []; this.currentStep = 0; this.startTime = Date.now(); } async runFullUserSimulation() {   try { await this.waitForPageReady(); await this.simulateInitialVisit(); await this.simulateGuestModeActivation(); await this.simulateMessageConversation(); await this.simulateUIInteractions(); await this.simulateAdvancedFeatures(); this.showFinalResults(); } catch (error) { console.error('âŒ ç”¨æˆ·äº¤äº’æµ‹è¯•å¤±è´¥:', error); this.showFinalResults(); } } async waitForPageReady() { this.logStep('ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½å’Œåˆå§‹åŒ–'); let retries = 0; const maxRetries = 20; while (retries < maxRetries) { if (window.chatInstance && document.getElementById('messageInput') && document.getElementById('sendButton') && typeof MessageProcessor !== 'undefined') { this.logSuccess('é¡µé¢å·²å‡†å¤‡å°±ç»ª'); return; } await this.sleep(500); retries++; } throw new Error('é¡µé¢åŠ è½½è¶…æ—¶'); } async simulateInitialVisit() { this.logStep('æ¨¡æ‹Ÿç”¨æˆ·é¦–æ¬¡è®¿é—®'); // æ£€æŸ¥æ¬¢è¿æ¶ˆæ¯ const messagesContainer = document.getElementById('chatMessages'); const welcomeMessage = messagesContainer.querySelector('[data-message-id="welcome"]'); if (welcomeMessage) { this.logSuccess('æ¬¢è¿æ¶ˆæ¯å·²æ˜¾ç¤º'); } else { this.logWarning('æœªæ‰¾åˆ°æ¬¢è¿æ¶ˆæ¯'); } // æ£€æŸ¥ç™»å½•æ¨¡æ€æ¡†æ˜¯å¦å‡ºç° const loginModal = document.getElementById('loginModal'); if (loginModal) { this.logSuccess('ç™»å½•æ¨¡æ€æ¡†å­˜åœ¨'); } } async simulateGuestModeActivation() { this.logStep('æ¨¡æ‹Ÿç”¨æˆ·é€‰æ‹©è®¿å®¢æ¨¡å¼'); const guestButton = document.getElementById('guestModeButton'); if (guestButton) { // æ¨¡æ‹Ÿç‚¹å‡»è®¿å®¢æ¨¡å¼ guestButton.click(); await this.sleep(500); // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ const guestMode = localStorage.getItem('guestMode'); if (guestMode === 'true') { this.logSuccess('è®¿å®¢æ¨¡å¼å·²æ¿€æ´»'); } else { this.logWarning('è®¿å®¢æ¨¡å¼å¯èƒ½æœªæ­£ç¡®è®¾ç½®'); } } else { this.logWarning('æœªæ‰¾åˆ°è®¿å®¢æ¨¡å¼æŒ‰é’®'); } } async simulateMessageConversation() { this.logStep('æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯å¯¹è¯'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); if (!messageInput || !sendButton) { throw new Error('æ¶ˆæ¯è¾“å…¥ç»„ä»¶ä¸å¯ç”¨'); } // æ¨¡æ‹Ÿå¯¹è¯åºåˆ— const conversations = [ { user: "ä½ å¥½ï¼Œæˆ‘æƒ³æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªèŠå¤©åŠŸèƒ½", expectedKeywords: ["æ‚¨å¥½", "æµ‹è¯•", "èŠå¤©"] }, { user: "è¯·å‘Šè¯‰æˆ‘ä»Šå¤©çš„å¤©æ°”å¦‚ä½•ï¼Ÿ", expectedKeywords: ["å¤©æ°”", "ä»Šå¤©"] }, { user: "è¿™é‡Œæœ‰ä¸€äº› **ç²—ä½“æ–‡å­—** å’Œ `ä»£ç ç¤ºä¾‹`", expectedKeywords: ["ç²—ä½“", "ä»£ç "] } ]; for (let i = 0; i < conversations.length; i++) { const conv = conversations[i]; this.logStep(`å‘é€ç¬¬${i+1}æ¡æ¶ˆæ¯: "${conv.user}"`); // è®°å½•å‘é€å‰çš„æ¶ˆæ¯æ•°é‡ const messagesContainer = document.getElementById('chatMessages'); const messageCountBefore = messagesContainer.children.length; // è¾“å…¥æ¶ˆæ¯ messageInput.value = conv.user; messageInput.dispatchEvent(new Event('input', { bubbles: true })); // ç­‰å¾…å‘é€æŒ‰é’®å¯ç”¨ await this.sleep(100); // ç‚¹å‡»å‘é€ sendButton.click(); // ç­‰å¾…æ¶ˆæ¯å¤„ç† await this.sleep(2000); // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å¢åŠ  const messageCountAfter = messagesContainer.children.length; if (messageCountAfter > messageCountBefore) { this.logSuccess(`æ¶ˆæ¯å·²å‘é€ï¼Œæ¶ˆæ¯æ•°é‡ä» ${messageCountBefore} å¢åŠ åˆ° ${messageCountAfter}`); // æ£€æŸ¥æœ€æ–°æ¶ˆæ¯ const latestMessages = Array.from(messagesContainer.children).slice(-2); if (latestMessages.length >= 1) { const userMessage = latestMessages.find(msg => msg.classList.contains('user')); const aiMessage = latestMessages.find(msg => msg.classList.contains('assistant')); if (userMessage) { this.logSuccess('ç”¨æˆ·æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º'); } if (aiMessage) { this.logSuccess('AIå›å¤æ­£ç¡®æ˜¾ç¤º'); // æ£€æŸ¥AIæ¶ˆæ¯çš„æ“ä½œæŒ‰é’® const copyBtn = aiMessage.querySelector('.copy-button'); const regenerateBtn = aiMessage.querySelector('.regenerate-button'); const speakBtn = aiMessage.querySelector('.speak-button'); if (copyBtn && regenerateBtn && speakBtn) { this.logSuccess('AIæ¶ˆæ¯æ“ä½œæŒ‰é’®å®Œæ•´'); } else { this.logWarning('AIæ¶ˆæ¯æ“ä½œæŒ‰é’®å¯èƒ½ç¼ºå¤±'); } } } } else { this.logWarning(`æ¶ˆæ¯å¯èƒ½æœªæ­£ç¡®å‘é€æˆ–æ˜¾ç¤º (æ¶ˆæ¯æ•°é‡æœªå˜åŒ–: ${messageCountBefore})`); } // ç­‰å¾…ä¸‹ä¸€è½®å¯¹è¯ await this.sleep(1000); } } async simulateUIInteractions() { this.logStep('æ¨¡æ‹Ÿç”¨æˆ·ç•Œé¢äº¤äº’'); // æµ‹è¯•é¡¶éƒ¨æŒ‰é’® const buttons = [ { id: 'settingsBtn', name: 'è®¾ç½®æŒ‰é’®' }, { id: 'historyBtn', name: 'å†å²è®°å½•æŒ‰é’®' }, { id: 'langSwitchBtn', name: 'è¯­è¨€åˆ‡æ¢æŒ‰é’®' } ]; for (const btn of buttons) { const element = document.getElementById(btn.id); if (element && element.onclick) { this.logStep(`æµ‹è¯•${btn.name}`); try { element.click(); this.logSuccess(`${btn.name}ç‚¹å‡»æˆåŠŸ`); } catch (error) { this.logWarning(`${btn.name}ç‚¹å‡»å¤±è´¥: ${error.message}`); } await this.sleep(300); } else { this.logWarning(`${btn.name}ä¸å¯ç”¨æˆ–ç¼ºå°‘äº‹ä»¶å¤„ç†å™¨`); } } // æµ‹è¯•AIæ¶ˆæ¯æŒ‰é’®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ const messagesContainer = document.getElementById('chatMessages'); const aiMessages = messagesContainer.querySelectorAll('.message.assistant'); if (aiMessages.length > 0) { const latestAiMessage = aiMessages[aiMessages.length - 1]; const copyButton = latestAiMessage.querySelector('.copy-button'); if (copyButton) { this.logStep('æµ‹è¯•å¤åˆ¶æŒ‰é’®'); try { copyButton.click(); this.logSuccess('å¤åˆ¶æŒ‰é’®ç‚¹å‡»æˆåŠŸ'); } catch (error) { this.logWarning(`å¤åˆ¶æŒ‰é’®å¤±è´¥: ${error.message}`); } } } } async simulateAdvancedFeatures() { this.logStep('æµ‹è¯•é«˜çº§åŠŸèƒ½'); // æµ‹è¯•é”®ç›˜å¿«æ·é”® const messageInput = document.getElementById('messageInput'); if (messageInput) { this.logStep('æµ‹è¯•Enteré”®å‘é€æ¶ˆæ¯'); messageInput.value = 'è¿™æ˜¯é€šè¿‡Enteré”®å‘é€çš„æµ‹è¯•æ¶ˆæ¯'; messageInput.focus(); // æ¨¡æ‹ŸæŒ‰ä¸‹Enteré”® const enterEvent = new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', keyCode: 13, which: 13, bubbles: true }); messageInput.dispatchEvent(enterEvent); await this.sleep(1000); // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å‘é€ if (messageInput.value === '') { this.logSuccess('Enteré”®å‘é€åŠŸèƒ½æ­£å¸¸'); } else { this.logWarning('Enteré”®å‘é€å¯èƒ½æœªç”Ÿæ•ˆ'); } } // æµ‹è¯•æ§åˆ¶å°å‘½ä»¤ this.logStep('éªŒè¯æ§åˆ¶å°APIå¯ç”¨æ€§'); try { if (typeof manualTestHelper !== 'undefined') { this.logSuccess('æ‰‹åŠ¨æµ‹è¯•åŠ©æ‰‹å¯ç”¨'); } if (typeof window.ComprehensiveTest !== 'undefined') { this.logSuccess('ç»¼åˆæµ‹è¯•ç±»å¯ç”¨'); } if (typeof window.MessageFunctionalityTest !== 'undefined') { this.logSuccess('æ¶ˆæ¯åŠŸèƒ½æµ‹è¯•ç±»å¯ç”¨'); } } catch (error) { this.logWarning(`æ§åˆ¶å°APIæ£€æŸ¥å¤±è´¥: ${error.message}`); } } logStep(message) { this.currentStep++; const timestamp = this.getElapsedTime();  this.testSequence.push({ step: this.currentStep, type: 'step', message, timestamp }); } logSuccess(message) { const timestamp = this.getElapsedTime();  this.testSequence.push({ step: this.currentStep, type: 'success', message, timestamp }); } logWarning(message) { const timestamp = this.getElapsedTime();  this.testSequence.push({ step: this.currentStep, type: 'warning', message, timestamp }); } getElapsedTime() { const elapsed = Date.now() - this.startTime; return `${(elapsed / 1000).toFixed(1)}s`; } async sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); } showFinalResults() { const totalTime = this.getElapsedTime(); console.log('\n' + '='.repeat(60));  console.log('='.repeat(60)); const summary = { steps: this.testSequence.filter(t => t.type === 'step').length, successes: this.testSequence.filter(t => t.type === 'success').length, warnings: this.testSequence.filter(t => t.type === 'warning').length };      const successRate = summary.steps > 0 ? ((summary.successes / (summary.successes + summary.warnings)) * 100).toFixed(1) : 0;   this.testSequence.forEach(item => { const icon = item.type === 'step' ? 'ğŸ”„' : item.type === 'success' ? 'âœ…' : 'âš ï¸';  }); // æœ€ç»ˆè¯„ä¼°  if (summary.warnings === 0) {  } else if (summary.warnings <= 2) {  } else if (summary.warnings <= 4) {  } else {  }       // å»ºè®®ä¸‹ä¸€æ­¥ä¼˜åŒ– if (summary.warnings > 0) {  const warningMessages = this.testSequence .filter(t => t.type === 'warning') .map(t => t.message); warningMessages.forEach((msg, index) => {  }); } } } // è‡ªåŠ¨è¿è¡Œå®Œæ•´ç”¨æˆ·äº¤äº’æµ‹è¯• if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => { setTimeout(async () => { const test = new FinalUserInteractionTest(); await test.runFullUserSimulation(); }, 4000); // ç­‰å¾…4ç§’ç¡®ä¿æ‰€æœ‰ç³»ç»Ÿå’Œæµ‹è¯•å®Œå…¨å°±ç»ª }); } else { setTimeout(async () => { const test = new FinalUserInteractionTest(); await test.runFullUserSimulation(); }, 4000); } // æš´éœ²ä¸ºå…¨å±€å¯¹è±¡ window.FinalUserInteractionTest = FinalUserInteractionTest; // æ·»åŠ æ‰‹åŠ¨è¿è¡Œå‘½ä»¤  console.log('æ‰‹åŠ¨è¿è¡Œ: new FinalUserInteractionTest().runFullUserSimulation()'); 