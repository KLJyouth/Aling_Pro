 class ChatVerificationChecker { constructor() { this.verified = false; this.checking = true; } async checkVerification() { try { const response = await fetch(API_ENDPOINTS.CHECK_VERIFICATION, { method: 'GET', credentials: 'include', // åŒ…å«cookies cache: 'no-cache' }); const data = await response.json(); if (data.verified) { this.verified = true; this.onVerificationSuccess(data); } else { this.verified = false; this.onVerificationFailed(data.reason); } } catch (error) { console.error('éªŒè¯æ£€æŸ¥å¤±è´¥:', error); this.onVerificationError(error); } finally { this.checking = false; } } onVerificationSuccess(data) {  // å…è®¸æ­£å¸¸åŠ è½½èŠå¤©åŠŸèƒ½ this.enableChatFunctionality(); this.hideVerificationOverlay(); } onVerificationFailed(reason) { console.warn('âŒ ç”¨æˆ·æœªé€šè¿‡åˆå§‹åŒ–éªŒè¯:', reason); let message = 'æ‚¨éœ€è¦å®Œæˆç³»ç»Ÿåˆå§‹åŒ–æ£€æµ‹æ‰èƒ½ä½¿ç”¨èŠå¤©åŠŸèƒ½'; if (reason === 'invalid_or_expired') { message = 'æ‚¨çš„éªŒè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°å®Œæˆåˆå§‹åŒ–æ£€æµ‹'; } this.showRedirectMessage(message); } onVerificationError(error) { console.error('ğŸ”¥ éªŒè¯æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error); this.showRedirectMessage('éªŒè¯æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡æ–°è¿›è¡Œåˆå§‹åŒ–æ£€æµ‹'); } enableChatFunctionality() { // ç§»é™¤æ‰€æœ‰æµ‹è¯•è„šæœ¬ this.removeTestScripts(); // æ˜¾ç¤ºèŠå¤©ç•Œé¢ const chatContainer = document.getElementById('chatContainer'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); if (chatContainer) chatContainer.style.display = 'block'; if (messageInput) messageInput.disabled = false; if (sendButton) sendButton.disabled = false; // å¯ç”¨æ‰€æœ‰èŠå¤©åŠŸèƒ½ document.body.classList.add('chat-verified'); document.body.classList.remove('chat-pending');  } removeTestScripts() { // ç§»é™¤æ‰€æœ‰æµ‹è¯•ç›¸å…³çš„è„šæœ¬ const testScripts = [ 'comprehensive-test.js', 'message-functionality-test.js', 'final-user-interaction-test.js', 'browser-functionality-test.js', 'deep-diagnostics.js' ]; testScripts.forEach(scriptName => { const scripts = document.querySelectorAll(`script[src*="${scriptName}"]`); scripts.forEach(script => { script.remove();  }); }); // æ¸…ç†å…¨å±€æµ‹è¯•å¯¹è±¡ if (window.browserTestResults) delete window.browserTestResults; if (window.diagnosticReport) delete window.diagnosticReport; if (window.chatTestResults) delete window.chatTestResults; } showRedirectMessage(message) { // åˆ›å»ºé‡å®šå‘è¦†ç›–å±‚ const overlay = document.createElement('div'); overlay.id = 'verificationOverlay'; overlay.innerHTML = ` <div class="verification-overlay"> <div class="verification-content"> <div class="verification-icon"> <i class="bi bi-shield-exclamation"></i> </div> <h3>éœ€è¦åˆå§‹åŒ–éªŒè¯</h3> <p>${message}</p> <div class="verification-actions"> <button onclick="window.redirectToInit()" class="btn btn-primary"> <i class="bi bi-arrow-right"></i> å‰å¾€éªŒè¯ </button> <button onclick="location.reload()" class="btn btn-outline-secondary"> <i class="bi bi-arrow-clockwise"></i> é‡æ–°æ£€æŸ¥ </button> </div> </div> </div> <style> .verification-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; } .verification-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); } .verification-icon { font-size: 4rem; color: #ffc107; margin-bottom: 20px; } .verification-content h3 { color: #333; margin-bottom: 15px; } .verification-content p { color: #666; margin-bottom: 30px; line-height: 1.6; } .verification-actions { display: flex; gap: 15px; justify-content: center; } .btn { padding: 12px 24px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; } .btn-outline-secondary { background: transparent; border: 2px solid #6c757d; color: #6c757d; } .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); } </style> `; document.body.appendChild(overlay); // æ·»åŠ é‡å®šå‘å‡½æ•°åˆ°å…¨å±€ window.redirectToInit = () => { window.location.href = '/init.html'; }; // ç¦ç”¨èŠå¤©åŠŸèƒ½ this.disableChatFunctionality(); } hideVerificationOverlay() { const overlay = document.getElementById('verificationOverlay'); if (overlay) { overlay.remove(); } } disableChatFunctionality() { // éšè—æˆ–ç¦ç”¨èŠå¤©ç•Œé¢ const chatContainer = document.getElementById('chatContainer'); const messageInput = document.getElementById('messageInput'); const sendButton = document.getElementById('sendButton'); if (chatContainer) chatContainer.style.display = 'none'; if (messageInput) messageInput.disabled = true; if (sendButton) sendButton.disabled = true; document.body.classList.add('chat-pending'); document.body.classList.remove('chat-verified'); } showLoadingState() { // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ const loadingOverlay = document.createElement('div'); loadingOverlay.id = 'loadingOverlay'; loadingOverlay.innerHTML = ` <div class="loading-overlay"> <div class="loading-content"> <div class="spinner-border text-primary" role="status"> <span class="visually-hidden">Loading...</span> </div> <p class="mt-3">æ­£åœ¨éªŒè¯ç”¨æˆ·çŠ¶æ€...</p> </div> </div> <style> .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; } .loading-content { text-align: center; } .loading-content p { color: #666; margin: 0; } </style> `; document.body.appendChild(loadingOverlay); } hideLoadingState() { const overlay = document.getElementById('loadingOverlay'); if (overlay) { overlay.remove(); } } } // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥éªŒè¯çŠ¶æ€ document.addEventListener('DOMContentLoaded', async function() {  const checker = new ChatVerificationChecker(); // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ checker.showLoadingState(); // æ‰§è¡ŒéªŒè¯æ£€æŸ¥ await checker.checkVerification(); // éšè—åŠ è½½çŠ¶æ€ checker.hideLoadingState(); // å°†æ£€æŸ¥å™¨æš´éœ²åˆ°å…¨å±€ä¾›è°ƒè¯• window.chatVerificationChecker = checker; }); 