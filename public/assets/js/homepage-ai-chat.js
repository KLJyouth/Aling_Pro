 // é¦–é¡µAIèŠå¤©ç³»ç»Ÿ - çœŸå®APIé›†æˆç‰ˆæœ¬ // åˆ›å»ºæ—¶é—´: 2025-06-06 // ç‰ˆæœ¬: 2.0.0 - æ›¿æ¢localStorageä¸ºçœŸå®æ•°æ®åº“API  class HomepageAIChat { constructor() { this.isInitialized = false; this.chatHistory = []; this.isTyping = false; this.currentTypingEffect = null; this.currentSessionId = null; this.apiEndpoints = { sendMessage: '/api/v1/chat/sessions', getSessions: '/api/v1/chat/sessions', createSession: '/api/v1/chat/sessions', getMessages: '/api/v1/chat/sessions/{id}/messages', saveMessage: '/api/v1/chat/messages', auth: '/api/v1/auth' }; this.currentUser = null; this.isAuthenticated = false; this.init(); } async init() { if (this.isInitialized) return; // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€ await this.checkAuthStatus(); this.setupEventListeners(); await this.loadChatHistory(); this.isInitialized = true;  } async checkAuthStatus() { try { const token = localStorage.getItem('auth_token'); if (!token) { this.isAuthenticated = false; return; } const response = await fetch(`${this.apiEndpoints.auth}/me`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } }); if (response.ok) { this.currentUser = await response.json(); this.isAuthenticated = true;  } else { this.isAuthenticated = false; localStorage.removeItem('auth_token'); } } catch (error) { console.warn('è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨è®¿å®¢æ¨¡å¼:', error); this.isAuthenticated = false; } } setupEventListeners() { // AIåŠ©æ‰‹æµ®åŠ¨æŒ‰é’® const aiBtn = document.getElementById('aiAssistantBtn'); if (aiBtn) { aiBtn.addEventListener('click', () => this.toggleChatWidget()); } // èŠå¤©çª—å£æ§åˆ¶ const closeChatBtn = document.getElementById('closeChatWidget'); if (closeChatBtn) { closeChatBtn.addEventListener('click', () => this.hideChatWidget()); } // å‘é€æ¶ˆæ¯ const sendBtn = document.getElementById('sendChatMessage'); const chatInput = document.getElementById('chatInput'); if (sendBtn) { sendBtn.addEventListener('click', () => this.sendMessage()); } if (chatInput) { chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); } }); // è¾“å…¥ç›‘å¬ chatInput.addEventListener('input', () => { this.updateSendButton(); }); } // å¿«æ·æ“ä½œæŒ‰é’® document.querySelectorAll('.quick-action-btn').forEach(btn => { btn.addEventListener('click', (e) => { const text = e.target.textContent; this.sendQuickMessage(text); }); }); // è¯­éŸ³è¾“å…¥ const voiceBtn = document.getElementById('voiceInputBtn'); if (voiceBtn) { voiceBtn.addEventListener('click', () => this.startVoiceInput()); } // è¡¨æƒ…æŒ‰é’® const emojiBtn = document.getElementById('emojiBtn'); if (emojiBtn) { emojiBtn.addEventListener('click', () => this.showEmojiPanel()); } } toggleChatWidget() { const chatWidget = document.getElementById('chatWidget'); if (!chatWidget) return; const isHidden = chatWidget.classList.contains('hidden'); if (isHidden) { this.showChatWidget(); } else { this.hideChatWidget(); } } showChatWidget() { const chatWidget = document.getElementById('chatWidget'); const aiBtn = document.getElementById('aiAssistantBtn'); if (chatWidget) { chatWidget.classList.remove('hidden'); setTimeout(() => { chatWidget.classList.remove('scale-95', 'opacity-0'); chatWidget.classList.add('scale-100', 'opacity-100'); }, 10); } if (aiBtn) { aiBtn.style.transform = 'scale(0.8)'; } // èšç„¦è¾“å…¥æ¡† const chatInput = document.getElementById('chatInput'); if (chatInput) { setTimeout(() => chatInput.focus(), 300); }  } hideChatWidget() { const chatWidget = document.getElementById('chatWidget'); const aiBtn = document.getElementById('aiAssistantBtn'); if (chatWidget) { chatWidget.classList.add('scale-95', 'opacity-0'); chatWidget.classList.remove('scale-100', 'opacity-100'); setTimeout(() => { chatWidget.classList.add('hidden'); }, 300); } if (aiBtn) { aiBtn.style.transform = 'scale(1)'; }  } async sendMessage() { const chatInput = document.getElementById('chatInput'); if (!chatInput) return; const message = chatInput.value.trim(); if (!message || this.isTyping) return; // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ this.addMessage(message, 'user'); chatInput.value = ''; this.updateSendButton(); // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥ this.showTypingIndicator(); try { // ç¡®ä¿æœ‰ä¼šè¯ID if (!this.currentSessionId) { await this.createNewSession(); } // å‘é€æ¶ˆæ¯åˆ°çœŸå®API const response = await this.sendMessageToAPI(message); this.hideTypingIndicator(); if (response.success) { this.addMessage(response.data.response || response.data.content, 'ai'); // æ›´æ–°ä¼šè¯ä¿¡æ¯ if (response.data.session_id) { this.currentSessionId = response.data.session_id; } } else { this.addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + (response.error || 'è¯·ç¨åå†è¯•'), 'ai', true); } // ä¿å­˜èŠå¤©å†å²åˆ°æ•°æ®åº“ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰ } catch (error) { this.hideTypingIndicator(); this.addMessage('æŠ±æ­‰ï¼Œè¿æ¥æœåŠ¡å™¨å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚', 'ai', true); console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error); } } async createNewSession() { try { const headers = { 'Content-Type': 'application/json' }; // å¦‚æœå·²è®¤è¯ï¼Œæ·»åŠ token if (this.isAuthenticated) { const token = localStorage.getItem('auth_token'); if (token) { headers['Authorization'] = `Bearer ${token}`; } } const response = await fetch(this.apiEndpoints.createSession, { method: 'POST', headers, body: JSON.stringify({ title: 'é¦–é¡µèŠå¤©ä¼šè¯', model: 'deepseek-chat' }) }); const data = await response.json(); if (data.success && data.data.id) { this.currentSessionId = data.data.id;  } } catch (error) { console.warn('åˆ›å»ºä¼šè¯å¤±è´¥:', error); } } async sendMessageToAPI(message) { const headers = { 'Content-Type': 'application/json' }; // å¦‚æœå·²è®¤è¯ï¼Œæ·»åŠ token if (this.isAuthenticated) { const token = localStorage.getItem('auth_token'); if (token) { headers['Authorization'] = `Bearer ${token}`; } } const endpoint = this.currentSessionId ? `${this.apiEndpoints.sendMessage}/${this.currentSessionId}/messages` : this.apiEndpoints.createSession; const body = this.currentSessionId ? { message, timestamp: Date.now() } : { title: 'é¦–é¡µèŠå¤©ä¼šè¯', model: 'deepseek-chat', first_message: message, timestamp: Date.now() }; const response = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(body) }); const data = await response.json(); // å¦‚æœæ˜¯æ–°ä¼šè¯ä¸”æˆåŠŸåˆ›å»ºï¼Œæ›´æ–°ä¼šè¯ID if (!this.currentSessionId && data.success && data.data.id) { this.currentSessionId = data.data.id; } return data; } sendQuickMessage(text) { const chatInput = document.getElementById('chatInput'); if (chatInput) { chatInput.value = text; this.sendMessage(); } } addMessage(content, sender, isError = false) { const chatMessages = document.getElementById('chatMessages'); if (!chatMessages) return; const messageDiv = document.createElement('div'); messageDiv.className = 'flex items-start space-x-2 message-item'; const isUser = sender === 'user'; const timestamp = new Date().toLocaleTimeString(); messageDiv.innerHTML = ` <div class="w-6 h-6 rounded-full flex items-center justify-center flex-shrink-0 ${ isUser ? 'bg-blue-500' : 'bg-gradient-to-r from-longling to-tech-blue' }"> <i class="fas ${isUser ? 'fa-user' : 'fa-robot'} text-xs"></i> </div> <div class="bg-gray-800/50 rounded-lg p-3 text-sm max-w-xs ${isError ? 'border border-red-500/20' : ''}"> <p class="${isError ? 'text-red-400' : ''}">${content}</p> <div class="text-xs text-gray-500 mt-1"> <span>${timestamp}</span> </div> </div> `; // åŠ¨ç”»æ•ˆæœ messageDiv.style.opacity = '0'; messageDiv.style.transform = 'translateY(10px)'; chatMessages.appendChild(messageDiv); // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡ const messageObj = { content, sender, timestamp: new Date().toISOString(), isError }; // æ·»åŠ åˆ°å†å²è®°å½• this.chatHistory.push(messageObj); // å¦‚æœç”¨æˆ·å·²è®¤è¯ä¸”æœ‰å½“å‰ä¼šè¯ï¼Œä¿å­˜åˆ°æ•°æ®åº“ if (this.isAuthenticated && this.currentSessionId && !isError) { this.saveMessageToDatabase(messageObj); } else { // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½ this.saveChatToLocalStorage(); } // åŠ¨ç”»æ˜¾ç¤º setTimeout(() => { messageDiv.style.transition = 'all 0.3s ease'; messageDiv.style.opacity = '1'; messageDiv.style.transform = 'translateY(0)'; }, 10); // æ»šåŠ¨åˆ°åº•éƒ¨ this.scrollToBottom(); } // ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“ async saveMessageToDatabase(messageObj) { try { const token = localStorage.getItem('auth_token'); if (!token) return; const response = await fetch(this.apiEndpoints.saveMessage, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ session_id: this.currentSessionId, role: messageObj.sender === 'user' ? 'user' : 'assistant', content: messageObj.content, timestamp: messageObj.timestamp }) }); if (!response.ok) { console.warn('Failed to save message to database, using localStorage fallback'); this.saveChatToLocalStorage(); } } catch (error) { console.warn('Error saving message to database:', error); this.saveChatToLocalStorage(); } } // ä¿å­˜èŠå¤©åˆ°æœåŠ¡å™¨æˆ–æœ¬åœ°å­˜å‚¨ï¼ˆæ™ºèƒ½å­˜å‚¨æ–¹æ¡ˆï¼‰ async saveChatToStorage() { try { // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€ const isAuthenticated = await this.checkAuthentication(); if (isAuthenticated) { // è®¤è¯ç”¨æˆ·ï¼šä¿å­˜åˆ°API await this.saveChatToServer(); } else { // è®¿å®¢ç”¨æˆ·ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ this.saveChatToLocalStorage(); } } catch (error) { console.warn('Failed to save chat:', error); // APIå¤±è´¥æ—¶å›é€€åˆ°æœ¬åœ°å­˜å‚¨ this.saveChatToLocalStorage(); } } // ä¿å­˜èŠå¤©åˆ°æœåŠ¡å™¨ async saveChatToServer() { try { if (this.chatHistory.length === 0) return; const response = await fetch('/api/v1/chat/conversations', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ title: `é¦–é¡µèŠå¤© - ${new Date().toLocaleString()}`, messages: this.chatHistory, source: 'homepage' }) }); if (!response.ok) { throw new Error(`Server response: ${response.status}`); } const result = await response.json(); if (result.success) {  return result; } else { throw new Error(result.message || 'ä¿å­˜å¤±è´¥'); } } catch (error) { console.error('ä¿å­˜èŠå¤©åˆ°æœåŠ¡å™¨å¤±è´¥:', error); throw error; } } // ä¿å­˜èŠå¤©åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¤‡ä»½æ–¹æ¡ˆï¼‰ saveChatToLocalStorage() { try { localStorage.setItem('homepage-chat-history', JSON.stringify(this.chatHistory));  } catch (error) { console.warn('Failed to save chat to localStorage:', error); } } // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€ async checkAuthentication() { try { const response = await fetch('/api/v1/auth/check', { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } }); if (response.ok) { const result = await response.json(); return result.success && result.data?.authenticated; } } catch (error) { console.warn('è®¤è¯æ£€æŸ¥å¤±è´¥:', error); } return false; } showTypingIndicator() { if (this.isTyping) return; this.isTyping = true; const chatMessages = document.getElementById('chatMessages'); if (!chatMessages) return; const typingDiv = document.createElement('div'); typingDiv.id = 'typingIndicator'; typingDiv.className = 'flex items-start space-x-2'; typingDiv.innerHTML = ` <div class="w-6 h-6 rounded-full bg-gradient-to-r from-longling to-tech-blue flex items-center justify-center flex-shrink-0"> <i class="fas fa-robot text-xs"></i> </div> <div class="bg-gray-800/50 rounded-lg p-3 text-sm"> <div class="flex space-x-1"> <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div> <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div> <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div> </div> <div class="text-xs text-gray-500 mt-1">AIæ­£åœ¨æ€è€ƒä¸­...</div> </div> `; chatMessages.appendChild(typingDiv); this.scrollToBottom(); } hideTypingIndicator() { this.isTyping = false; const typingIndicator = document.getElementById('typingIndicator'); if (typingIndicator) { typingIndicator.remove(); } } async getAIResponse(message) { // æ¨¡æ‹ŸAIå“åº”å»¶è¿Ÿ await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000)); // æ™ºèƒ½å“åº”é€»è¾‘ const responses = this.generateSmartResponse(message); return responses[Math.floor(Math.random() * responses.length)]; } generateSmartResponse(message) { const msg = message.toLowerCase(); // äº§å“ç›¸å…³ if (msg.includes('äº§å“') || msg.includes('æœåŠ¡')) { return [ 'ç‘å‡Œç§‘æŠ€ä¸“æ³¨äºé‡å­å®‰å…¨æŠ€æœ¯ï¼Œæä¾›ä¼ä¸šçº§åŠ å¯†è§£å†³æ–¹æ¡ˆã€‚æˆ‘ä»¬çš„äº§å“åŒ…æ‹¬é‡å­å¯†é’¥åˆ†å‘ã€åé‡å­åŠ å¯†ç®—æ³•ç­‰ã€‚', 'æˆ‘ä»¬çš„æ ¸å¿ƒäº§å“åŒ…æ‹¬é‡å­å®‰å…¨é€šä¿¡å¹³å°ã€æ™ºèƒ½å¨èƒæ£€æµ‹ç³»ç»Ÿï¼Œä»¥åŠä¼ä¸šçº§æ•°æ®ä¿æŠ¤è§£å†³æ–¹æ¡ˆã€‚æ‚¨å¯¹å“ªä¸ªæ–¹é¢æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Ÿ', 'ç‘å‡Œç§‘æŠ€çš„äº§å“çŸ©é˜µæ¶µç›–äº†ä»åº•å±‚åŠ å¯†åˆ°æ™ºèƒ½å†³ç­–çš„å…¨æ ˆè§£å†³æ–¹æ¡ˆã€‚éœ€è¦æˆ‘è¯¦ç»†ä»‹ç»æŸä¸ªç‰¹å®šäº§å“å—ï¼Ÿ' ]; } // æŠ€æœ¯ç›¸å…³ if (msg.includes('æŠ€æœ¯') || msg.includes('é‡å­') || msg.includes('å®‰å…¨')) { return [ 'æˆ‘ä»¬åœ¨é‡å­å¯†ç å­¦ã€åé‡å­åŠ å¯†ã€ä»¥åŠAIå®‰å…¨ç­‰é¢†åŸŸæ‹¥æœ‰å…ˆè¿›æŠ€æœ¯ã€‚è¿™äº›æŠ€æœ¯ç¡®ä¿æ‚¨çš„æ•°æ®åœ¨é‡å­è®¡ç®—æ—¶ä»£ä»ç„¶å®‰å…¨ã€‚', 'ç‘å‡Œç§‘æŠ€çš„é‡å­å®‰å…¨æŠ€æœ¯åŸºäºæœ€æ–°çš„å¯†ç å­¦ç ”ç©¶ï¼Œèƒ½å¤ŸæŠµå¾¡ä¼ ç»Ÿå’Œé‡å­è®¡ç®—æ”»å‡»ã€‚æ‚¨æƒ³äº†è§£å…·ä½“çš„æŠ€æœ¯å®ç°å—ï¼Ÿ', 'æˆ‘ä»¬çš„æŠ€æœ¯æ ˆåŒ…æ‹¬é‡å­éšæœºæ•°ç”Ÿæˆã€é‡å­å¯†é’¥åˆ†å‘åè®®ã€ä»¥åŠè‡ªé€‚åº”å®‰å…¨ç®—æ³•ã€‚è¿™äº›æŠ€æœ¯çš„ç»“åˆä¸ºå®¢æˆ·æä¾›äº†å‰æ‰€æœªæœ‰çš„å®‰å…¨ä¿éšœã€‚' ]; } // å•†åŠ¡åˆä½œ if (msg.includes('åˆä½œ') || msg.includes('å•†åŠ¡') || msg.includes('è”ç³»')) { return [ 'æ„Ÿè°¢æ‚¨å¯¹ç‘å‡Œç§‘æŠ€çš„å…³æ³¨ï¼æˆ‘ä»¬çš„å•†åŠ¡å›¢é˜Ÿå¾ˆä¹æ„ä¸æ‚¨æ¢è®¨åˆä½œæœºä¼šã€‚æ‚¨å¯ä»¥é€šè¿‡å®˜ç½‘è”ç³»è¡¨å•æˆ–ç›´æ¥è”ç³»æˆ‘ä»¬çš„å•†åŠ¡ä»£è¡¨ã€‚', 'æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„åˆä½œä¼™ä¼´å…³ç³»ã€‚æ— è®ºæ˜¯æŠ€æœ¯é›†æˆã€æ¸ é“åˆä½œè¿˜æ˜¯æˆ˜ç•¥è”ç›Ÿï¼Œæˆ‘ä»¬éƒ½æœ‰ä¸“ä¸šçš„å›¢é˜Ÿä¸ºæ‚¨æä¾›æ”¯æŒã€‚', 'ç‘å‡Œç§‘æŠ€æ­£åœ¨å¯»æ±‚ä¸å„è¡Œä¸šé¢†å…ˆä¼ä¸šçš„åˆä½œã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚ï¼Œæˆ‘ä¼šä¸ºæ‚¨å®‰æ’åˆé€‚çš„å¯¹æ¥äººå‘˜ã€‚' ]; } // ä»·æ ¼ç›¸å…³ if (msg.includes('ä»·æ ¼') || msg.includes('è´¹ç”¨') || msg.includes('æˆæœ¬')) { return [ 'æˆ‘ä»¬æä¾›çµæ´»çš„å®šä»·æ–¹æ¡ˆï¼Œæ ¹æ®ä¼ä¸šè§„æ¨¡å’Œå…·ä½“éœ€æ±‚å®šåˆ¶ã€‚å»ºè®®æ‚¨è”ç³»æˆ‘ä»¬çš„é”€å”®å›¢é˜Ÿè·å–è¯¦ç»†æŠ¥ä»·ã€‚', 'ç‘å‡Œç§‘æŠ€çš„è§£å†³æ–¹æ¡ˆé‡‡ç”¨è®¢é˜…åˆ¶å’Œä¸€æ¬¡æ€§æˆæƒç›¸ç»“åˆçš„æ¨¡å¼ã€‚å…·ä½“ä»·æ ¼å–å†³äºéƒ¨ç½²è§„æ¨¡å’ŒæœåŠ¡ç­‰çº§ã€‚', 'æˆ‘ä»¬ç†è§£æˆæœ¬æ˜¯ä¼ä¸šå†³ç­–çš„é‡è¦å› ç´ ã€‚æˆ‘ä»¬çš„å®šä»·ç­–ç•¥æ³¨é‡ä¸ºå®¢æˆ·æä¾›æœ€é«˜çš„æ€§ä»·æ¯”ï¼Œè¯¦æƒ…è¯·å’¨è¯¢é”€å”®å›¢é˜Ÿã€‚' ]; } // é—®å€™å’Œæ„Ÿè°¢ if (msg.includes('ä½ å¥½') || msg.includes('hello') || msg.includes('hi')) { return [ 'æ‚¨å¥½ï¼æ¬¢è¿æ¥åˆ°ç‘å‡Œç§‘æŠ€ã€‚æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ', 'æ‚¨å¥½ï¼æˆ‘æ˜¯ç‘å‡Œç§‘æŠ€çš„æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥ä¸ºæ‚¨ä»‹ç»æˆ‘ä»¬çš„äº§å“ã€æŠ€æœ¯æˆ–è§£ç­”å…¶ä»–é—®é¢˜ã€‚è¯·éšæ—¶å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ã€‚', 'Hiï¼æ„Ÿè°¢æ‚¨å¯¹ç‘å‡Œç§‘æŠ€çš„å…³æ³¨ã€‚æˆ‘ä¼šå°½æˆ‘æ‰€èƒ½ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚æ‚¨æƒ³äº†è§£æˆ‘ä»¬çš„ä»€ä¹ˆæ–¹é¢å‘¢ï¼Ÿ' ]; } if (msg.includes('è°¢è°¢') || msg.includes('æ„Ÿè°¢') || msg.includes('thank')) { return [ 'ä¸å®¢æ°”ï¼å¾ˆé«˜å…´èƒ½ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚', 'æ‚¨å¤ªå®¢æ°”äº†ï¼ä¸ºæ‚¨æœåŠ¡æ˜¯æˆ‘çš„è£å¹¸ã€‚ç‘å‡Œç§‘æŠ€éšæ—¶ä¸ºæ‚¨æä¾›æ”¯æŒã€‚', 'æ„Ÿè°¢æ‚¨çš„è®¤å¯ï¼æˆ‘ä»¬å§‹ç»ˆè‡´åŠ›äºä¸ºå®¢æˆ·æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡ä½“éªŒã€‚' ]; } // é»˜è®¤å“åº” return [ 'è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ã€‚åŸºäºæˆ‘å¯¹ç‘å‡Œç§‘æŠ€çš„äº†è§£ï¼Œæˆ‘å»ºè®®æ‚¨å¯ä»¥è¿›ä¸€æ­¥äº†è§£æˆ‘ä»¬çš„äº§å“å’ŒæœåŠ¡ã€‚éœ€è¦æˆ‘ä¸ºæ‚¨è¯¦ç»†ä»‹ç»å—ï¼Ÿ', 'æ„Ÿè°¢æ‚¨çš„è¯¢é—®ã€‚ç‘å‡Œç§‘æŠ€åœ¨é‡å­å®‰å…¨é¢†åŸŸæœ‰ä¸°å¯Œçš„ç»éªŒå’Œå…ˆè¿›çš„æŠ€æœ¯ã€‚æ‚¨å¯ä»¥æµè§ˆæˆ‘ä»¬çš„å®˜ç½‘äº†è§£æ›´å¤šä¿¡æ¯ï¼Œæˆ–è€…ç›´æ¥ä¸æˆ‘ä»¬çš„ä¸“å®¶å›¢é˜Ÿè”ç³»ã€‚', 'æ‚¨æå‡ºäº†ä¸€ä¸ªå¾ˆå¥½çš„è§‚ç‚¹ã€‚ä½œä¸ºé‡å­å®‰å…¨é¢†åŸŸçš„é¢†å¯¼è€…ï¼Œç‘å‡Œç§‘æŠ€ä¸€ç›´åœ¨ä¸æ–­åˆ›æ–°å’Œå®Œå–„æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆã€‚æœ‰ä»€ä¹ˆå…·ä½“é—®é¢˜æˆ‘å¯ä»¥ä¸ºæ‚¨è§£ç­”å—ï¼Ÿ', 'æˆ‘ç†è§£æ‚¨çš„å…³æ³¨ã€‚ç‘å‡Œç§‘æŠ€è‡´åŠ›äºä¸ºå®¢æˆ·æä¾›æœ€ä½³çš„é‡å­å®‰å…¨è§£å†³æ–¹æ¡ˆã€‚å¦‚æœæ‚¨éœ€è¦æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨å®‰æ’ä¸“ä¸šé¡¾é—®çš„å’¨è¯¢ã€‚' ]; } updateSendButton() { const chatInput = document.getElementById('chatInput'); const sendBtn = document.getElementById('sendChatMessage'); if (chatInput && sendBtn) { const hasContent = chatInput.value.trim().length > 0; sendBtn.disabled = !hasContent || this.isTyping; sendBtn.style.opacity = hasContent && !this.isTyping ? '1' : '0.5'; } } scrollToBottom() { const chatMessages = document.getElementById('chatMessages'); if (chatMessages) { chatMessages.scrollTop = chatMessages.scrollHeight; } } startVoiceInput() { // è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼ˆéœ€è¦æµè§ˆå™¨æ”¯æŒï¼‰ if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const recognition = new SpeechRecognition(); recognition.lang = 'zh-CN'; recognition.continuous = false; recognition.interimResults = false; recognition.onstart = () => {  const voiceBtn = document.getElementById('voiceInputBtn'); if (voiceBtn) { voiceBtn.innerHTML = '<i class="fas fa-stop text-xs"></i>'; voiceBtn.style.color = '#ef4444'; } }; recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; const chatInput = document.getElementById('chatInput'); if (chatInput) { chatInput.value = transcript; this.updateSendButton(); } }; recognition.onend = () => {  const voiceBtn = document.getElementById('voiceInputBtn'); if (voiceBtn) { voiceBtn.innerHTML = '<i class="fas fa-microphone text-xs"></i>'; voiceBtn.style.color = ''; } }; recognition.onerror = (event) => { console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error); }; recognition.start(); } else { alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½'); } } showEmojiPanel() { // ç®€å•çš„è¡¨æƒ…é¢æ¿å®ç° const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'ğŸ’¯', 'ğŸ‰', 'ğŸ˜', 'ğŸš€']; const existingPanel = document.getElementById('emojiPanel'); if (existingPanel) { existingPanel.remove(); return; } const panel = document.createElement('div'); panel.id = 'emojiPanel'; panel.className = 'absolute bottom-full right-0 mb-2 p-2 bg-gray-800 rounded-lg shadow-lg grid grid-cols-5 gap-1'; panel.style.zIndex = '1000'; emojis.forEach(emoji => { const btn = document.createElement('button'); btn.textContent = emoji; btn.className = 'p-2 hover:bg-gray-700 rounded text-lg'; btn.onclick = () => { const chatInput = document.getElementById('chatInput'); if (chatInput) { chatInput.value += emoji; this.updateSendButton(); } panel.remove(); }; panel.appendChild(btn); }); const emojiBtn = document.getElementById('emojiBtn'); if (emojiBtn) { emojiBtn.parentElement.style.position = 'relative'; emojiBtn.parentElement.appendChild(panel); } // ç‚¹å‡»å¤–éƒ¨å…³é—­ setTimeout(() => { document.addEventListener('click', function closePanel(e) { if (!panel.contains(e.target) && e.target.id !== 'emojiBtn') { panel.remove(); document.removeEventListener('click', closePanel); } }); }, 0); } async loadChatHistory() { try { // å¦‚æœç”¨æˆ·å·²è®¤è¯ï¼Œä»æ•°æ®åº“åŠ è½½å†å² if (this.isAuthenticated) { await this.loadChatHistoryFromAPI(); } else { // è®¿å®¢æ¨¡å¼ï¼šå°è¯•ä»localStorageåŠ è½½ä¸´æ—¶å†å² this.loadChatHistoryFromLocalStorage(); } } catch (error) { console.warn('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error); // é™çº§åˆ°localStorage this.loadChatHistoryFromLocalStorage(); } } async loadChatHistoryFromAPI() { try { const token = localStorage.getItem('auth_token'); if (!token) return; const response = await fetch(this.apiEndpoints.getSessions, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } }); const data = await response.json(); if (data.success && data.data && data.data.length > 0) { // è·å–æœ€è¿‘çš„ä¼šè¯ const recentSession = data.data[0]; this.currentSessionId = recentSession.id; // åŠ è½½è¯¥ä¼šè¯çš„æ¶ˆæ¯ await this.loadSessionMessages(recentSession.id);  } } catch (error) { console.warn('ä»APIåŠ è½½èŠå¤©å†å²å¤±è´¥:', error); } } async loadSessionMessages(sessionId) { try { const token = localStorage.getItem('auth_token'); const response = await fetch( this.apiEndpoints.getMessages.replace('{id}', sessionId), { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } } ); const data = await response.json(); if (data.success && data.data) { // æ˜¾ç¤ºæœ€è¿‘çš„5æ¡æ¶ˆæ¯ const recentMessages = data.data.slice(-5); recentMessages.forEach(msg => { this.addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai', false, false); }); } } catch (error) { console.warn('åŠ è½½ä¼šè¯æ¶ˆæ¯å¤±è´¥:', error); } } async loadChatHistoryFromStorage() { try { const isAuthenticated = await this.checkAuthentication(); if (isAuthenticated) { // è®¤è¯ç”¨æˆ·ï¼šå°è¯•ä»APIåŠ è½½ const loaded = await this.loadChatHistoryFromServer(); if (loaded) return; } // æœªè®¤è¯ç”¨æˆ·æˆ–APIå¤±è´¥ï¼šä»æœ¬åœ°å­˜å‚¨åŠ è½½ this.loadChatHistoryFromLocalStorage(); } catch (error) { console.warn('åŠ è½½èŠå¤©å†å²å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨:', error); this.loadChatHistoryFromLocalStorage(); } } async loadChatHistoryFromServer() { try { const response = await fetch('/api/v1/chat/conversations?source=homepage&limit=1', { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } }); if (response.ok) { const result = await response.json(); if (result.success && result.data && result.data.length > 0) { const conversation = result.data[0]; if (conversation.messages && conversation.messages.length > 0) { this.chatHistory = conversation.messages; // é‡æ–°æ˜¾ç¤ºå†å²æ¶ˆæ¯ conversation.messages.forEach(msg => { if (!msg.isError) { this.addMessage(msg.content, msg.sender, false, false); } });  return true; } } } } catch (error) { console.warn('ä»æœåŠ¡å™¨åŠ è½½èŠå¤©å†å²å¤±è´¥:', error); } return false; } loadChatHistoryFromLocalStorage() { try { const saved = localStorage.getItem('homepage-chat-history'); if (saved) { this.chatHistory = JSON.parse(saved); // é‡æ–°æ˜¾ç¤ºæœ€è¿‘çš„å‡ æ¡æ¶ˆæ¯ const recentMessages = this.chatHistory.slice(-5); recentMessages.forEach(msg => { if (!msg.isError) { this.addMessage(msg.content, msg.sender, false, false); } });  } } catch (error) { console.warn('ä»localStorageåŠ è½½èŠå¤©å†å²å¤±è´¥:', error); } } async saveChatHistory() { // ä½¿ç”¨æ™ºèƒ½å­˜å‚¨æ–¹æ¡ˆ await this.saveChatToStorage(); } async clearHistory() { this.chatHistory = []; const chatMessages = document.getElementById('chatMessages'); if (chatMessages) { // ä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼Œæ¸…é™¤å…¶ä»–æ¶ˆæ¯ chatMessages.innerHTML = ` <div class="flex items-start space-x-2"> <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0"> <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"> <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path> </svg> </div> <div class="flex-1"> <p class="text-sm text-gray-600">æ‚¨å¥½ï¼æˆ‘æ˜¯ç‘å‡Œç§‘æŠ€çš„AIæ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨äº†è§£æˆ‘ä»¬çš„äº§å“å’ŒæœåŠ¡ã€å›ç­”æŠ€æœ¯é—®é¢˜ã€æä¾›è§£å†³æ–¹æ¡ˆå»ºè®®ç­‰ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥ä¸ºæ‚¨æ•ˆåŠ³çš„å—ï¼Ÿ</p> </div> </div> `; } try { const isAuthenticated = await this.checkAuthentication(); if (isAuthenticated) { // è®¤è¯ç”¨æˆ·ï¼šæ¸…é™¤æœåŠ¡å™¨ç«¯æ•°æ® await this.clearHistoryFromServer(); } // æ¸…é™¤æœ¬åœ°å­˜å‚¨ï¼ˆæ— è®ºè®¤è¯çŠ¶æ€ï¼‰ localStorage.removeItem('homepage-chat-history'); localStorage.removeItem('chatHistory'); // æ¸…ç†æ—§çš„å­˜å‚¨é”®  } catch (error) { console.warn('æ¸…ç©ºèŠå¤©å†å²æ—¶å‡ºé”™:', error); // ç¡®ä¿æœ¬åœ°å­˜å‚¨è¢«æ¸…ç† localStorage.removeItem('homepage-chat-history'); localStorage.removeItem('chatHistory'); } } // ä»æœåŠ¡å™¨æ¸…é™¤èŠå¤©å†å² async clearHistoryFromServer() { try { const response = await fetch('/api/v1/chat/conversations?source=homepage', { method: 'DELETE', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' } }); if (response.ok) { const result = await response.json(); if (result.success) {  return true; } } } catch (error) { console.warn('æ¸…ç©ºæœåŠ¡å™¨ç«¯èŠå¤©å†å²å¤±è´¥:', error); } return false; } } // åˆå§‹åŒ–é¦–é¡µAIå¯¹è¯ç³»ç»Ÿ document.addEventListener('DOMContentLoaded', () => { window.homepageAIChat = new HomepageAIChat(); }); // å¯¼å‡º window.HomepageAIChat = HomepageAIChat; 