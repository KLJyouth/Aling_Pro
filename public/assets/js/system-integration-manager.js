 class SystemIntegrationManager { constructor() { this.systems = new Map(); this.initialized = false; this.status = 'initializing'; this.config = { enableAudio: true, enableGestures: true, enableDataVisualization: true, enableSocialFeatures: true, enablePerformanceMonitoring: true, autoOptimize: true, debugMode: false }; this.systemDependencies = { 'audio': [], 'gestures': ['audio'], 'dataVisualization': ['performance'], 'social': ['audio', 'gestures'], 'performance': [], 'animation': ['audio', 'performance'] }; this.init(); } async init() {  try { // ç­‰å¾…DOMå®Œå…¨åŠ è½½ if (document.readyState !== 'complete') { await new Promise(resolve => { window.addEventListener('load', resolve); }); } // æŒ‰ä¾èµ–é¡ºåºåˆå§‹åŒ–ç³»ç»Ÿ await this.initializeSystems(); // è®¾ç½®ç³»ç»Ÿé—´é€šä¿¡ this.setupInterSystemCommunication(); // å¯åŠ¨å¥åº·ç›‘æ§ this.startHealthMonitoring(); // è®¾ç½®å…¨å±€é”™è¯¯å¤„ç† this.setupErrorHandling(); this.status = 'running'; this.initialized = true;  this.displaySystemStatus(); } catch (error) { console.error('âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error); this.status = 'error'; this.handleInitializationError(error); } } async initializeSystems() { const initOrder = this.calculateInitOrder(); for (const systemName of initOrder) { if (!this.config[`enable${this.capitalizeFirst(systemName)}`]) { console.log(`â­ï¸ è·³è¿‡ç³»ç»Ÿ: ${systemName} (å·²ç¦ç”¨)`); continue; } try { await this.initializeSystem(systemName);  } catch (error) { console.warn(`âš ï¸ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${systemName}`, error); // å¤„ç†ä¾èµ–å¤±è´¥ this.handleSystemFailure(systemName, error); } } } calculateInitOrder() { const order = []; const visited = new Set(); const visiting = new Set(); const dfs = (system) => { if (visiting.has(system)) { throw new Error(`å¾ªç¯ä¾èµ–æ£€æµ‹: ${system}`); } if (visited.has(system)) return; visiting.add(system); const deps = this.systemDependencies[system] || []; deps.forEach(dep => { dfs(dep); }); visiting.delete(system); visited.add(system); order.push(system); }; Object.keys(this.systemDependencies).forEach(system => { dfs(system); }); return order; } async initializeSystem(systemName) { const startTime = performance.now(); switch (systemName) { case 'performance': await this.initPerformanceSystem(); break; case 'audio': await this.initAudioSystem(); break; case 'gestures': await this.initGestureSystem(); break; case 'dataVisualization': await this.initDataVisualizationSystem(); break; case 'social': await this.initSocialSystem(); break; case 'animation': await this.initAnimationSystem(); break; default: throw new Error(`æœªçŸ¥ç³»ç»Ÿ: ${systemName}`); } const initTime = performance.now() - startTime; this.systems.set(systemName, { status: 'running', initTime, lastCheck: Date.now(), errors: [] }); } async initPerformanceSystem() { if (window.performanceMonitor) { this.systems.set('performance', { instance: window.performanceMonitor, status: 'running' }); return; } // ç­‰å¾…æ€§èƒ½ç›‘æ§å™¨åŠ è½½ await this.waitForGlobal('performanceMonitor', 5000); } async initAudioSystem() { if (window.audioEnhancement) { this.systems.set('audio', { instance: window.audioEnhancement, status: 'running' }); return; } await this.waitForGlobal('audioEnhancement', 5000); } async initGestureSystem() { if (window.gestureSystem) { // é›†æˆéŸ³æ•ˆåé¦ˆ const audioSystem = this.systems.get('audio'); if (audioSystem) { window.gestureSystem.onGesture('tap', () => { if (window.audioEnhancement) { window.audioEnhancement.playTypingSound(); } }); window.gestureSystem.onGesture('longPress', () => { if (window.audioEnhancement) { window.audioEnhancement.playAbsorptionSound(); } }); } this.systems.set('gestures', { instance: window.gestureSystem, status: 'running' }); return; } await this.waitForGlobal('gestureSystem', 5000); } async initDataVisualizationSystem() { if (window.dataVisualization) { // é›†æˆæ€§èƒ½ç›‘æ§æ•°æ® const performanceSystem = this.systems.get('performance'); if (performanceSystem) { // è¿æ¥æ•°æ®æº this.connectDataSources(); } this.systems.set('dataVisualization', { instance: window.dataVisualization, status: 'running' }); return; } await this.waitForGlobal('dataVisualization', 5000); } async initSocialSystem() { if (window.socialCustomization) { // é›†æˆå…¶ä»–ç³»ç»Ÿçš„è®¾ç½® this.integrateSocialSettings(); this.systems.set('social', { instance: window.socialCustomization, status: 'running' }); return; } await this.waitForGlobal('socialCustomization', 5000); } async initAnimationSystem() { if (window.cppAnimation) { // é›†æˆæ‰€æœ‰å¢å¼ºåŠŸèƒ½åˆ°åŠ¨ç”»ç³»ç»Ÿ this.integrateAnimationEnhancements(); this.systems.set('animation', { instance: window.cppAnimation, status: 'running' }); return; } await this.waitForGlobal('cppAnimation', 5000); } connectDataSources() { if (!window.dataVisualization || !window.performanceMonitor) return; // è¿æ¥æ€§èƒ½æ•°æ®åˆ°å¯è§†åŒ–ç³»ç»Ÿ const updateVisualization = () => { const stats = window.performanceMonitor.getStats(); if (stats) { window.dataVisualization.processDataUpdate('system.performance', stats); } }; setInterval(updateVisualization, 1000); } integrateSocialSettings() { if (!window.socialCustomization) return; // éŸ³æ•ˆè®¾ç½®é›†æˆ if (window.audioEnhancement) { window.socialCustomization.onGesture = (gestureType, callback) => { if (window.gestureSystem) { window.gestureSystem.onGesture(gestureType, callback); } }; } } integrateAnimationEnhancements() { if (!window.cppAnimation) return; // æ·»åŠ éŸ³æ•ˆæ”¯æŒ if (window.audioEnhancement) { const originalRestart = window.cppAnimation.restart; window.cppAnimation.restart = function() { if (window.audioEnhancement) { window.audioEnhancement.playQuantumSound(); } return originalRestart.call(this); }; } // æ·»åŠ æ‰‹åŠ¿æ”¯æŒ if (window.gestureSystem) { window.gestureSystem.onGesture('doubleTap', () => { window.cppAnimation.triggerSpecialEffect(); }); window.gestureSystem.onGesture('swipe', (gesture) => { if (gesture.direction === 'up') { window.cppAnimation.adjustSpeed(1.2); } else if (gesture.direction === 'down') { window.cppAnimation.adjustSpeed(0.8); } }); } // æ·»åŠ æ•°æ®å¯è§†åŒ–æ”¯æŒ if (window.dataVisualization) { // è¿æ¥åŠ¨ç”»å‚æ•°åˆ°æ•°æ®å¯è§†åŒ– const originalUpdateParameter = window.cppAnimation.updateParameter; window.cppAnimation.updateParameter = function(param, value) { window.dataVisualization.processDataUpdate(`animation.${param}`, value); return originalUpdateParameter.call(this, param, value); }; } } setupInterSystemCommunication() { // åˆ›å»ºäº‹ä»¶æ€»çº¿ this.eventBus = new EventTarget(); // ç³»ç»Ÿé—´æ¶ˆæ¯ä¼ é€’ this.systems.forEach((system, name) => { if (system.instance && system.instance.addEventListener) { system.instance.addEventListener('statusChange', (event) => { this.handleSystemStatusChange(name, event.detail); }); } }); // å…¨å±€äº‹ä»¶ç›‘å¬ this.eventBus.addEventListener('systemEvent', (event) => { this.broadcastSystemEvent(event.detail); }); } startHealthMonitoring() { setInterval(() => { this.performHealthCheck(); }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ // å†…å­˜ç›‘æ§ if ('memory' in performance) { setInterval(() => { this.checkMemoryUsage(); }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥å†…å­˜ } // é”™è¯¯ç‡ç›‘æ§ this.startErrorRateMonitoring(); } performHealthCheck() { this.systems.forEach((system, name) => { try { if (system.instance && system.instance.healthCheck) { const health = system.instance.healthCheck(); if (!health.ok) { console.warn(`âš ï¸ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: ${name}`, health); this.handleSystemHealth(name, health); } } } catch (error) { console.error(`âŒ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¼‚å¸¸: ${name}`, error); this.handleSystemError(name, error); } }); } checkMemoryUsage() { if (!performance.memory) return; const memory = performance.memory; const usage = { used: memory.usedJSHeapSize, total: memory.totalJSHeapSize, limit: memory.jsHeapSizeLimit, percentage: (memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100 }; if (usage.percentage > 80) { console.warn('âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜:', usage); this.triggerMemoryOptimization(); } // é€šçŸ¥æ•°æ®å¯è§†åŒ–ç³»ç»Ÿ if (window.dataVisualization) { window.dataVisualization.processDataUpdate('system.memory', usage); } } triggerMemoryOptimization() { // é€šçŸ¥å„ç³»ç»Ÿè¿›è¡Œå†…å­˜ä¼˜åŒ– this.systems.forEach((system, name) => { if (system.instance && system.instance.optimizeMemory) { try { system.instance.optimizeMemory();  } catch (error) { console.warn(`âš ï¸ ç³»ç»Ÿå†…å­˜ä¼˜åŒ–å¤±è´¥: ${name}`, error); } } }); // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰ if (window.gc) { window.gc(); } } startErrorRateMonitoring() { this.errorCounts = new Map(); window.addEventListener('error', (event) => { this.recordError('javascript', event.error); }); window.addEventListener('unhandledrejection', (event) => { this.recordError('promise', event.reason); }); } recordError(type, error) { const key = `${type}-${Date.now()}`; const count = this.errorCounts.get(type) || 0; this.errorCounts.set(type, count + 1); // å¦‚æœé”™è¯¯ç‡è¿‡é«˜ï¼Œè§¦å‘ç³»ç»Ÿä¿æŠ¤ if (count > 10) { console.error('âŒ é”™è¯¯ç‡è¿‡é«˜ï¼Œå¯åŠ¨ç³»ç»Ÿä¿æŠ¤æ¨¡å¼'); this.enterSafeMode(); } } enterSafeMode() {  // ç¦ç”¨éå…³é”®ç³»ç»Ÿ this.systems.forEach((system, name) => { if (name !== 'animation' && name !== 'performance') { this.disableSystem(name); } }); // é™ä½åŠ¨ç”»è´¨é‡ if (window.cppAnimation) { window.cppAnimation.updateParameter('particleCount', 10); window.cppAnimation.updateParameter('effectIntensity', 0.5); } } setupErrorHandling() { // å…¨å±€é”™è¯¯å¤„ç†å™¨ window.addEventListener('error', (event) => { this.handleGlobalError(event); }); // Promise é”™è¯¯å¤„ç† window.addEventListener('unhandledrejection', (event) => { this.handlePromiseRejection(event); }); } handleGlobalError(event) { console.error('ğŸš¨ å…¨å±€é”™è¯¯æ•è·:', event.error); // è®°å½•é”™è¯¯ä¿¡æ¯ this.logError({ type: 'global', message: event.message, filename: event.filename, lineno: event.lineno, colno: event.colno, error: event.error, timestamp: Date.now() }); } handlePromiseRejection(event) { console.error('ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason); this.logError({ type: 'promise', reason: event.reason, timestamp: Date.now() }); } logError(errorInfo) { // å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨ const errors = this.getStoredErrors(); errors.push(errorInfo); // ä¿ç•™æœ€è¿‘100ä¸ªé”™è¯¯ if (errors.length > 100) { errors.splice(0, errors.length - 100); } localStorage.setItem('alingai-error-log', JSON.stringify(errors)); } getStoredErrors() { try { const stored = localStorage.getItem('alingai-error-log'); return stored ? JSON.parse(stored) : []; } catch { return []; } } // ç³»ç»Ÿæ§åˆ¶æ–¹æ³• enableSystem(systemName) { const system = this.systems.get(systemName); if (system && system.instance) { if (system.instance.enable) { system.instance.enable(); } system.status = 'running';  } } disableSystem(systemName) { const system = this.systems.get(systemName); if (system && system.instance) { if (system.instance.disable) { system.instance.disable(); } system.status = 'disabled';  } } restartSystem(systemName) { this.disableSystem(systemName); setTimeout(() => { this.enableSystem(systemName); }, 1000); } getSystemStatus() { const status = {}; this.systems.forEach((system, name) => { status[name] = { status: system.status, initTime: system.initTime, lastCheck: system.lastCheck, errorCount: system.errors ? system.errors.length : 0 }; }); return status; } displaySystemStatus() { const status = this.getSystemStatus(); console.table(status); // å¦‚æœå¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºçŠ¶æ€é¢æ¿ if (this.config.debugMode) { this.createDebugPanel(); } } createDebugPanel() { const panel = document.createElement('div'); panel.id = 'system-debug-panel'; panel.style.cssText = ` position: fixed; top: 10px; left: 10px; width: 400px; background: rgba(0, 0, 0, 0.9); color: #00ff00; padding: 15px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 10px; z-index: 10001; max-height: 500px; overflow-y: auto; `; const updatePanel = () => { const status = this.getSystemStatus(); let html = '<h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€ç›‘æ§</h3>'; Object.entries(status).forEach(([name, info]) => { const statusColor = info.status === 'running' ? '#00ff00' : info.status === 'error' ? '#ff0000' : '#ffff00'; html += ` <div style="margin: 8px 0; padding: 5px; border-left: 3px solid ${statusColor};"> <strong>${name}:</strong> ${info.status}<br> åˆå§‹åŒ–æ—¶é—´: ${info.initTime ? info.initTime.toFixed(2) + 'ms' : 'N/A'}<br> é”™è¯¯æ•°: ${info.errorCount} </div> `; }); html += `<div style="margin-top: 15px; font-size: 9px;"> æ€»çŠ¶æ€: ${this.status}<br> å†…å­˜ä½¿ç”¨: ${performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) + 'MB' : 'N/A'}<br> è¿è¡Œæ—¶é—´: ${Math.floor((Date.now() - this.startTime) / 1000)}s </div>`; panel.innerHTML = html; }; document.body.appendChild(panel); updatePanel(); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ setInterval(updatePanel, 5000); } // å·¥å…·æ–¹æ³• async waitForGlobal(globalName, timeout = 5000) { return new Promise((resolve, reject) => { const startTime = Date.now(); const checkInterval = setInterval(() => { if (window[globalName]) { clearInterval(checkInterval); resolve(window[globalName]); } else if (Date.now() - startTime > timeout) { clearInterval(checkInterval); reject(new Error(`ç­‰å¾…å…¨å±€å¯¹è±¡è¶…æ—¶: ${globalName}`)); } }, 100); }); } capitalizeFirst(str) { return str.charAt(0).toUpperCase() + str.slice(1); } handleSystemFailure(systemName, error) { console.error(`âŒ ç³»ç»Ÿå¤±è´¥: ${systemName}`, error); const system = this.systems.get(systemName) || { errors: [] }; system.errors.push({ error, timestamp: Date.now() }); system.status = 'error'; this.systems.set(systemName, system); } handleSystemStatusChange(systemName, status) { const system = this.systems.get(systemName); if (system) { system.status = status;  } } broadcastSystemEvent(event) { this.systems.forEach((system, name) => { if (system.instance && system.instance.handleSystemEvent) { try { system.instance.handleSystemEvent(event); } catch (error) { console.warn(`âš ï¸ ç³»ç»Ÿäº‹ä»¶å¤„ç†å¤±è´¥: ${name}`, error); } } }); } handleSystemHealth(systemName, health) { if (health.critical) { this.restartSystem(systemName); } else if (health.warning) { console.warn(`âš ï¸ ç³»ç»Ÿå¥åº·è­¦å‘Š: ${systemName}`, health.message); } } handleSystemError(systemName, error) { this.handleSystemFailure(systemName, error); // å¦‚æœæ˜¯å…³é”®ç³»ç»Ÿï¼Œå°è¯•é‡å¯ if (['animation', 'performance'].includes(systemName)) { setTimeout(() => { this.restartSystem(systemName); }, 2000); } } handleInitializationError(error) { // é™çº§å¯åŠ¨  this.config = { enableAudio: false, enableGestures: false, enableDataVisualization: false, enableSocialFeatures: false, enablePerformanceMonitoring: true, autoOptimize: false, debugMode: true }; // é‡æ–°åˆå§‹åŒ– setTimeout(() => { this.init(); }, 2000); } } // ç­‰å¾…DOMåŠ è½½å®Œæˆååˆå§‹åŒ– document.addEventListener('DOMContentLoaded', () => { window.systemManager = new SystemIntegrationManager(); window.systemManager.startTime = Date.now(); }); // å¯¼å‡ºè°ƒè¯•å‡½æ•°åˆ°å…¨å±€ window.debugAlingAi = { getSystemStatus: () => window.systemManager?.getSystemStatus(), enableDebug: () => { if (window.systemManager) { window.systemManager.config.debugMode = true; window.systemManager.createDebugPanel(); } }, disableDebug: () => { if (window.systemManager) { window.systemManager.config.debugMode = false; const panel = document.getElementById('system-debug-panel'); if (panel) panel.remove(); } }, restartSystem: (name) => window.systemManager?.restartSystem(name), triggerSafeMode: () => window.systemManager?.enterSafeMode(), getErrors: () => window.systemManager?.getStoredErrors() }; 