{% extends "layouts/app.twig" %}

{% set page_title = "用户登录" %}
{% set page_description = "登录您的AlingAi账户，开始智能对话体验" %}
{% set hide_navigation = true %}
{% set login_page = true %}

{% block content %}
<div class="auth-container">
    <!-- 背景动画效果 -->
    <div class="auth-bg">
        <div class="quantum-field auth-quantum"></div>
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
            <div class="shape shape-4"></div>
        </div>
    </div>

    <!-- 主要登录区域 -->
    <div class="auth-main">
        <div class="container-fluid h-100">
            <div class="row h-100 g-0">
                <!-- 左侧品牌展示区 -->
                <div class="col-lg-6 d-none d-lg-flex auth-brand">
                    <div class="brand-content">
                        <div class="brand-logo">
                            <img src="/images/logo-light.svg" alt="AlingAi Logo" class="logo-img">
                            <h1 class="brand-title">AlingAi</h1>
                        </div>
                        <div class="brand-tagline">
                            <h2>智能对话，无限可能</h2>
                            <p>体验下一代AI助手，让智慧为您赋能</p>
                        </div>
                        <div class="brand-features">
                            <div class="feature-item">
                                <i class="bi bi-lightning-charge"></i>
                                <span>极速响应</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-shield-check"></i>
                                <span>安全可靠</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-cpu"></i>
                                <span>智能理解</span>
                            </div>
                            <div class="feature-item">
                                <i class="bi bi-person-check"></i>
                                <span>个性化体验</span>
                            </div>
                        </div>
                        <div class="brand-stats">
                            <div class="stat-item">
                                <div class="stat-number" data-count="100000">0</div>
                                <div class="stat-label">活跃用户</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" data-count="5000000">0</div>
                                <div class="stat-label">对话次数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" data-count="99">0</div>
                                <div class="stat-label">满意度%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧登录表单区 -->
                <div class="col-lg-6 col-12 auth-form-section">
                    <div class="auth-form-container">
                        <!-- 移动端logo -->
                        <div class="mobile-brand d-lg-none">
                            <img src="/images/logo.svg" alt="AlingAi" class="mobile-logo">
                            <h1>AlingAi</h1>
                        </div>

                        <!-- 登录表单 -->
                        <div class="auth-form-wrapper">
                            <div class="auth-header">
                                <h2 class="auth-title">
                                    <i class="bi bi-person-circle me-2"></i>
                                    欢迎回来
                                </h2>
                                <p class="auth-subtitle">请登录您的账户继续使用AlingAi</p>
                            </div>

                            <!-- 社交登录按钮 -->
                            <div class="social-login mb-4">
                                <button class="btn social-btn google-btn" type="button">
                                    <i class="bi bi-google"></i>
                                    <span>使用Google登录</span>
                                </button>
                                <button class="btn social-btn github-btn" type="button">
                                    <i class="bi bi-github"></i>
                                    <span>使用GitHub登录</span>
                                </button>
                            </div>

                            <div class="divider">
                                <span>或使用邮箱登录</span>
                            </div>

                            <!-- 登录表单 -->
                            <form id="loginForm" class="auth-form" novalidate>
                                <div class="form-group">
                                    <label for="login" class="form-label">
                                        <i class="bi bi-person me-1"></i>
                                        用户名或邮箱
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-envelope"></i>
                                        </span>
                                        <input 
                                            type="text" 
                                            class="form-control" 
                                            id="login" 
                                            name="login" 
                                            placeholder="请输入用户名或邮箱"
                                            required
                                            autocomplete="username"
                                            data-validation="required"
                                        >
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="password" class="form-label">
                                        <i class="bi bi-key me-1"></i>
                                        密码
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-lock"></i>
                                        </span>
                                        <input 
                                            type="password" 
                                            class="form-control" 
                                            id="password" 
                                            name="password" 
                                            placeholder="请输入密码"
                                            required
                                            autocomplete="current-password"
                                            data-validation="required|min:6"
                                        >
                                        <button class="btn btn-outline-secondary toggle-password" type="button">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <div class="invalid-feedback"></div>
                                    </div>
                                </div>

                                <div class="form-options">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="remember" name="remember">
                                        <label class="form-check-label" for="remember">
                                            记住我
                                        </label>
                                    </div>
                                    <a href="{{ url_for('auth.forgot') }}" class="forgot-link">
                                        忘记密码？
                                    </a>
                                </div>

                                <button type="submit" class="btn btn-primary auth-submit" id="loginSubmit">
                                    <span class="btn-text">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>
                                        登录
                                    </span>
                                    <span class="btn-loading d-none">
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        登录中...
                                    </span>
                                </button>

                                <!-- 访客模式 -->
                                <button type="button" class="btn btn-outline-secondary auth-guest" id="guestMode">
                                    <i class="bi bi-person-dash me-2"></i>
                                    访客体验
                                </button>
                            </form>

                            <!-- 注册链接 -->
                            <div class="auth-footer">
                                <p class="register-prompt">
                                    还没有账户？
                                    <a href="{{ url_for('auth.register') }}" class="register-link">
                                        立即注册
                                    </a>
                                </p>
                            </div>

                            <!-- 验证码区域 -->
                            <div class="captcha-container d-none" id="captchaContainer">
                                <div class="captcha-wrapper">
                                    <label class="form-label">安全验证</label>
                                    <div class="captcha-image-wrapper">
                                        <img id="captchaImage" src="" alt="验证码" class="captcha-image">
                                        <button type="button" class="btn btn-sm btn-outline-secondary refresh-captcha">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="captcha" 
                                        name="captcha" 
                                        placeholder="请输入验证码"
                                        autocomplete="off"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- 安全提示 -->
                        <div class="security-notice">
                            <div class="notice-content">
                                <i class="bi bi-shield-check text-success me-2"></i>
                                <span>您的信息通过SSL加密传输，安全可靠</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 帮助浮动按钮 -->
    <div class="auth-help">
        <button class="btn btn-floating help-btn" data-bs-toggle="modal" data-bs-target="#helpModal">
            <i class="bi bi-question-circle"></i>
        </button>
    </div>
</div>

<!-- 帮助模态框 -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i>
                    登录帮助
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h6><i class="bi bi-person-check me-2"></i>登录方式</h6>
                    <ul>
                        <li>使用注册时的用户名或邮箱地址</li>
                        <li>支持Google、GitHub第三方登录</li>
                        <li>可选择访客模式快速体验</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h6><i class="bi bi-shield-exclamation me-2"></i>忘记密码？</h6>
                    <p>点击"忘记密码？"链接，输入邮箱地址获取重置链接</p>
                </div>
                <div class="help-section">
                    <h6><i class="bi bi-telephone me-2"></i>需要帮助？</h6>
                    <p>如遇到问题，请联系客服：<a href="mailto:support@alingai.com">support@alingai.com</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* 认证页面样式 */
.auth-container {
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

.auth-bg {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 1;
}

.auth-quantum {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0.3;
}

.floating-shapes {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
}

.floating-shapes .shape {
    position: absolute;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 20s infinite linear;
}

.shape-1 {
    width: 60px;
    height: 60px;
    top: 20%;
    left: 10%;
    animation-delay: 0s;
}

.shape-2 {
    width: 80px;
    height: 80px;
    top: 60%;
    left: 20%;
    animation-delay: 5s;
}

.shape-3 {
    width: 40px;
    height: 40px;
    top: 30%;
    right: 15%;
    animation-delay: 10s;
}

.shape-4 {
    width: 100px;
    height: 100px;
    top: 70%;
    right: 25%;
    animation-delay: 15s;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    25% { transform: translateY(-20px) rotate(90deg); }
    50% { transform: translateY(0px) rotate(180deg); }
    75% { transform: translateY(-20px) rotate(270deg); }
}

.auth-main {
    position: relative;
    z-index: 2;
    min-height: 100vh;
}

/* 品牌展示区 */
.auth-brand {
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(20px);
    color: white;
    padding: 2rem;
    align-items: center;
    justify-content: center;
}

.brand-content {
    max-width: 400px;
    text-align: center;
}

.brand-logo {
    margin-bottom: 2rem;
}

.logo-img {
    width: 80px;
    height: 80px;
    margin-bottom: 1rem;
}

.brand-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    background: linear-gradient(45deg, #fff, #f0f8ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.brand-tagline {
    margin-bottom: 2rem;
}

.brand-tagline h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #f8f9fa;
}

.brand-tagline p {
    color: #e9ecef;
    margin: 0;
}

.brand-features {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
}

.feature-item {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    color: #f8f9fa;
}

.feature-item i {
    margin-right: 0.5rem;
    color: #4dabf7;
}

.brand-stats {
    display: flex;
    justify-content: space-between;
    text-align: center;
}

.stat-item {
    flex: 1;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4dabf7;
}

.stat-label {
    font-size: 0.8rem;
    color: #e9ecef;
}

/* 表单区域 */
.auth-form-section {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.auth-form-container {
    width: 100%;
    max-width: 420px;
}

.mobile-brand {
    text-align: center;
    margin-bottom: 2rem;
}

.mobile-logo {
    width: 60px;
    height: 60px;
    margin-bottom: 1rem;
}

.mobile-brand h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #495057;
    margin: 0;
}

.auth-header {
    text-align: center;
    margin-bottom: 2rem;
}

.auth-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 0.5rem;
}

.auth-subtitle {
    color: #6c757d;
    margin: 0;
    font-size: 0.95rem;
}

/* 社交登录按钮 */
.social-login {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}

.social-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.social-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.google-btn {
    background: #fff;
    color: #db4437;
}

.google-btn:hover {
    background: #db4437;
    color: white;
    border-color: #db4437;
}

.github-btn {
    background: #333;
    color: white;
    border-color: #333;
}

.github-btn:hover {
    background: #24292e;
    border-color: #24292e;
}

.social-btn i {
    margin-right: 0.5rem;
    font-size: 1.1rem;
}

.divider {
    text-align: center;
    margin: 1.5rem 0;
    position: relative;
}

.divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #dee2e6;
}

.divider span {
    background: rgba(255, 255, 255, 0.95);
    padding: 0 1rem;
    color: #6c757d;
    font-size: 0.9rem;
}

/* 表单样式 */
.auth-form .form-group {
    margin-bottom: 1.5rem;
}

.auth-form .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.auth-form .input-group-text {
    background: #f8f9fa;
    border-color: #ced4da;
    color: #6c757d;
}

.auth-form .form-control {
    padding: 0.75rem;
    border-radius: 0 8px 8px 0;
    border-color: #ced4da;
    transition: all 0.3s ease;
}

.auth-form .form-control:focus {
    border-color: #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
}

.toggle-password {
    border-left: none;
    border-radius: 0 8px 8px 0;
    background: #f8f9fa;
}

.form-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.forgot-link {
    color: #4dabf7;
    text-decoration: none;
    font-size: 0.9rem;
}

.forgot-link:hover {
    color: #339af0;
    text-decoration: underline;
}

.auth-submit {
    width: 100%;
    padding: 0.875rem;
    font-size: 1rem;
    font-weight: 500;
    border-radius: 8px;
    background: linear-gradient(45deg, #4dabf7, #339af0);
    border: none;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.auth-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(77, 171, 247, 0.4);
}

.auth-guest {
    width: 100%;
    padding: 0.875rem;
    font-size: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.auth-footer {
    text-align: center;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

.register-prompt {
    margin: 0;
    color: #6c757d;
}

.register-link {
    color: #4dabf7;
    text-decoration: none;
    font-weight: 500;
}

.register-link:hover {
    color: #339af0;
    text-decoration: underline;
}

/* 验证码 */
.captcha-container {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.captcha-image-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.captcha-image {
    height: 40px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.refresh-captcha {
    padding: 0.25rem 0.5rem;
}

/* 安全提示 */
.security-notice {
    margin-top: 1.5rem;
    padding: 0.75rem;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 6px;
    text-align: center;
}

.notice-content {
    font-size: 0.85rem;
    color: #155724;
}

/* 帮助按钮 */
.auth-help {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 1000;
}

.help-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #4dabf7;
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(77, 171, 247, 0.4);
    transition: all 0.3s ease;
}

.help-btn:hover {
    transform: scale(1.1);
    background: #339af0;
}

/* 帮助模态框 */
.help-section {
    margin-bottom: 1.5rem;
}

.help-section:last-child {
    margin-bottom: 0;
}

.help-section h6 {
    color: #495057;
    margin-bottom: 0.5rem;
}

.help-section ul {
    margin: 0;
    padding-left: 1.25rem;
}

.help-section li {
    margin-bottom: 0.25rem;
    color: #6c757d;
}

/* 响应式设计 */
@media (max-width: 991.98px) {
    .auth-form-section {
        min-height: 100vh;
    }
    
    .brand-stats {
        flex-direction: column;
        gap: 1rem;
    }
    
    .social-login {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 575.98px) {
    .auth-form-section {
        padding: 1rem;
    }
    
    .auth-form-container {
        max-width: 100%;
    }
    
    .auth-help {
        bottom: 1rem;
        right: 1rem;
    }
    
    .help-btn {
        width: 45px;
        height: 45px;
    }
}

/* 加载动画 */
.btn-loading .spinner-border {
    width: 1rem;
    height: 1rem;
}

/* 表单验证样式 */
.form-control.is-invalid {
    border-color: #dc3545;
}

.form-control.is-valid {
    border-color: #28a745;
}

.invalid-feedback {
    display: block;
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.25rem;
}

/* 数字计数动画 */
@keyframes countUp {
    from { opacity: 0; }
    to { opacity: 1; }
}

.stat-number {
    animation: countUp 2s ease-out;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 数字计数动画
    function animateCounters() {
        const counters = document.querySelectorAll('[data-count]');
        
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-count'));
            const duration = 2000;
            const step = target / (duration / 16);
            let current = 0;
            
            const timer = setInterval(() => {
                current += step;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                
                if (target >= 1000000) {
                    counter.textContent = (current / 1000000).toFixed(1) + 'M';
                } else if (target >= 1000) {
                    counter.textContent = (current / 1000).toFixed(0) + 'K';
                } else {
                    counter.textContent = Math.round(current);
                }
                
                if (target < 100 && current === target) {
                    counter.textContent = target + '%';
                }
            }, 16);
        });
    }
    
    // 启动计数动画
    setTimeout(animateCounters, 500);
    
    // 密码可见性切换
    document.addEventListener('click', function(e) {
        if (e.target.closest('.toggle-password')) {
            const button = e.target.closest('.toggle-password');
            const input = button.parentElement.querySelector('input');
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
    });
    
    // 表单验证
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm(this)) {
                return;
            }
            
            const submitBtn = document.getElementById('loginSubmit');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            // 显示加载状态
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 存储认证信息
                    if (result.token) {
                        localStorage.setItem('token', result.token);
                        localStorage.setItem('auth_token', result.token);
                    }
                    
                    if (result.user) {
                        localStorage.setItem('user_data', JSON.stringify(result.user));
                    }
                    
                    // 显示成功消息
                    showNotification('登录成功！正在跳转...', 'success');
                    
                    // 跳转到仪表板或返回页面
                    setTimeout(() => {
                        const returnUrl = new URLSearchParams(window.location.search).get('return') || '/dashboard';
                        window.location.href = returnUrl;
                    }, 1000);
                } else {
                    showNotification(result.message || '登录失败，请检查用户名和密码', 'error');
                    
                    // 如果需要验证码，显示验证码
                    if (result.require_captcha) {
                        showCaptcha();
                    }
                }
            } catch (error) {
                console.error('登录错误:', error);
                showNotification('网络错误，请稍后重试', 'error');
            } finally {
                // 恢复按钮状态
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                submitBtn.disabled = false;
            }
        });
    }
    
    // 访客模式
    document.getElementById('guestMode')?.addEventListener('click', function() {
        // 设置访客模式标识
        localStorage.setItem('guest_mode', 'true');
        localStorage.setItem('auth_token', 'guest_token');
        
        showNotification('已进入访客模式', 'info');
        
        setTimeout(() => {
            const returnUrl = new URLSearchParams(window.location.search).get('return') || '/chat';
            window.location.href = returnUrl;
        }, 1000);
    });
    
    // 社交登录
    document.querySelector('.google-btn')?.addEventListener('click', function() {
        window.location.href = '/auth/google';
    });
    
    document.querySelector('.github-btn')?.addEventListener('click', function() {
        window.location.href = '/auth/github';
    });
    
    // 验证码刷新
    document.querySelector('.refresh-captcha')?.addEventListener('click', function() {
        refreshCaptcha();
    });
});

// 表单验证函数
function validateForm(form) {
    const inputs = form.querySelectorAll('[data-validation]');
    let isValid = true;
    
    inputs.forEach(input => {
        const rules = input.getAttribute('data-validation').split('|');
        const value = input.value.trim();
        let fieldValid = true;
        let errorMessage = '';
        
        // 清除之前的验证状态
        input.classList.remove('is-valid', 'is-invalid');
        const feedback = input.parentElement.querySelector('.invalid-feedback');
        if (feedback) feedback.textContent = '';
        
        // 验证规则
        for (const rule of rules) {
            if (rule === 'required' && !value) {
                fieldValid = false;
                errorMessage = '此字段为必填项';
                break;
            }
            
            if (rule.startsWith('min:')) {
                const minLength = parseInt(rule.split(':')[1]);
                if (value.length < minLength) {
                    fieldValid = false;
                    errorMessage = `最少需要${minLength}个字符`;
                    break;
                }
            }
            
            if (rule === 'email' && value && !isValidEmail(value)) {
                fieldValid = false;
                errorMessage = '请输入有效的邮箱地址';
                break;
            }
        }
        
        // 应用验证结果
        if (fieldValid && value) {
            input.classList.add('is-valid');
        } else if (!fieldValid) {
            input.classList.add('is-invalid');
            if (feedback) feedback.textContent = errorMessage;
            isValid = false;
        }
    });
    
    return isValid;
}

// 邮箱验证
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// 显示验证码
function showCaptcha() {
    const captchaContainer = document.getElementById('captchaContainer');
    if (captchaContainer) {
        captchaContainer.classList.remove('d-none');
        refreshCaptcha();
    }
}

// 刷新验证码
function refreshCaptcha() {
    const captchaImage = document.getElementById('captchaImage');
    if (captchaImage) {
        captchaImage.src = `/auth/captcha?t=${Date.now()}`;
    }
}

// 通知系统
function showNotification(message, type = 'info') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible notification-toast`;
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${getNotificationIcon(type)} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // 添加到页面
    const container = document.querySelector('.auth-form-container') || document.body;
    container.insertBefore(notification, container.firstChild);
    
    // 自动删除
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

function getNotificationIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}
</script>
{% endblock %}
