{% extends "layouts/app.twig" %}

{% block title %}AIèŠå¤© - {{ app.name }}{% endblock %}
{% block description %}ä¸AIæ™ºèƒ½åŠ©æ‰‹è¿›è¡Œè‡ªç„¶å¯¹è¯ï¼Œè·å¾—ä¸“ä¸šå›ç­”å’Œå»ºè®®{% endblock %}

{% block styles %}
<link href="{{ asset('css/chat.css') }}" rel="stylesheet">
<link href="{{ asset('css/quantum-chat-animations.css') }}" rel="stylesheet">
<style>
    .chat-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px 10px 0 0;
        margin-bottom: 0;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
    }
    
    .chat-input-area {
        padding: 1rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
        border-top: none;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        animation: messageSlideIn 0.3s ease-out;
    }
    
    .message.user {
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #3498db;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin: 0 10px;
    }
    
    .message.user .message-avatar {
        background: #e74c3c;
    }
    
    .message-content {
        max-width: 70%;
        background: white;
        padding: 12px 16px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .message.user .message-content {
        background: #3498db;
        color: white;
    }
    
    .message-time {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 5px;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        margin: 10px 0;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        margin-left: 10px;
    }
    
    .typing-dots span {
        display: block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3498db;
        margin: 0 2px;
        animation: typingAnimation 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes typingAnimation {
        0%, 60%, 100% {
            transform: scale(1);
            opacity: 0.7;
        }
        30% {
            transform: scale(1.2);
            opacity: 1;
        }
    }
    
    .chat-sidebar {
        background: white;
        border-right: 1px solid #dee2e6;
        height: calc(100vh - 80px);
        overflow-y: auto;
    }
    
    .conversation-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .conversation-item:hover {
        background-color: #f8f9fa;
    }
    
    .conversation-item.active {
        background-color: #e3f2fd;
        border-left: 4px solid #3498db;
    }
    
    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .quick-action {
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    
    .quick-action:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .chat-tools {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .tool-button {
        width: 36px;
        height: 36px;
        border: none;
        border-radius: 50%;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .tool-button:hover {
        background: #3498db;
        color: white;
    }
    
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin: 10px 0;
        display: none;
        transition: all 0.2s;
    }
    
    .file-upload-area.dragover {
        border-color: #3498db;
        background-color: #f0f8ff;
    }
</style>
{% endblock %}

{% block body_class %}chat-page{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- å·¦ä¾§å¯¹è¯åˆ—è¡¨ -->
        <div class="col-md-3 col-lg-2 p-0">
            <div class="chat-sidebar">
                <div class="sidebar-header p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">å¯¹è¯å†å²</h6>
                        <button class="btn btn-sm btn-primary" onclick="createNewConversation()">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="conversations-list" id="conversations-list">
                    <!-- å¯¹è¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="col-md-9 col-lg-10 p-0">
            <div class="chat-container">
                <!-- èŠå¤©å¤´éƒ¨ -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="chat-info">
                            <h5 class="mb-0" id="chat-title">AIåŠ©æ‰‹</h5>
                            <small class="text-white-75" id="chat-status">åœ¨çº¿ - å‡†å¤‡ä¸ºæ‚¨æœåŠ¡</small>
                        </div>
                        <div class="chat-actions">
                            <button class="btn btn-sm btn-outline-light me-2" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="exportChat()" title="å¯¼å‡ºå¯¹è¯">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleSettings()" title="è®¾ç½®">
                                <i class="bi bi-gear"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒº -->
                <div class="chat-messages" id="chat-messages">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="welcome-message text-center py-4">
                        <div class="mb-3">
                            <i class="bi bi-robot" style="font-size: 3rem; color: #3498db;"></i>
                        </div>
                        <h5>æ¬¢è¿ä½¿ç”¨AIæ™ºèƒ½åŠ©æ‰‹ï¼</h5>
                        <p class="text-muted">æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§£ç­”é—®é¢˜ã€å¤„ç†æ–‡æ¡£ã€åˆ†ææ•°æ®ç­‰ã€‚è¯·éšæ—¶å‘æˆ‘æé—®ã€‚</p>
                        
                        <!-- å¿«æ·æ“ä½œ -->
                        <div class="quick-actions">
                            <div class="quick-action" onclick="sendQuickMessage('ä»‹ç»ä¸€ä¸‹ä½ çš„åŠŸèƒ½')">
                                ä»‹ç»åŠŸèƒ½
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘åˆ†æä¸€ä»½æ–‡æ¡£')">
                                æ–‡æ¡£åˆ†æ
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('è§£é‡Šä¸€ä¸ªæŠ€æœ¯æ¦‚å¿µ')">
                                æŠ€æœ¯é—®ç­”
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('å¸®æˆ‘å†™ä¸€æ®µä»£ç ')">
                                ä»£ç ç”Ÿæˆ
                            </div>
                            <div class="quick-action" onclick="sendQuickMessage('æ•°æ®åˆ†æå»ºè®®')">
                                æ•°æ®åˆ†æ
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‰“å­—æŒ‡ç¤ºå™¨ -->
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input-area">
                    <!-- å·¥å…·æ  -->
                    <div class="chat-tools">
                        <button class="tool-button" onclick="toggleFileUpload()" title="ä¸Šä¼ æ–‡ä»¶">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <button class="tool-button" onclick="toggleVoiceInput()" title="è¯­éŸ³è¾“å…¥">
                            <i class="bi bi-mic"></i>
                        </button>
                        <button class="tool-button" onclick="insertEmoji()" title="è¡¨æƒ…">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        <button class="tool-button" onclick="toggleMarkdown()" title="Markdown">
                            <i class="bi bi-markdown"></i>
                        </button>
                    </div>
                    
                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="file-upload-area" id="file-upload-area">
                        <i class="bi bi-cloud-upload text-muted" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-0">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>
                    
                    <!-- è¾“å…¥æ¡† -->
                    <div class="input-group">
                        <textarea class="form-control" id="message-input" 
                                placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (Shift + Enter æ¢è¡Œï¼ŒEnter å‘é€)"
                                rows="1" style="resize: none;"></textarea>
                        <button class="btn btn-primary" type="button" onclick="sendMessage()" id="send-button">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div class="chat-status mt-2">
                        <small class="text-muted">
                            <span id="char-count">0</span>/2000 å­—ç¬¦
                            <span class="mx-2">|</span>
                            <span id="connection-status">å·²è¿æ¥</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è®¾ç½®é¢æ¿ -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">èŠå¤©è®¾ç½®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">AIæ¨¡å‹</label>
                    <select class="form-select" id="ai-model">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (å¿«é€Ÿ)</option>
                        <option value="gpt-4">GPT-4 (é«˜è´¨é‡)</option>
                        <option value="claude">Claude (åˆ›æ„)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">æ¸©åº¦è®¾ç½®</label>
                    <input type="range" class="form-range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                    <small class="text-muted">æ•°å€¼è¶Šé«˜å›ç­”è¶Šåˆ›æ„ï¼Œè¶Šä½è¶Šç²¾ç¡®</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">æœ€å¤§å›å¤é•¿åº¦</label>
                    <select class="form-select" id="max-tokens">
                        <option value="500">çŸ­å›å¤ (500)</option>
                        <option value="1000" selected>ä¸­ç­‰å›å¤ (1000)</option>
                        <option value="2000">é•¿å›å¤ (2000)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enable-memory">
                        <label class="form-check-label">å¯ç”¨ä¸Šä¸‹æ–‡è®°å¿†</label>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enable-typing-indicator" checked>
                        <label class="form-check-label">æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ asset('js/chat/chat-core-classes.js') }}"></script>

<script>
class ChatInterface {
    constructor() {
        this.currentConversationId = null;
        this.messages = [];
        this.isTyping = false;
        this.settings = {
            model: 'gpt-3.5-turbo',
            temperature: 0.7,
            maxTokens: 1000,
            enableMemory: true,
            enableTypingIndicator: true
        };
        
        this.init();
    }
    
    init() {
        this.initializeElements();
        this.bindEvents();
        this.loadConversations();
        this.loadSettings();
        this.setupWebSocket();
    }
    
    initializeElements() {
        this.messageInput = document.getElementById('message-input');
        this.sendButton = document.getElementById('send-button');
        this.messagesContainer = document.getElementById('chat-messages');
        this.typingIndicator = document.getElementById('typing-indicator');
        this.conversationsList = document.getElementById('conversations-list');
        this.fileInput = document.getElementById('file-input');
        this.fileUploadArea = document.getElementById('file-upload-area');
    }
    
    bindEvents() {
        // å‘é€æ¶ˆæ¯äº‹ä»¶
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
            this.updateCharCount();
        });
        
        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
        this.fileUploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        this.fileUploadArea.addEventListener('drop', (e) => this.handleDrop(e));
        
        // è¾“å…¥å­—ç¬¦è®¡æ•°
        this.messageInput.addEventListener('input', () => this.updateCharCount());
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        this.messageInput.addEventListener('input', () => this.autoResizeTextarea());
    }
    
    async sendMessage(content = null) {
        const message = content || this.messageInput.value.trim();
        if (!message && !content) return;
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        this.addMessage(message, 'user');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        if (!content) {
            this.messageInput.value = '';
            this.updateCharCount();
        }
        
        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        this.showTypingIndicator();
        
        try {
            const response = await fetch('{{ url("api/chat/send") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': window.APP_CONFIG.csrfToken
                },
                body: JSON.stringify({
                    message: message,
                    conversation_id: this.currentConversationId,
                    settings: this.settings
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
                this.hideTypingIndicator();
                
                // æ˜¾ç¤ºAIå›å¤
                this.addMessage(data.data.response, 'assistant');
                
                // æ›´æ–°å¯¹è¯ID
                if (data.data.conversation_id) {
                    this.currentConversationId = data.data.conversation_id;
                    this.updateConversationsList();
                }
            } else {
                this.hideTypingIndicator();
                this.addMessage('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„æ¶ˆæ¯æ—¶å‡ºç°é”™è¯¯ï¼š' + data.message, 'error');
            }
        } catch (error) {
            this.hideTypingIndicator();
            this.addMessage('ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚', 'error');
            console.error('Send message error:', error);
        }
    }
    
    addMessage(content, type, timestamp = null) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        
        const avatarEl = document.createElement('div');
        avatarEl.className = 'message-avatar';
        avatarEl.textContent = type === 'user' ? (window.APP_CONFIG.user?.username?.charAt(0) || 'U') : 'AI';
        
        const contentEl = document.createElement('div');
        contentEl.className = 'message-content';
        
        if (type === 'error') {
            contentEl.innerHTML = `<div class="text-danger">${content}</div>`;
        } else {
            contentEl.innerHTML = this.formatMessage(content);
        }
        
        if (timestamp || type !== 'error') {
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = timestamp || new Date().toLocaleTimeString();
            contentEl.appendChild(timeEl);
        }
        
        messageEl.appendChild(avatarEl);
        messageEl.appendChild(contentEl);
        
        // æ’å…¥åˆ°æ¬¢è¿æ¶ˆæ¯ä¹‹åï¼Œæ‰“å­—æŒ‡ç¤ºå™¨ä¹‹å‰
        const welcomeMessage = this.messagesContainer.querySelector('.welcome-message');
        if (welcomeMessage && this.messages.length === 0) {
            welcomeMessage.style.display = 'none';
        }
        
        this.messagesContainer.insertBefore(messageEl, this.typingIndicator);
        this.scrollToBottom();
        
        // ä¿å­˜åˆ°æ¶ˆæ¯æ•°ç»„
        this.messages.push({
            content,
            type,
            timestamp: timestamp || new Date().toISOString()
        });
    }
    
    formatMessage(content) {
        // æ”¯æŒ Markdown åŸºæœ¬æ ¼å¼
        let formatted = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
        
        // ä»£ç å—å¤„ç†
        formatted = formatted.replace(/```(\w*)\n([\s\S]*?)```/g, 
            '<pre><code class="language-$1">$2</code></pre>');
        
        return formatted;
    }
    
    showTypingIndicator() {
        if (this.settings.enableTypingIndicator) {
            this.typingIndicator.style.display = 'flex';
            this.scrollToBottom();
        }
    }
    
    hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
    }
    
    scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }
    
    updateCharCount() {
        const count = this.messageInput.value.length;
        document.getElementById('char-count').textContent = count;
        
        if (count > 2000) {
            document.getElementById('char-count').style.color = '#dc3545';
        } else {
            document.getElementById('char-count').style.color = '';
        }
    }
    
    autoResizeTextarea() {
        this.messageInput.style.height = 'auto';
        this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
    }
    
    async loadConversations() {
        try {
            const response = await fetch('{{ url("api/conversations") }}', {
                headers: {
                    'X-CSRF-Token': window.APP_CONFIG.csrfToken
                }
            });
            
            const data = await response.json();
            if (data.success) {
                this.renderConversations(data.data);
            }
        } catch (error) {
            console.error('Load conversations error:', error);
        }
    }
    
    renderConversations(conversations) {
        this.conversationsList.innerHTML = '';
        
        conversations.forEach(conv => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.onclick = () => this.loadConversation(conv.id);
            
            item.innerHTML = `
                <div class="conversation-title">${conv.title || 'æ–°å¯¹è¯'}</div>
                <div class="conversation-preview text-muted">${conv.last_message || ''}</div>
                <div class="conversation-time text-muted">${this.formatTime(conv.updated_at)}</div>
            `;
            
            this.conversationsList.appendChild(item);
        });
    }
    
    async loadConversation(conversationId) {
        try {
            const response = await fetch(`{{ url("api/conversations") }}/${conversationId}`, {
                headers: {
                    'X-CSRF-Token': window.APP_CONFIG.csrfToken
                }
            });
            
            const data = await response.json();
            if (data.success) {
                this.currentConversationId = conversationId;
                this.messages = data.data.messages || [];
                this.renderMessages();
                this.updateActiveConversation(conversationId);
            }
        } catch (error) {
            console.error('Load conversation error:', error);
        }
    }
    
    renderMessages() {
        // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯å’Œæ‰“å­—æŒ‡ç¤ºå™¨ï¼‰
        const messages = this.messagesContainer.querySelectorAll('.message');
        messages.forEach(msg => msg.remove());
        
        // æ¸²æŸ“å†å²æ¶ˆæ¯
        this.messages.forEach(msg => {
            this.addMessage(msg.content, msg.type, this.formatTime(msg.timestamp));
        });
    }
    
    updateActiveConversation(conversationId) {
        const items = this.conversationsList.querySelectorAll('.conversation-item');
        items.forEach(item => item.classList.remove('active'));
        
        // æ‰¾åˆ°å¹¶æ¿€æ´»å½“å‰å¯¹è¯
        const activeItem = Array.from(items).find(item => 
            item.onclick.toString().includes(conversationId));
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }
    
    formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'åˆšåˆš';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
        if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
        
        return date.toLocaleDateString();
    }
    
    loadSettings() {
        const saved = localStorage.getItem('chatSettings');
        if (saved) {
            this.settings = { ...this.settings, ...JSON.parse(saved) };
            this.applySettings();
        }
    }
    
    saveSettings() {
        // ä»è®¾ç½®é¢æ¿è·å–å€¼
        this.settings.model = document.getElementById('ai-model').value;
        this.settings.temperature = parseFloat(document.getElementById('temperature').value);
        this.settings.maxTokens = parseInt(document.getElementById('max-tokens').value);
        this.settings.enableMemory = document.getElementById('enable-memory').checked;
        this.settings.enableTypingIndicator = document.getElementById('enable-typing-indicator').checked;
        
        localStorage.setItem('chatSettings', JSON.stringify(this.settings));
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        modal.hide();
        
        showSuccess('è®¾ç½®å·²ä¿å­˜');
    }
    
    applySettings() {
        if (document.getElementById('ai-model')) {
            document.getElementById('ai-model').value = this.settings.model;
            document.getElementById('temperature').value = this.settings.temperature;
            document.getElementById('max-tokens').value = this.settings.maxTokens;
            document.getElementById('enable-memory').checked = this.settings.enableMemory;
            document.getElementById('enable-typing-indicator').checked = this.settings.enableTypingIndicator;
        }
    }
    
    setupWebSocket() {
        // WebSocket è¿æ¥ç”¨äºå®æ—¶é€šçŸ¥
        if (window.WebSocket) {
            try {
                this.websocket = new WebSocket(`ws://${window.location.host}/ws/chat`);
                
                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('connection-status').textContent = 'å·²è¿æ¥';
                };
                
                this.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    document.getElementById('connection-status').textContent = 'è¿æ¥ä¸­æ–­';
                };
                
                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'chat_response') {
                        this.hideTypingIndicator();
                        this.addMessage(data.message, 'assistant');
                    }
                };
            } catch (error) {
                console.error('WebSocket connection failed:', error);
            }
        }
    }
}

// å…¨å±€å‡½æ•°
function sendQuickMessage(message) {
    window.chatInterface.sendMessage(message);
}

function createNewConversation() {
    window.chatInterface.currentConversationId = null;
    window.chatInterface.messages = [];
    window.chatInterface.renderMessages();
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    const welcomeMessage = document.querySelector('.welcome-message');
    if (welcomeMessage) {
        welcomeMessage.style.display = 'block';
    }
    
    // æ¸…é™¤æ´»åŠ¨çŠ¶æ€
    const items = document.querySelectorAll('.conversation-item');
    items.forEach(item => item.classList.remove('active'));
}

function clearChat() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
        window.chatInterface.messages = [];
        window.chatInterface.renderMessages();
        
        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.style.display = 'block';
        }
    }
}

function exportChat() {
    const messages = window.chatInterface.messages;
    if (messages.length === 0) {
        showWarning('æ²¡æœ‰å¯å¯¼å‡ºçš„æ¶ˆæ¯');
        return;
    }
    
    let content = `èŠå¤©è®°å½•å¯¼å‡º - ${new Date().toLocaleString()}\n\n`;
    messages.forEach(msg => {
        const type = msg.type === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';
        content += `[${type}] ${msg.content}\n\n`;
    });
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-export-${Date.now()}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function toggleSettings() {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    window.chatInterface.applySettings();
    modal.show();
}

function toggleFileUpload() {
    const area = document.getElementById('file-upload-area');
    area.style.display = area.style.display === 'none' ? 'block' : 'none';
}

function toggleVoiceInput() {
    // è¯­éŸ³è¾“å…¥åŠŸèƒ½
    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onresult = function(event) {
            const result = event.results[0][0].transcript;
            document.getElementById('message-input').value = result;
            showSuccess('è¯­éŸ³è¯†åˆ«å®Œæˆ');
        };
        
        recognition.onerror = function(event) {
            showError('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼š' + event.error);
        };
        
        recognition.start();
        showInfo('å¼€å§‹è¯­éŸ³è¯†åˆ«...');
    } else {
        showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
    }
}

function insertEmoji() {
    // ç®€å•çš„è¡¨æƒ…æ’å…¥
    const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¤”', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ’¡', 'ğŸš€'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    const input = document.getElementById('message-input');
    input.value += emoji;
    input.focus();
}

function toggleMarkdown() {
    showInfo('Markdown æ ¼å¼æ”¯æŒï¼š**ç²—ä½“** *æ–œä½“* `ä»£ç ` ```ä»£ç å—```');
}

// åˆå§‹åŒ–èŠå¤©ç•Œé¢
document.addEventListener('DOMContentLoaded', function() {
    window.chatInterface = new ChatInterface();
});
</script>
{% endblock %}

{% block ready_script %}
// é¡µé¢å‡†å¤‡å®Œæˆåçš„åˆå§‹åŒ–
console.log('Chat page ready');

// æ£€æŸ¥æ˜¯å¦æœ‰æœªè¯»æ¶ˆæ¯
{% if auth_check() %}
    fetch('{{ url("api/notifications/unread") }}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.chat_messages > 0) {
                showInfo(`æ‚¨æœ‰ ${data.data.chat_messages} æ¡æœªè¯»æ¶ˆæ¯`);
            }
        });
{% endif %}

// è®¾ç½®é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // é¡µé¢éšè—æ—¶æš‚åœæŸäº›åŠŸèƒ½
        console.log('Chat page hidden');
    } else {
        // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤åŠŸèƒ½
        console.log('Chat page visible');
        if (window.chatInterface) {
            window.chatInterface.loadConversations();
        }
    }
});
{% endblock %}
